<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV M√°gico ‚ú® Pro | Sistema Profissional</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ----- CSS reset, vari√°veis e estilos globais (extra√≠dos do Index.html) ----- */
        :root {
            --bg-color: #e0e5ec;
            --glass: rgba(255,255,255,0.85);
            --primary: #6c5ce7;
            --primary-light: #8579ec;
            --primary-dark: #5649c0;
            --secondary: #00cec9;
            --accent: #fd79a8;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #ff7675;
            --info: #0984e3;
            --whatsapp: #25D366;
            --text: #2d3436;
            --text-light: #636e72;
            --shadow: 0 20px 40px rgba(31,38,135,0.15);
            --shadow-light: 0 10px 20px rgba(31,38,135,0.1);
            --border: 1px solid rgba(255,255,255,0.25);
            --border-radius: 24px;
            --transition: all 0.3s cubic-bezier(0.175,0.885,0.32,1.275);
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Nunito',sans-serif; }
        body {
            background: linear-gradient(135deg,#a8edea 0%,#fed6e3 100%);
            min-height:100vh; display:flex; padding:20px;
            color:var(--text); overflow-x:hidden; position:relative;
        }

        /* part√≠culas m√°gicas */
        .magic-particle {
            position:fixed;
            border-radius:50%;
            pointer-events:none;
            opacity:0;
            z-index:0;
            animation:particleFloat linear infinite;
        }
        @keyframes particleFloat {
            0%   { transform:translateY(100vh) rotate(0deg); opacity:0; }
            10%  { opacity:0.7; }
            90%  { opacity:0.4; }
            100% { transform:translateY(-100px) rotate(720deg); opacity:0; }
        }

        /* auth */
        .auth-container { display:flex; justify-content:center; align-items:center; width:100%; min-height:100vh; padding:20px; z-index:10; position:relative; }
        .auth-card { background:var(--glass); backdrop-filter:blur(20px); border-radius:var(--border-radius); box-shadow:var(--shadow); border:var(--border); padding:40px; width:100%; max-width:520px; animation:fadeIn .5s ease; }
        .auth-header { text-align:center; margin-bottom:30px; }
        .auth-logo { font-size:2.5rem; margin-bottom:15px; color:var(--primary); }
        .auth-title { font-size:2rem; font-weight:900; color:var(--primary); margin-bottom:10px; }
        .auth-subtitle { color:var(--text-light); margin-bottom:25px; }
        .auth-form { display:flex; flex-direction:column; gap:20px; }
        .form-group { display:flex; flex-direction:column; gap:8px; }
        .form-label { font-weight:700; color:var(--text); font-size:.9rem; }
        .form-input { padding:16px 20px; border-radius:16px; border:2px solid #dfe6e9; font-size:1rem; outline:none; background:rgba(255,255,255,.9); transition:var(--transition); }
        .form-input:focus { border-color:var(--primary); box-shadow:0 0 0 4px rgba(108,92,231,.2); transform:translateY(-2px); }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
        .auth-btn { background:linear-gradient(90deg,var(--primary),var(--primary-light)); color:white; border:none; padding:18px; border-radius:18px; font-weight:900; font-size:1.1rem; cursor:pointer; transition:var(--transition); margin-top:10px; display:flex; align-items:center; justify-content:center; gap:10px; }
        .auth-btn:hover { transform:translateY(-5px); box-shadow:0 15px 30px rgba(108,92,231,.4); }
        .auth-btn:disabled { opacity:.6; cursor:not-allowed; transform:none !important; }
        .auth-switch { text-align:center; margin-top:25px; color:var(--text-light); }
        .auth-switch a { color:var(--primary); text-decoration:none; font-weight:700; cursor:pointer; }
        .auth-switch a:hover { text-decoration:underline; }
        .plan-card { background:white; border-radius:20px; padding:25px; margin-top:20px; border:3px solid var(--primary); text-align:center; position:relative; overflow:hidden; }
        .plan-badge { position:absolute; top:15px; right:-30px; background:var(--success); color:white; padding:5px 30px; transform:rotate(45deg); font-size:.8rem; font-weight:700; }
        .plan-price { font-size:2.5rem; font-weight:900; color:var(--primary); margin:10px 0; }
        .plan-period { font-size:1rem; color:var(--text-light); }
        .plan-features { list-style:none; margin:20px 0; text-align:left; }
        .plan-features li { padding:8px 0; display:flex; align-items:center; gap:10px; }
        .plan-features li i { color:var(--success); }
        .terms-checkbox { display:flex; align-items:flex-start; gap:10px; margin:15px 0; font-size:.9rem; }
        .terms-checkbox input { margin-top:3px; }
        .terms-checkbox a { color:var(--primary); text-decoration:none; }
        .error-msg { color:var(--danger); font-size:.88rem; font-weight:700; margin-top:-10px; padding:10px 15px; background:rgba(255,118,117,.1); border-radius:12px; border-left:4px solid var(--danger); display:none; }
        .error-msg.show { display:block; }

        /* app container */
        .app-container { display:none; grid-template-columns:80px 1fr; width:100%; height:calc(100vh - 40px); background:var(--glass); backdrop-filter:blur(20px); border-radius:var(--border-radius); box-shadow:var(--shadow); border:var(--border); overflow:hidden; z-index:10; position:relative; }
        .sidebar { display:flex; flex-direction:column; align-items:center; padding-top:30px; background:rgba(255,255,255,.3); border-right:var(--border); position:relative; overflow:hidden; }
        .sidebar::before { content:''; position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(180deg,rgba(255,255,255,.6) 0%,rgba(255,255,255,.2) 100%); z-index:-1; }
        .nav-btn { width:56px; height:56px; border-radius:18px; border:none; background:transparent; font-size:1.5rem; margin-bottom:15px; cursor:pointer; transition:var(--transition); color:#b2bec3; display:flex; align-items:center; justify-content:center; position:relative; transform:scale(1); }
        .nav-btn:hover { transform:translateY(-5px) scale(1.05); background:#fff; box-shadow:0 10px 20px rgba(108,92,231,.2); }
        .nav-btn.active { background:var(--primary); color:#fff; box-shadow:0 10px 20px -5px rgba(108,92,231,.4); transform:scale(1.05); }
        .nav-btn.pop { animation:navBtnPop .35s ease forwards; }
        @keyframes navBtnPop { 0%{transform:scale(1)} 40%{transform:scale(1.25)} 70%{transform:scale(.95)} 100%{transform:scale(1.05)} }
        .nav-notification { position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; font-size:.7rem; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; font-weight:800; }
        .content-area { padding:30px; overflow-y:auto; position:relative; background:linear-gradient(135deg,rgba(255,255,255,.9) 0%,rgba(248,248,255,.8) 100%); }
        .section { display:none; height:100%; animation:fadeIn .5s ease; }
        .section.active { display:block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        @keyframes zoomIn { from{transform:scale(.7);opacity:0} to{transform:scale(1);opacity:1} }
        @keyframes spin { to{transform:rotate(360deg)} }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

        h2 { font-weight:900; font-size:2.2rem; margin-bottom:20px; color:var(--primary); display:flex; align-items:center; gap:15px; position:relative; }
        h2::after { content:''; position:absolute; bottom:-8px; left:0; width:60px; height:4px; background:linear-gradient(90deg,var(--primary),var(--secondary)); border-radius:2px; }

        /* PDV */
        .pdv-header { display:flex; gap:15px; margin-bottom:25px; flex-wrap:wrap; }
        .scan-input { flex:1; min-width:300px; padding:18px 20px; border-radius:18px; border:2px solid var(--primary); font-size:1.1rem; outline:none; background:rgba(255,255,255,.9); transition:var(--transition); box-shadow:0 5px 15px rgba(0,0,0,.05); }
        .scan-input:focus { border-color:var(--secondary); box-shadow:0 0 0 4px rgba(0,206,201,.2); transform:translateY(-2px); }
        .quick-actions { display:flex; gap:10px; }
        .quick-action-btn { padding:12px 20px; background:white; border:2px solid #dfe6e9; border-radius:15px; font-weight:700; cursor:pointer; transition:var(--transition); display:flex; align-items:center; gap:8px; }
        .quick-action-btn:hover { background:var(--primary); color:white; border-color:var(--primary); transform:translateY(-3px); }
        .pdv-grid { display:grid; grid-template-columns:2fr 1fr; gap:25px; height:calc(100% - 180px); }
        .product-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:20px; align-content:start; overflow-y:auto; padding-right:10px; max-height:calc(100vh - 280px); }
        .product-card { background:white; border-radius:22px; padding:20px; text-align:center; cursor:pointer; transition:var(--transition); border:2px solid transparent; box-shadow:var(--shadow-light); position:relative; overflow:hidden; display:flex; flex-direction:column; justify-content:space-between; }
        .product-card::before { content:''; position:absolute; top:0; left:0; width:100%; height:6px; background:linear-gradient(90deg,var(--primary),var(--secondary)); opacity:0; transition:opacity .3s; }
        .product-card:hover { transform:translateY(-10px) scale(1.03); border-color:var(--secondary); box-shadow:0 20px 40px rgba(0,206,201,.2); }
        .product-card:hover::before { opacity:1; }
        .product-emoji { font-size:3.5rem; margin-bottom:15px; display:block; transition:transform .3s; }
        .product-card:hover .product-emoji { transform:scale(1.2) rotate(5deg); }
        .product-name { font-weight:800; font-size:1rem; margin-bottom:8px; color:var(--text); }
        .product-price { color:var(--primary); font-weight:900; font-size:1.3rem; margin-bottom:5px; }
        .product-stock { position:absolute; top:10px; right:10px; font-size:.75rem; background:#dfe6e9; padding:4px 10px; border-radius:12px; font-weight:700; }
        .stock-low { background:var(--danger); color:white; }
        .stock-medium { background:var(--warning); color:var(--text); }
        .stock-high { background:var(--success); color:white; }
        .product-category { font-size:.75rem; color:var(--text-light); background:#f8f9fa; padding:3px 10px; border-radius:10px; margin-top:5px; display:inline-block; }

        /* carrinho */
        .cart-panel { background:white; border-radius:28px; padding:25px; display:flex; flex-direction:column; box-shadow:var(--shadow-light); height:100%; }
        .cart-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .clear-cart { background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:12px; font-size:.85rem; cursor:pointer; transition:var(--transition); display:flex; align-items:center; gap:5px; }
        .clear-cart:hover { background:#ff5252; transform:translateY(-2px); }
        .cart-items { flex:1; overflow-y:auto; margin:15px 0; padding-right:5px; max-height:300px; }
        .cart-item { display:flex; justify-content:space-between; align-items:center; background:#f8f9fa; margin-bottom:12px; padding:15px; border-radius:16px; font-size:.95rem; transition:var(--transition); border-left:4px solid var(--primary); }
        .cart-item:hover { background:#f1f3ff; transform:translateX(5px); }
        .cart-item-info { flex:1; }
        .cart-item-name { font-weight:700; margin-bottom:5px; }
        .cart-item-qty { display:flex; align-items:center; gap:10px; margin-top:8px; }
        .qty-btn { width:28px; height:28px; border-radius:8px; border:1px solid #dfe6e9; background:white; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:bold; transition:var(--transition); }
        .qty-btn:hover { background:var(--primary); color:white; border-color:var(--primary); }
        .remove-btn { color:var(--danger); cursor:pointer; padding:8px; border-radius:10px; transition:var(--transition); }
        .remove-btn:hover { background:var(--danger); color:white; transform:rotate(90deg); }
        .cart-footer { border-top:2px dashed #dfe6e9; padding-top:20px; }
        .cart-total { font-size:1.8rem; font-weight:900; text-align:right; margin-bottom:20px; color:var(--primary); display:flex; justify-content:space-between; align-items:center; }
        .cart-total-label { font-size:1.2rem; color:var(--text-light); }
        .btn-checkout { background:linear-gradient(90deg,var(--primary),var(--primary-light)); color:white; border:none; padding:18px; border-radius:18px; font-weight:900; font-size:1.2rem; cursor:pointer; width:100%; transition:var(--transition); box-shadow:0 10px 20px rgba(108,92,231,.3); display:flex; align-items:center; justify-content:center; gap:10px; }
        .btn-checkout:hover { transform:translateY(-5px); box-shadow:0 15px 30px rgba(108,92,231,.4); }
        .btn-checkout:disabled { background:#b2bec3; cursor:not-allowed; box-shadow:none; transform:none; }

        /* modais */
        .modal-overlay { 
            position:fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background:rgba(0,0,0,.7); 
            backdrop-filter:blur(10px); 
            z-index:999999; 
            display:none; 
            justify-content:center; 
            align-items:center; 
            animation:fadeIn .3s ease; 
        }
        .modal-content { 
            background:white; 
            padding:30px; 
            border-radius:32px; 
            width:500px; 
            max-width:90%; 
            text-align:center; 
            animation:zoomIn .4s cubic-bezier(.175,.885,.32,1.275); 
            box-shadow:0 30px 60px rgba(0,0,0,.2); 
            border:var(--border); 
            max-height:90vh; 
            overflow-y:auto;
            position:relative;
            z-index:1000000;
        }
        .payment-options { 
            display:grid; 
            grid-template-columns:1fr 1fr;
            gap:10px; 
            margin:20px 0; 
        }
        .receipt-options { 
            display:grid; 
            gap:10px; 
            margin:20px 0; 
        }
        .btn-pay, .btn-receipt { 
            padding:15px; 
            border:2px solid #dfe6e9; 
            background:white; 
            border-radius:16px; 
            font-size:1rem; 
            font-weight:bold; 
            cursor:pointer; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            gap:8px; 
            transition:var(--transition); 
        }
        .btn-pay:hover { 
            transform:translateY(-3px); 
            border-color:var(--primary); 
            background:#f8f9fa; 
            color:var(--primary); 
            box-shadow:0 8px 15px rgba(0,0,0,.1); 
        }
        .btn-whatsapp { color:var(--whatsapp); border-color:var(--whatsapp); }
        .btn-whatsapp:hover { background:var(--whatsapp); color:white; border-color:var(--whatsapp); }
        .btn-email { color:var(--info); border-color:var(--info); }
        .btn-email:hover { background:var(--info); color:white; border-color:var(--info); }

        /* estoque/dashboard */
        .table-container { background:white; padding:25px; border-radius:24px; overflow:hidden; box-shadow:var(--shadow-light); }
        table { width:100%; border-collapse:collapse; }
        th,td { padding:15px; text-align:left; border-bottom:1px solid #f1f2f6; }
        th { color:var(--primary); font-weight:800; background:#f8f9ff; }
        tr:hover { background:#f8f9fa; }
        .form-add { display:flex; gap:10px; margin-bottom:25px; flex-wrap:wrap; }
        input, select { padding:14px; border-radius:14px; border:2px solid #dfe6e9; flex:1; min-width:150px; transition:var(--transition); font-size:1rem; }
        input:focus, select:focus { border-color:var(--primary); outline:none; box-shadow:0 0 0 3px rgba(108,92,231,.1); }
        .dashboard-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:25px; margin-bottom:30px; }
        .card-metric { background:white; padding:25px; border-radius:24px; display:flex; align-items:center; gap:20px; box-shadow:var(--shadow-light); transition:var(--transition); position:relative; overflow:hidden; }
        .card-metric:hover { transform:translateY(-10px); box-shadow:0 20px 40px rgba(0,0,0,.1); }
        .card-metric::before { content:''; position:absolute; top:0; left:0; width:8px; height:100%; background:linear-gradient(180deg,var(--primary),var(--secondary)); }
        .metric-icon { font-size:2.8rem; background:linear-gradient(135deg,var(--primary),var(--secondary)); width:70px; height:70px; display:flex; align-items:center; justify-content:center; border-radius:50%; color:white; }
        .metric-info p { color:var(--text-light); font-size:.9rem; margin-bottom:5px; }
        .metric-info h3 { font-size:2rem; color:var(--text); }
        .chart-container { background:white; padding:25px; border-radius:24px; margin-bottom:30px; box-shadow:var(--shadow-light); }
        .chart-bars { display:flex; justify-content:space-around; align-items:flex-end; height:200px; padding:0 20px; }
        .chart-bar-wrap { display:flex; flex-direction:column; align-items:center; gap:8px; }
        .chart-bar { width:30px; background:linear-gradient(0deg,var(--primary),var(--secondary)); border-radius:5px 5px 0 0; transition:height .6s ease; }
        .chart-label { font-size:.8rem; color:var(--text-light); font-weight:700; }

        /* misc */
        .toast { position:fixed; bottom:30px; right:30px; color:white; padding:20px 30px; border-radius:18px; box-shadow:0 20px 40px rgba(0,0,0,.2); transform:translateX(400px); transition:transform .4s cubic-bezier(.175,.885,.32,1.275); font-weight:700; z-index:1000001; display:flex; align-items:center; gap:15px; max-width:350px; }
        .toast.show { transform:translateX(0); }
        .toast.success { background:var(--success); }
        .toast.warning { background:var(--warning); color:var(--text); }
        .toast.error { background:var(--danger); }
        .toast.info { background:var(--info); }
        .toast-icon { font-size:1.3rem; }
        .low-stock-badge { position:fixed; bottom:30px; left:30px; background:var(--danger); color:white; padding:15px 25px; border-radius:16px; display:flex; align-items:center; gap:12px; cursor:pointer; z-index:100; box-shadow:0 10px 20px rgba(255,118,117,.3); transition:var(--transition); }
        .low-stock-badge:hover { transform:translateY(-5px); }
        .loader { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,.9); z-index:1000002; justify-content:center; align-items:center; flex-direction:column; gap:20px; }
        .loader-spinner { width:60px; height:60px; border:6px solid #dfe6e9; border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
        .suggestions-box { position:absolute; background:white; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,.15); z-index:1000; max-height:300px; overflow-y:auto; display:none; width:100%; margin-top:5px; }
        .suggestion-item { padding:15px; cursor:pointer; border-bottom:1px solid #f1f2f6; display:flex; align-items:center; gap:15px; transition:var(--transition); }
        .suggestion-item:hover { background:#f8f9ff; }
        .suggestion-item.active-suggestion { background:#f0edff; border-left:3px solid var(--primary); }
        .live-stats { display:flex; gap:15px; margin-bottom:25px; flex-wrap:wrap; }
        .stat-badge { background:white; padding:12px 20px; border-radius:16px; display:flex; align-items:center; gap:10px; box-shadow:var(--shadow-light); font-weight:700; }
        .stat-badge i { color:var(--primary); font-size:1.2rem; }
        .stat-badge.timer-badge { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; }
        .stat-badge.timer-badge i { color:white; }
        .dark-mode-toggle { position:absolute; bottom:30px; left:50%; transform:translateX(-50%); background:transparent; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-light); transition:var(--transition); }
        .dark-mode-toggle:hover { color:var(--primary); transform:translateX(-50%) rotate(30deg); }
        .floating-action-btn { position:fixed; bottom:30px; right:30px; width:60px; height:60px; border-radius:50%; background:var(--primary); color:white; border:none; font-size:1.5rem; cursor:pointer; box-shadow:0 10px 20px rgba(108,92,231,.3); z-index:100; display:flex; align-items:center; justify-content:center; transition:var(--transition); }
        .floating-action-btn:hover { transform:scale(1.1) rotate(90deg); }
        .floating { animation:float 3s ease-in-out infinite; }
        .mode-badge { display:inline-flex; align-items:center; gap:6px; padding:6px 14px; border-radius:20px; font-size:.8rem; font-weight:700; }
        .mode-local { background:#ffeaa7; color:#e17055; }
        .mode-cloud { background:#d4edda; color:#155724; }

        /* destaques */
        @keyframes highlightPulse {
            0%   { box-shadow:0 0 0 0 rgba(0,206,201,.7); transform:scale(1); }
            50%  { box-shadow:0 0 0 20px rgba(0,206,201,0); transform:scale(1.06); }
            100% { box-shadow:0 0 0 0 rgba(0,206,201,0); transform:scale(1); }
        }
        .product-card.highlight-add { animation:highlightPulse .6s ease; border-color:var(--secondary) !important; }

        /* cart summary */
        .cart-summary { background:#f8f9fa; border-radius:16px; padding:14px; margin-bottom:14px; font-size:.92rem; }
        .cart-summary-row { display:flex; justify-content:space-between; padding:4px 0; }
        .cart-summary-row.discount { color:var(--success); font-weight:700; }
        .cart-summary-row.total-row { font-weight:900; font-size:1.1rem; color:var(--primary); border-top:1px dashed #dfe6e9; padding-top:10px; margin-top:6px; }

        /* emoji preview */
        .emoji-input-wrap { position:relative; flex:0 0 120px; }
        .emoji-preview-badge { position:absolute; right:12px; top:50%; transform:translateY(-50%); font-size:1.6rem; pointer-events:none; line-height:1; }

        /* discount banner */
        .discount-banner { display:none; background:linear-gradient(90deg,var(--success),#00d2d3); color:white; border-radius:12px; padding:8px 16px; margin-bottom:12px; font-weight:800; font-size:.9rem; justify-content:space-between; align-items:center; }
        .discount-banner.show { display:flex; }
        .discount-banner button { background:rgba(255,255,255,.3); border:none; color:white; border-radius:8px; padding:3px 8px; cursor:pointer; font-size:.8rem; font-weight:700; }
        .discount-banner button:hover { background:rgba(255,255,255,.5); }

        /* modal actions */
        .modal-actions {
            display:flex;
            gap:10px;
            margin-top:15px;
        }
        .modal-actions button {
            flex:1;
            padding:15px;
            border-radius:16px;
            font-weight:bold;
            cursor:pointer;
            border:none;
            transition:var(--transition);
        }
        .btn-cancel {
            background:#ff7675;
            color:white;
        }
        .btn-cancel:hover {
            background:#ff5252;
            transform:translateY(-3px);
        }
        .btn-discount {
            background:linear-gradient(90deg,var(--primary),var(--primary-light));
            color:white;
        }
        .btn-discount:hover {
            transform:translateY(-3px);
            box-shadow:0 10px 20px rgba(108,92,231,.3);
        }

        /* caixa */
        .cashier-control {
            background:white;
            border-radius:20px;
            padding:20px;
            margin-bottom:20px;
            box-shadow:var(--shadow-light);
        }
        .cashier-status {
            display:flex;
            align-items:center;
            justify-content:space-between;
            margin-bottom:15px;
        }
        .cashier-status-badge {
            display:flex;
            align-items:center;
            gap:10px;
            padding:10px 20px;
            border-radius:12px;
            font-weight:800;
        }
        .cashier-open {
            background:var(--success);
            color:white;
        }
        .cashier-closed {
            background:var(--danger);
            color:white;
        }
        .cashier-actions {
            display:flex;
            gap:10px;
        }
        .cashier-input-group {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
            gap:15px;
            margin-top:15px;
        }
        .cash-movement-card {
            background:#f8f9fa;
            border-radius:16px;
            padding:15px;
            margin-bottom:10px;
            border-left:4px solid var(--primary);
        }
        .cash-movement-card.withdrawal {
            border-left-color:var(--danger);
        }
        .cash-movement-card.supply {
            border-left-color:var(--success);
        }

        @media(max-width:992px){
            .pdv-grid{grid-template-columns:1fr;height:auto}
            .product-list{max-height:400px}
            .app-container{grid-template-columns:1fr;grid-template-rows:80px 1fr}
            .sidebar{flex-direction:row;justify-content:center;padding-top:0;padding:10px}
            .nav-btn{margin-bottom:0;margin-right:10px}
        }
        @media(max-width:768px){
            .dashboard-cards{grid-template-columns:1fr}
            .form-add,.pdv-header{flex-direction:column}
            .scan-input,.form-row{min-width:100%;grid-template-columns:1fr}
            body{padding:10px}
            .payment-options { grid-template-columns:1fr; }
        }
    </style>
</head>
<body>

<!-- Part√≠culas m√°gicas -->
<div id="particlesContainer" aria-hidden="true"></div>

<!-- Loader -->
<div class="loader" id="loader">
    <div class="loader-spinner"></div>
    <p>Carregando magia... ‚ú®</p>
</div>

<!-- Auth -->
<div class="auth-container" id="authContainer">
    <!-- Login -->
    <div class="auth-card" id="loginCard">
        <div class="auth-header">
            <div class="auth-logo">‚ú®</div>
            <h1 class="auth-title">PDV M√°gico Pro</h1>
            <p class="auth-subtitle">Sistema Profissional de Vendas</p>
        </div>
        <div class="error-msg" id="loginError"></div>
        <div class="auth-form">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="loginEmail" placeholder="seu@email.com" autocomplete="email">
            </div>
            <div class="form-group">
                <label class="form-label">Senha</label>
                <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            </div>
            <button class="auth-btn" id="loginBtn" onclick="loginUser()">
                <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
            </button>
            <div class="auth-switch">
                N√£o tem conta? <a onclick="showRegister()">Cadastre-se gratuitamente</a>
            </div>
        </div>
    </div>

    <!-- Register -->
    <div class="auth-card" id="registerCard" style="display:none">
        <div class="auth-header">
            <div class="auth-logo">üöÄ</div>
            <h1 class="auth-title">Criar Conta</h1>
            <p class="auth-subtitle">Comece gratuitamente</p>
        </div>
        <div class="plan-card">
            <div class="plan-badge">7 DIAS GR√ÅTIS</div>
            <h3>Plano Profissional</h3>
            <div class="plan-price">R$ 29,90</div>
            <div class="plan-period">por m√™s ap√≥s o trial</div>
            <ul class="plan-features">
                <li><i class="fas fa-check"></i> PDV Completo com busca por voz</li>
                <li><i class="fas fa-check"></i> Gest√£o de Estoque inteligente</li>
                <li><i class="fas fa-check"></i> Dashboard Anal√≠tico Avan√ßado</li>
                <li><i class="fas fa-check"></i> Abertura/Fechamento de Caixa</li>
                <li><i class="fas fa-check"></i> Sangria e Suprimento</li>
                <li><i class="fas fa-check"></i> Suporte 24/7 e backups na nuvem</li>
            </ul>
        </div>
        <div class="error-msg" id="registerError"></div>
        <div class="auth-form" style="margin-top:20px">
            <div class="form-group">
                <label class="form-label">Nome da Empresa</label>
                <input type="text" class="form-input" id="regCompany" placeholder="Sua Empresa LTDA">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">CNPJ/CPF</label>
                    <input type="text" class="form-input" id="regDocument" placeholder="000.000.000-00">
                </div>
                <div class="form-group">
                    <label class="form-label">Telefone</label>
                    <input type="tel" class="form-input" id="regPhone" placeholder="(11) 99999-9999">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="regEmail" placeholder="seu@email.com" autocomplete="email">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-input" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirmar Senha</label>
                    <input type="password" class="form-input" id="regConfirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
                </div>
            </div>
            <div class="terms-checkbox">
                <input type="checkbox" id="regTerms">
                <label for="regTerms">Concordo com os <a href="#" onclick="showTermsModal()">Termos de Uso</a> e autorizo cobran√ßa de R$ 29,90/m√™s ap√≥s o trial.</label>
            </div>
            <button class="auth-btn" id="registerBtn" onclick="registerUser()">
                <i class="fas fa-rocket"></i> Come√ßar Per√≠odo Gr√°tis
            </button>
            <div class="auth-switch">J√° tem conta? <a onclick="showLogin()">Fa√ßa login</a></div>
        </div>
    </div>
</div>

<!-- App -->
<div class="app-container" id="appContainer">
    <nav class="sidebar">
        <button class="nav-btn active" onclick="switchTab('pdv')" title="Vendas (F1)">üõí<span class="nav-notification" id="cartNotification" style="display:none">0</span></button>
        <button class="nav-btn" onclick="switchTab('stock')" title="Estoque (F2)">üì¶<span class="nav-notification" id="stockNotification" style="display:none">0</span></button>
        <button class="nav-btn" onclick="switchTab('dashboard')" title="Dashboard (F3)">üìä</button>
        <button class="nav-btn" onclick="switchTab('cashier')" title="Caixa (F4)">üí∞</button>
        <button class="nav-btn" onclick="openAccountModal()" title="Conta">üë§</button>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Modo Escuro">üåô</button>
    </nav>
    <main class="content-area">
        <!-- PDV -->
        <section id="pdv" class="section active">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px">
                <h2><i class="fas fa-cash-register"></i> Caixa Inteligente ‚ú®</h2>
                <div style="display:flex;gap:10px;align-items:center">
                    <div class="stat-badge" id="cashierStatusBadge" style="display:none">
                        <i class="fas fa-lock"></i><span>Caixa Fechado</span>
                    </div>
                    <div class="stat-badge" id="subscriptionStatus" style="background:var(--success);color:white">
                        <i class="fas fa-crown"></i><span>Plano Ativo</span>
                    </div>
                </div>
            </div>
            
            <div class="pdv-header">
                <input type="text" id="barcodeInput" class="scan-input" placeholder="üîç Escaneie ou digite o nome do produto... (F2 para voz)">
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="openVoiceSearch()"><i class="fas fa-microphone"></i> Voz</button>
                    <button class="quick-action-btn" onclick="applyDiscount()"><i class="fas fa-tag"></i> Desconto</button>
                    <button class="quick-action-btn" onclick="openQuickProductModal()"><i class="fas fa-plus"></i> R√°pido</button>
                </div>
            </div>
            
            <div style="position:relative">
                <div class="suggestions-box" id="suggestionsBox"></div>
            </div>
            
            <!-- Live Stats -->
            <div class="live-stats">
                <div class="stat-badge"><i class="fas fa-shopping-cart"></i><span id="liveCartCount">0 itens</span></div>
                <div class="stat-badge"><i class="fas fa-dollar-sign"></i><span id="liveCartTotal">R$ 0,00</span></div>
                <div class="stat-badge timer-badge"><i class="fas fa-stopwatch"></i><span id="liveSaleTimer">00:00</span></div>
            </div>
            
            <div class="pdv-grid">
                <div class="product-list" id="productsGrid"></div>
                <div class="cart-panel">
                    <div class="cart-header">
                        <h3><i class="fas fa-shopping-basket"></i> Cesta</h3>
                        <button class="clear-cart" onclick="clearCart()" id="clearCartBtn" disabled><i class="fas fa-trash"></i> Limpar (F8)</button>
                    </div>
                    <div class="cart-items" id="cartItems">
                        <div style="text-align:center;color:#b2bec3;margin-top:50px;padding:30px">
                            <i class="fas fa-shopping-basket" style="font-size:3rem;margin-bottom:15px;opacity:.5"></i>
                            <p>Cesta vazia üçÉ</p>
                        </div>
                    </div>
                    
                    <!-- Banner de desconto ativo -->
                    <div class="discount-banner" id="discountBanner">
                        <span id="discountBannerText">üéâ Desconto ativo</span>
                        <button onclick="removeDiscount()">‚úï Remover</button>
                    </div>
                    
                    <div class="cart-footer">
                        <!-- Resumo detalhado -->
                        <div class="cart-summary" id="cartSummary" style="display:none">
                            <div class="cart-summary-row"><span>Subtotal:</span><span id="summarySubtotal">R$ 0,00</span></div>
                            <div class="cart-summary-row discount" id="summaryDiscountRow" style="display:none"><span id="summaryDiscountLabel">Desconto:</span><span id="summaryDiscount">-R$ 0,00</span></div>
                            <div class="cart-summary-row total-row"><span>Total:</span><span id="summaryTotal">R$ 0,00</span></div>
                        </div>
                        <div class="cart-total"><span class="cart-total-label">Total:</span><span id="cartTotal">R$ 0,00</span></div>
                        <button class="btn-checkout" id="btnCheckout" onclick="openPaymentModal()" disabled><i class="fas fa-rocket"></i> Finalizar (F5) üöÄ</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- STOCK -->
        <section id="stock" class="section">
            <h2><i class="fas fa-boxes"></i> Gest√£o de Estoque üì¶</h2>
            <div class="form-add">
                <input type="text" id="newProdName" placeholder="Nome do Produto" oninput="suggestEmoji()">
                <input type="number" id="newProdPrice" placeholder="Pre√ßo (R$)" step="0.01" min="0">
                <input type="number" id="newProdStock" placeholder="Qtd" min="0">
                <select id="newProdCategory">
                    <option value="">Categoria...</option>
                    <option value="alimento">üçî Alimentos</option>
                    <option value="bebida">ü•§ Bebidas</option>
                    <option value="limpeza">üßº Limpeza</option>
                    <option value="eletronico">üì± Eletr√¥nicos</option>
                    <option value="vestuario">üëï Vestu√°rio</option>
                    <option value="outro">üì¶ Outros</option>
                </select>
                <div class="emoji-input-wrap">
                    <input type="text" id="newProdEmoji" placeholder="Emoji" oninput="updateEmojiPreview()" style="max-width:120px">
                    <span class="emoji-preview-badge" id="emojiPreviewBadge">üì¶</span>
                </div>
                <button class="btn-checkout" style="width:auto;padding:14px 25px" onclick="addProduct()"><i class="fas fa-plus-circle"></i> Adicionar</button>
            </div>
            <div class="table-container">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                    <h3 style="margin:0">Produtos Cadastrados</h3>
                    <div style="display:flex;gap:10px">
                        <input type="text" id="stockSearch" placeholder="Buscar..." style="width:200px" oninput="filterStockTable()">
                        <button class="quick-action-btn" onclick="exportStockCSV()"><i class="fas fa-file-export"></i> Exportar</button>
                    </div>
                </div>
                <table id="stockTable">
                    <thead><tr><th>Item</th><th>Pre√ßo</th><th>Estoque</th><th>Categoria</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="stockTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- DASHBOARD -->
        <section id="dashboard" class="section">
            <h2><i class="fas fa-chart-line"></i> Dashboard üìà</h2>
            <div class="dashboard-cards">
                <div class="card-metric"><div class="metric-icon">üí∞</div><div class="metric-info"><p>Vendas Hoje</p><h3 id="dashTotalSales">R$ 0,00</h3><p style="font-size:.8rem;color:var(--success)" id="dashSalesChange">+0% vs ontem</p></div></div>
                <div class="card-metric"><div class="metric-icon">üßæ</div><div class="metric-info"><p>Tickets</p><h3 id="dashTotalTickets">0</h3><p style="font-size:.8rem;color:var(--text-light)" id="dashAvgTicket">M√©dia: R$ 0,00</p></div></div>
                <div class="card-metric"><div class="metric-icon">üî•</div><div class="metric-info"><p>Mais Vendido</p><h3 id="dashTopProduct">-</h3><p style="font-size:.8rem;color:var(--text-light)" id="dashTopProductQty">0 unidades</p></div></div>
                <div class="card-metric"><div class="metric-icon">üì¶</div><div class="metric-info"><p>Estoque Baixo</p><h3 id="dashLowStock">0</h3><p style="font-size:.8rem;color:var(--danger)">Itens cr√≠ticos</p></div></div>
            </div>
            <div class="chart-container">
                <h3>Vendas por Dia da Semana</h3>
                <div class="chart-bars" id="salesChart"></div>
            </div>
            <div class="table-container">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                    <h3 style="margin:0">Hist√≥rico de Vendas</h3>
                    <div style="display:flex;gap:10px;align-items:center">
                        <select id="salesFilter" onchange="filterSalesHistory()" style="width:160px">
                            <option value="all">Todas as vendas</option>
                            <option value="today">Hoje</option>
                            <option value="week">Esta semana</option>
                            <option value="month">Este m√™s</option>
                        </select>
                        <button class="quick-action-btn" onclick="exportSalesCSV()"><i class="fas fa-download"></i> Exportar</button>
                    </div>
                </div>
                <table>
                    <thead><tr><th>Data/Hora</th><th>M√©todo</th><th>Itens</th><th>Total</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="salesHistoryBody"></tbody>
                </table>
            </div>
        </section>

        <!-- NOVO: CONTROLE DE CAIXA -->
        <section id="cashier" class="section">
            <h2><i class="fas fa-cash-register"></i> Controle de Caixa üí∞</h2>
            
            <!-- Controle de Abertura/Fechamento -->
            <div class="cashier-control">
                <div class="cashier-status">
                    <div>
                        <h3 style="margin-bottom:5px">Status do Caixa</h3>
                        <div class="cashier-status-badge" id="cashierStatusBadgeFull">
                            <i class="fas fa-lock"></i>
                            <span>Caixa Fechado</span>
                        </div>
                    </div>
                    <div class="cashier-actions" id="cashierActionsOpen">
                        <button class="quick-action-btn" onclick="openCashierModal()" style="background:var(--success);color:white;border-color:var(--success)">
                            <i class="fas fa-lock-open"></i> Abrir Caixa
                        </button>
                    </div>
                    <div class="cashier-actions" id="cashierActionsClose" style="display:none">
                        <button class="quick-action-btn" onclick="openWithdrawalModal()">
                            <i class="fas fa-minus-circle"></i> Sangria
                        </button>
                        <button class="quick-action-btn" onclick="openSupplyModal()">
                            <i class="fas fa-plus-circle"></i> Suprimento
                        </button>
                        <button class="quick-action-btn" onclick="closeCashierModal()" style="background:var(--danger);color:white;border-color:var(--danger)">
                            <i class="fas fa-lock"></i> Fechar Caixa
                        </button>
                    </div>
                </div>
                
                <div id="cashierDetails" style="display:none;margin-top:20px">
                    <div class="cashier-input-group">
                        <div>
                            <label style="font-weight:700;font-size:.9rem;display:block;margin-bottom:5px">Operador:</label>
                            <div style="padding:12px;background:#f8f9fa;border-radius:12px" id="cashierOperator">-</div>
                        </div>
                        <div>
                            <label style="font-weight:700;font-size:.9rem;display:block;margin-bottom:5px">Abertura:</label>
                            <div style="padding:12px;background:#f8f9fa;border-radius:12px" id="cashierOpenTime">-</div>
                        </div>
                        <div>
                            <label style="font-weight:700;font-size:.9rem;display:block;margin-bottom:5px">Saldo Inicial:</label>
                            <div style="padding:12px;background:#f8f9fa;border-radius:12px;font-weight:800;color:var(--primary)" id="cashierInitial">R$ 0,00</div>
                        </div>
                        <div>
                            <label style="font-weight:700;font-size:.9rem;display:block;margin-bottom:5px">Saldo Atual:</label>
                            <div style="padding:12px;background:#f8f9fa;border-radius:12px;font-weight:800;color:var(--success)" id="cashierCurrent">R$ 0,00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Movimenta√ß√µes -->
            <div class="table-container">
                <h3 style="margin-bottom:20px">Movimenta√ß√µes do Dia</h3>
                <div id="cashMovementsList"></div>
            </div>

            <!-- Resumo Financeiro -->
            <div class="dashboard-cards" style="margin-top:30px">
                <div class="card-metric">
                    <div class="metric-icon">üíµ</div>
                    <div class="metric-info">
                        <p>Total em Vendas</p>
                        <h3 id="cashierTotalSales">R$ 0,00</h3>
                    </div>
                </div>
                <div class="card-metric">
                    <div class="metric-icon">‚ûñ</div>
                    <div class="metric-info">
                        <p>Total Sangrias</p>
                        <h3 id="cashierTotalWithdrawals" style="color:var(--danger)">R$ 0,00</h3>
                    </div>
                </div>
                <div class="card-metric">
                    <div class="metric-icon">‚ûï</div>
                    <div class="metric-info">
                        <p>Total Suprimentos</p>
                        <h3 id="cashierTotalSupplies" style="color:var(--success)">R$ 0,00</h3>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Badges -->
<div class="low-stock-badge" id="lowStockBadge" onclick="switchTab('stock')" style="display:none">
    <i class="fas fa-exclamation-triangle"></i>
    <div><strong id="lowStockCount">0 produtos</strong> com estoque baixo</div>
</div>

<!-- MODAIS -->
<div class="modal-overlay" id="paymentModal">
    <div class="modal-content">
        <h2 style="margin-bottom:20px">Pagamento üí∏</h2>
        
        <div style="background:#f8f9fa;padding:20px;border-radius:16px;margin-bottom:20px">
            <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                <span>Subtotal:</span>
                <span style="font-weight:700" id="modalSubtotal">R$ 0,00</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                <span>Desconto:</span>
                <span style="color:var(--success);font-weight:700" id="modalDiscount">-R$ 0,00</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:1.3rem;font-weight:900;color:var(--primary);border-top:2px dashed #dfe6e9;padding-top:10px;margin-top:5px">
                <span>Total:</span>
                <span id="modalTotalValue">R$ 0,00</span>
            </div>
        </div>

        <div class="payment-options">
            <button class="btn-pay" onclick="processPayment('Pix')">
                <i class="fas fa-qrcode"></i> Pix (5% OFF)
            </button>
            <button class="btn-pay" onclick="processPayment('Cart√£o Cr√©dito')">
                <i class="fas fa-credit-card"></i> Cr√©dito
            </button>
            <button class="btn-pay" onclick="processPayment('Cart√£o D√©bito')">
                <i class="fas fa-credit-card"></i> D√©bito
            </button>
            <button class="btn-pay" onclick="processPayment('Dinheiro')">
                <i class="fas fa-money-bill-wave"></i> Dinheiro
            </button>
        </div>

        <div class="modal-actions">
            <button class="btn-cancel" onclick="closePaymentModal()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn-discount" onclick="applyDiscountToSale(10)">
                <i class="fas fa-tag"></i> 10% OFF
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="receiptModal">
    <div class="modal-content">
        <h2 style="margin-bottom:15px">Venda Finalizada! üéâ</h2>
        <p style="color:#636e72;margin-bottom:20px">Comprovante gerado com sucesso!</p>
        
        <div style="background:#f8f9fa;padding:20px;border-radius:16px;margin-bottom:20px;text-align:left">
            <p style="margin-bottom:8px"><strong>ID:</strong> <span id="receiptId">#0000</span></p>
            <p style="margin-bottom:8px"><strong>Data:</strong> <span id="receiptDate">-</span></p>
            <p style="margin-bottom:8px"><strong>M√©todo:</strong> <span id="receiptMethod">-</span></p>
            <p style="font-size:1.3rem;font-weight:900;color:var(--primary);margin-top:10px">
                <strong>Total:</strong> <span id="receiptTotal">R$ 0,00</span>
            </p>
        </div>

        <div class="receipt-options">
            <button class="btn-receipt" onclick="printReceiptFromModal()">
                <i class="fas fa-print"></i> üñ®Ô∏è Imprimir
            </button>
            <button class="btn-receipt btn-whatsapp" onclick="sendViaWhatsapp()">
                <i class="fab fa-whatsapp"></i> üì± WhatsApp
            </button>
            <button class="btn-receipt btn-email" onclick="sendViaEmail()">
                <i class="fas fa-envelope"></i> üìß Email
            </button>
        </div>

        <div class="modal-actions" style="margin-top:20px">
            <button class="btn-checkout" style="flex:1;background:var(--primary)" onclick="newSale()">
                <i class="fas fa-redo"></i> Nova Venda
            </button>
            <button class="btn-checkout" style="flex:1;background:var(--secondary)" onclick="goToPdv()">
                <i class="fas fa-cash-register"></i> Voltar ao PDV
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="quickProductModal">
    <div class="modal-content">
        <h2 style="margin-bottom:20px">Produto R√°pido ‚ö°</h2>
        <div style="margin:20px 0;display:flex;flex-direction:column;gap:15px">
            <input type="text" id="quickProdName" placeholder="Nome do produto" style="width:100%">
            <input type="number" id="quickProdPrice" placeholder="Pre√ßo (R$)" step="0.01" min="0" style="width:100%">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeQuickProductModal()">Cancelar</button>
            <button class="btn-checkout" onclick="addQuickProduct()">
                <i class="fas fa-bolt"></i> Adicionar
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="accountModal">
    <div class="modal-content">
        <h2 style="margin-bottom:20px">Minha Conta üë§</h2>
        <div style="text-align:center;margin-bottom:20px">
            <div style="width:80px;height:80px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 15px;color:white;font-size:2rem">üëë</div>
            <h3 id="accountCompanyName">-</h3>
            <p style="color:var(--text-light)" id="accountEmail">-</p>
            <span class="mode-badge" id="modeBadge">-</span>
        </div>
        <div style="background:#f8f9fa;padding:20px;border-radius:16px;margin-bottom:20px">
            <div style="display:flex;justify-content:space-between;margin-bottom:10px"><span>Plano:</span><span style="font-weight:700;color:var(--primary)" id="accountPlanStatus">-</span></div>
            <div style="display:flex;justify-content:space-between;margin-bottom:10px"><span>V√°lido at√©:</span><span style="font-weight:700" id="accountValidUntil">-</span></div>
            <div style="display:flex;justify-content:space-between"><span>CNPJ/CPF:</span><span style="font-weight:700" id="accountDocument">-</span></div>
        </div>
        <button class="btn-checkout" style="background:#ff7675" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Sair do Sistema
        </button>
    </div>
</div>

<!-- NOVOS MODAIS DE CAIXA -->
<div class="modal-overlay" id="cashierOpenModal">
    <div class="modal-content">
        <h2 style="margin-bottom:20px">Abertura de Caixa üîì</h2>
        <div style="margin:20px 0;display:flex;flex-direction:column;gap:15px">
            <div>
                <label style="font-weight:700;display:block;margin-bottom:8px">Operador:</label>
                <input type="text" id="cashierOperatorInput" style="width:100%" readonly>
            </div>
            <div>
                <label style="font-weight:700;display:block;margin-bottom:8px">Saldo Inicial (R$):</label>
                <input type="number" id="cashierInitialAmount" placeholder="0.00" step="0.01" min="0" style="width:100%">
            </div>
            <div>
                <label style="font-weight:700;display:block;margin-bottom:8px">Observa√ß√µes:</label>
                <textarea id="cashierOpenNotes" rows="3" style="width:100%;padding:14px;border-radius:14px;border:2px solid #dfe6e9;resize:vertical" placeholder="Observa√ß√µes opcionais..."></textarea>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeCashierOpenModal()">Cancelar</button>
            <button class="btn-checkout" onclick="confirmOpenCashier()">
                <i class="fas fa-check"></i> Abrir Caixa
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="cashierCloseModal">
    <div class="modal-content">
        <h2 style="margin-bottom:20px">Fechamento de Caixa üîí</h2>
        <div style="background:#f8f9fa;padding:20px;border-radius:16px;margin-bottom:20px;text-align:left">
            <h3 style="margin-bottom:15px;color:var(--primary)">Resumo do Dia</h3>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                <span>Saldo Inicial:</span>
                <span style="font-weight:700" id="closeCashierInitial">R$ 0,00</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                <span>Vendas:</span>
                <span style="font-weight:700;color:var(--success)" id="closeCashierSales">R$ 0,00</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                <span>Sangrias:</span>
                <span style="font-weight:700;color:var(--danger)" id="closeCashierWithdrawals">R$ 0,00</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                <span>Suprimentos:</span>
                <span style="font-weight:700;color:var(--info)" id="closeCashierSupplies">R$ 0,00</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:1.2rem;font-weight:900;color:var(--primary);border-top:2px dashed #dfe6e9;padding-top:10px;margin-top:10px">
                <span>Saldo Final:</span>
                <span id="closeCashierFinal">R$ 0,00</span>
            </div>
        </div>
        <div style="margin:20px 0">
            <label style="font-weight:700;display:block;margin-bottom:8px">Observa√ß√µes de Fechamento:</label>
            <textarea id="cashierCloseNotes" rows="3" style="width:100%;padding:14px;border-radius:14px;border:2px solid #dfe6e9;resize:vertical" placeholder="Observa√ß√µes opcionais..."></textarea>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeCashierCloseModal()">Cancelar</button>
            <button class="btn-checkout" style="background:var(--danger)" onclick="confirmCloseCashier()">
                <i class="fas fa-lock"></i> Fechar Caixa
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="withdrawalModal">
    <div class="modal-content">
        <h2 style="margin-bottom:20px">Sangria üí∏</h2>
        <p style="color:var(--text-light);margin-bottom:20px">Retirada de dinheiro do caixa</p>
        <div style="margin:20px 0;display:flex;flex-direction:column;gap:15px">
            <div>
                <label style="font-weight:700;display:block;margin-bottom:8px">Valor (R$):</label>
                <input type="number" id="withdrawalAmount" placeholder="0.00" step="0.01" min="0.01" style="width:100%">
            </div>
            <div>
                <label style="font-weight:700;display:block;margin-bottom:8px">Motivo:</label>
                <textarea id="withdrawalReason" rows="3" style="width:100%;padding:14px;border-radius:14px;border:2px solid #dfe6e9;resize:vertical" placeholder="Ex: Troco, Despesa, etc."></textarea>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeWithdrawalModal()">Cancelar</button>
            <button class="btn-checkout" style="background:var(--danger)" onclick="confirmWithdrawal()">
                <i class="fas fa-minus-circle"></i> Confirmar Sangria
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="supplyModal">
    <div class="modal-content">
        <h2 style="margin-bottom:20px">Suprimento üí∞</h2>
        <p style="color:var(--text-light);margin-bottom:20px">Entrada de dinheiro no caixa</p>
        <div style="margin:20px 0;display:flex;flex-direction:column;gap:15px">
            <div>
                <label style="font-weight:700;display:block;margin-bottom:8px">Valor (R$):</label>
                <input type="number" id="supplyAmount" placeholder="0.00" step="0.01" min="0.01" style="width:100%">
            </div>
            <div>
                <label style="font-weight:700;display:block;margin-bottom:8px">Motivo:</label>
                <textarea id="supplyReason" rows="3" style="width:100%;padding:14px;border-radius:14px;border:2px solid #dfe6e9;resize:vertical" placeholder="Ex: Troco inicial, Refor√ßo, etc."></textarea>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeSupplyModal()">Cancelar</button>
            <button class="btn-checkout" style="background:var(--success)" onclick="confirmSupply()">
                <i class="fas fa-plus-circle"></i> Confirmar Suprimento
            </button>
        </div>
    </div>
</div>

<div id="toast" class="toast">
    <i class="fas fa-check-circle toast-icon"></i>
    <span class="toast-message">OK</span>
</div>

<script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PDV M√ÅGICO PRO v4.0 ‚Äî VERS√ÉO PROFISSIONAL COMPLETA
    // Sistema Profissional de Ponto de Venda com Controle de Caixa
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const APP_NAME   = "PDV M√°gico Pro";
    const APP_VER    = "4.0.0";
    const TRIAL_DAYS = 7;
    const PRICE      = 29.90;

    // ‚îÄ‚îÄ SUPABASE CONFIG ‚îÄ‚îÄ
    const SB_URL  = 'https://qdrassirutbfvhvepwdd.supabase.co';
    const SB_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcmFzc2lydXRiZnZodmVwd2RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODA2ODUsImV4cCI6MjA4NzU1NjY4NX0.9zPKrANHVDLOLm-e7yANAu4vr8s9QjsX_tG72AygKEM';

    let sb = null;
    let useLocal = true;
    let currentUser = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BANCO DE EMOJIS AVAN√áADO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const EMOJI_DB = [
        {char:'üçî',keys:['hamburguer','burger','lanche','fast','comida'],cat:'alimento'},
        {char:'üçï',keys:['pizza','massa','italiana','queijo'],cat:'alimento'},
        {char:'üå≠',keys:['hotdog','cachorro','quente','salsicha'],cat:'alimento'},
        {char:'üçü',keys:['batata','frita','chips','salgado'],cat:'alimento'},
        {char:'ü•™',keys:['sanduiche','misto','natural'],cat:'alimento'},
        {char:'üåÆ',keys:['taco','mexicano','burrito'],cat:'alimento'},
        {char:'üç£',keys:['sushi','peixe','japones','japao'],cat:'alimento'},
        {char:'üç§',keys:['camarao','empanado','frutos','mar'],cat:'alimento'},
        {char:'üç¶',keys:['sorvete','casquinha','gelado'],cat:'alimento'},
        {char:'üç©',keys:['donut','rosquinha','padaria'],cat:'alimento'},
        {char:'üç™',keys:['cookie','biscoito','bolacha'],cat:'alimento'},
        {char:'üç´',keys:['chocolate','cacau','barra'],cat:'alimento'},
        {char:'üç¨',keys:['bala','doce','caramelo'],cat:'alimento'},
        {char:'üç≠',keys:['pirulito','doce','candy'],cat:'alimento'},
        {char:'üç∞',keys:['bolo','torta','sobremesa','fatia'],cat:'alimento'},
        {char:'üéÇ',keys:['bolo','aniversario','festa'],cat:'alimento'},
        {char:'üçé',keys:['maca','fruta','vermelha'],cat:'alimento'},
        {char:'üçå',keys:['banana','fruta','amarela'],cat:'alimento'},
        {char:'üçá',keys:['uva','fruta','roxo'],cat:'alimento'},
        {char:'ü••',keys:['coco','tropical'],cat:'alimento'},
        {char:'üçâ',keys:['melancia','verao','fruta'],cat:'alimento'},
        {char:'üçì',keys:['morango','vermelho','doce'],cat:'alimento'},
        {char:'ü•©',keys:['carne','bife','churrasco','proteina'],cat:'alimento'},
        {char:'üçó',keys:['frango','coxa','asas','assado'],cat:'alimento'},
        {char:'ü•ì',keys:['bacon','porco'],cat:'alimento'},
        {char:'ü•ö',keys:['ovo','ovos','clara'],cat:'alimento'},
        {char:'‚òï',keys:['cafe','coffee','expresso','capuccino'],cat:'bebida'},
        {char:'ü•§',keys:['suco','refrigerante','bebida','copo'],cat:'bebida'},
        {char:'üç∫',keys:['cerveja','beer','alcool'],cat:'bebida'},
        {char:'üç∑',keys:['vinho','taca'],cat:'bebida'},
        {char:'üç∏',keys:['drink','coquetel','cocktail'],cat:'bebida'},
        {char:'üßÉ',keys:['caixinha','n√©ctar','suco'],cat:'bebida'},
        {char:'üßâ',keys:['mate','chimarrao','erva'],cat:'bebida'},
        {char:'üíß',keys:['agua','mineral','garrafa'],cat:'bebida'},
        {char:'üëï',keys:['camisa','camiseta','roupa','vestuario'],cat:'vestuario'},
        {char:'üëñ',keys:['calca','jeans','bermuda'],cat:'vestuario'},
        {char:'üëó',keys:['vestido','saia','blusa'],cat:'vestuario'},
        {char:'üëü',keys:['tenis','sapato','calcado','esporte'],cat:'vestuario'},
        {char:'üëí',keys:['chapeu','bon√©','gorro'],cat:'vestuario'},
        {char:'üß•',keys:['casaco','jaqueta','blaser'],cat:'vestuario'},
        {char:'üì±',keys:['celular','smartphone','iphone','android'],cat:'eletronico'},
        {char:'üíª',keys:['notebook','laptop','computador'],cat:'eletronico'},
        {char:'‚åö',keys:['relogio','smartwatch','pulso'],cat:'eletronico'},
        {char:'üì∫',keys:['televisao','tv','monitor'],cat:'eletronico'},
        {char:'üéÆ',keys:['videogame','jogo','console','controle'],cat:'eletronico'},
        {char:'üîã',keys:['bateria','pilha','energia','carregador'],cat:'eletronico'},
        {char:'üéß',keys:['fone','headphone','audio','musica'],cat:'eletronico'},
        {char:'üñ®Ô∏è',keys:['impressora','printer'],cat:'eletronico'},
        {char:'üßº',keys:['sabao','detergente','limpeza','sabonete'],cat:'limpeza'},
        {char:'üßπ',keys:['vassoura','varrer','limpar'],cat:'limpeza'},
        {char:'üß∫',keys:['cesto','lavanderia','roupa'],cat:'limpeza'},
        {char:'üß¥',keys:['shampoo','condicionador','higiene'],cat:'limpeza'},
        {char:'ü™£',keys:['balde','limpeza'],cat:'limpeza'},
        {char:'üíä',keys:['remedio','pilula','farmacia','medicamento'],cat:'outro'},
        {char:'üì¶',keys:['caixa','pacote','embalagem'],cat:'outro'},
        {char:'üéÅ',keys:['presente','brinde','kit'],cat:'outro'},
        {char:'üìö',keys:['livro','revista','leitura'],cat:'outro'},
        {char:'‚úèÔ∏è',keys:['lapis','caneta','escrita'],cat:'outro'},
        {char:'üîß',keys:['ferramenta','chave','reparo'],cat:'outro'},
        {char:'üåø',keys:['erva','planta','natural','organico'],cat:'outro'},
    ];

    // ‚îÄ‚îÄ PRODUTOS PADR√ÉO ‚îÄ‚îÄ
    const DEFAULT_PRODUCTS = [
        {id:1,name:'Hamb√∫rguer M√°gico',price:25.00,stock:20,emoji:'üçî',category:'alimento'},
        {id:2,name:'Po√ß√£o de Cafe√≠na',price:8.50,stock:50,emoji:'‚òï',category:'bebida'},
        {id:3,name:'Donut Estelar',price:12.00,stock:15,emoji:'üç©',category:'alimento'},
        {id:4,name:'Pizza Infinita',price:45.00,stock:8,emoji:'üçï',category:'alimento'},
        {id:5,name:'Sushi Zen',price:60.00,stock:10,emoji:'üç£',category:'alimento'},
        {id:6,name:'Sorvete Nuvem',price:15.00,stock:25,emoji:'üç¶',category:'alimento'},
        {id:7,name:'Suco Vitamina',price:12.00,stock:40,emoji:'ü•§',category:'bebida'},
        {id:8,name:'Camisa M√°gica',price:89.90,stock:12,emoji:'üëï',category:'vestuario'},
        {id:9,name:'Fones Celestial',price:120.00,stock:5,emoji:'üéß',category:'eletronico'},
        {id:10,name:'Chocolat√£o',price:9.00,stock:35,emoji:'üç´',category:'alimento'},
    ];

    // ‚îÄ‚îÄ ESTADO GLOBAL ‚îÄ‚îÄ
    let products = [];
    let salesHistory = [];
    let cart = [];
    let currentSaleData = null;
    let currentDiscount = 0;
    let saleTimerInterval = null;
    let saleStartTime = null;
    let suggestionIndex = -1;

    // ‚îÄ‚îÄ NOVO: ESTADO DO CAIXA ‚îÄ‚îÄ
    let cashierSession = null;
    let cashMovements = [];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUN√á√ïES UTILIT√ÅRIAS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function formatCurrency(val) {
        return `R$ ${parseFloat(val).toFixed(2).replace('.', ',')}`;
    }

    function formatDocument(doc) {
        const c = doc.replace(/\D/g,'');
        if(c.length===11) return c.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4');
        if(c.length===14) return c.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,'$1.$2.$3/$4-$5');
        return doc;
    }

    function formatPhone(p) {
        const c = p.replace(/\D/g,'');
        if(c.length===11) return c.replace(/(\d{2})(\d{5})(\d{4})/,'($1) $2-$3');
        if(c.length===10) return c.replace(/(\d{2})(\d{4})(\d{4})/,'($1) $2-$3');
        return p;
    }

    function getCatName(k) {
        return {
            alimento:'üçî Alimento',
            bebida:'ü•§ Bebida',
            limpeza:'üßº Limpeza',
            eletronico:'üì± Eletr√¥nico',
            vestuario:'üëï Vestu√°rio',
            outro:'üì¶ Outro'
        }[k]||k;
    }

    function now() { 
        return new Date().toISOString().slice(0,10); 
    }

    function nowDateTime() {
        return new Date().toLocaleString('pt-BR');
    }

    function dlCSV(csv,fn) {
        const BOM='\uFEFF';
        const b=new Blob([BOM+csv],{type:'text/csv;charset=utf-8;'});
        const u=URL.createObjectURL(b);
        const a=document.createElement('a'); 
        a.href=u; 
        a.download=fn;
        document.body.appendChild(a); 
        a.click(); 
        document.body.removeChild(a);
        URL.revokeObjectURL(u);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PART√çCULAS M√ÅGICAS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function createMagicParticles() {
        const container = document.getElementById('particlesContainer');
        if (!container) return;
        const colors = ['#6c5ce7','#00cec9','#fd79a8','#fdcb6e','#a29bfe','#55efc4'];
        for (let i = 0; i < 24; i++) {
            const p = document.createElement('div');
            p.className = 'magic-particle';
            const size = Math.random() * 12 + 4;
            const dur  = Math.random() * 18 + 10;
            const del  = Math.random() * 10;
            p.style.cssText = `
                width:${size}px; height:${size}px;
                left:${Math.random()*100}vw;
                background:${colors[Math.floor(Math.random()*colors.length)]};
                animation-duration:${dur}s;
                animation-delay:${del}s;
                opacity:0;
            `;
            container.appendChild(p);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SUPABASE INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function initSB() {
        try {
            if (window.supabase && window.supabase.createClient) {
                sb = window.supabase.createClient(SB_URL, SB_KEY);
                useLocal = false;
                console.log('‚úÖ Supabase Auth pronto');
            } else { 
                throw new Error('lib n√£o carregada'); 
            }
        } catch(e) {
            console.warn('‚ö†Ô∏è Supabase indispon√≠vel ‚Äî localStorage:', e.message);
            useLocal = true;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AUTENTICA√á√ÉO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showLogin() { 
        document.getElementById('loginCard').style.display='block'; 
        document.getElementById('registerCard').style.display='none'; 
    }

    function showRegister() { 
        document.getElementById('loginCard').style.display='none'; 
        document.getElementById('registerCard').style.display='block'; 
    }

    function showErr(id, msg) { 
        const el=document.getElementById(id); 
        el.textContent=msg; 
        el.classList.add('show'); 
    }

    function hideErr(id) { 
        document.getElementById(id).classList.remove('show'); 
    }

    async function loginUser() {
        hideErr('loginError');
        const email = document.getElementById('loginEmail').value.trim();
        const pass  = document.getElementById('loginPassword').value;
        
        if (!email || !pass) { 
            showErr('loginError','Preencha email e senha.'); 
            return; 
        }
        
        const btn = document.getElementById('loginBtn');
        btn.disabled=true; 
        btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Entrando...';
        showLoader();
        
        try {
            if (useLocal) { 
                loginLocal(email,pass); 
            } else { 
                await loginSupabase(email,pass); 
            }
        } catch(e) {
            hideLoader();
            btn.disabled=false; 
            btn.innerHTML='<i class="fas fa-sign-in-alt"></i> Entrar no Sistema';
            showErr('loginError', e.message);
        }
    }

    async function loginSupabase(email, pass) {
        const { data, error } = await sb.auth.signInWithPassword({ 
            email, 
            password: pass 
        });
        
        if (error) {
            let msg = 'Email ou senha incorretos.';
            if (error.message.includes('Email not confirmed')) {
                msg = 'Confirme seu email antes de fazer login.';
            }
            throw new Error(msg);
        }
        
        const { data: profile } = await sb
            .from('profiles')
            .select('*')
            .eq('id', data.user.id)
            .single();
        
        currentUser = {
            id: data.user.id, 
            email: data.user.email,
            companyName: profile?.company_name || 'Empresa',
            document: profile?.document || '', 
            phone: profile?.phone || '',
            plan: profile?.plan || 'professional',
            isTrial: profile?.is_trial ?? true,
            validUntil: profile?.valid_until || new Date(Date.now()+TRIAL_DAYS*86400000).toISOString(),
            source: 'supabase'
        };
        
        afterLogin();
    }

    function loginLocal(email, pass) {
        const users = JSON.parse(localStorage.getItem('pdv_users')||'[]');
        const u = users.find(x => x.email===email && x.password===pass);
        
        if (!u) throw new Error('Email ou senha incorretos.');
        if (new Date() > new Date(u.validUntil)) {
            throw new Error('Assinatura expirada.');
        }
        
        currentUser = {...u, source:'local'};
        afterLogin();
    }

    async function registerUser() {
        hideErr('registerError');
        const company = document.getElementById('regCompany').value.trim();
        const doc     = document.getElementById('regDocument').value.trim();
        const phone   = document.getElementById('regPhone').value.trim();
        const email   = document.getElementById('regEmail').value.trim();
        const pass    = document.getElementById('regPassword').value;
        const pass2   = document.getElementById('regConfirmPassword').value;
        const terms   = document.getElementById('regTerms').checked;
        
        if (!company||!doc||!phone||!email||!pass||!pass2) { 
            showErr('registerError','Preencha todos os campos.'); 
            return; 
        }
        if (pass !== pass2) { 
            showErr('registerError','As senhas n√£o coincidem.'); 
            return; 
        }
        if (pass.length < 6) { 
            showErr('registerError','Senha m√≠nima: 6 caracteres.'); 
            return; 
        }
        if (!terms) { 
            showErr('registerError','Aceite os termos de uso.'); 
            return; 
        }
        
        const btn = document.getElementById('registerBtn');
        btn.disabled=true; 
        btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Criando conta...';
        showLoader();
        
        try {
            if (useLocal) { 
                registerLocal({company,doc,phone,email,pass}); 
            } else { 
                await registerSupabase({company,doc,phone,email,pass}); 
            }
        } catch(e) {
            hideLoader();
            btn.disabled=false; 
            btn.innerHTML='<i class="fas fa-rocket"></i> Come√ßar Per√≠odo Gr√°tis';
            showErr('registerError', e.message);
        }
    }

    async function registerSupabase({company,doc,phone,email,pass}) {
        const trialEnd = new Date(Date.now()+TRIAL_DAYS*86400000).toISOString();
        
        const { data, error } = await sb.auth.signUp({ 
            email, 
            password: pass 
        });
        
        if (error) {
            let msg = error.message;
            if (msg.includes('already registered')) {
                msg = 'Este email j√° est√° cadastrado.';
            }
            throw new Error(msg);
        }
        
        const uid = data.user.id;
        
        // Criar perfil
        await sb.from('profiles').upsert({
            id: uid,
            company_name: company,
            document: doc,
            phone: phone,
            plan: 'professional',
            is_trial: true,
            valid_until: trialEnd
        });
        
        // Inserir produtos padr√£o
        const prods = DEFAULT_PRODUCTS.map(p=>({
            ...p,
            id: undefined,
            user_id: uid
        }));
        await sb.from('products').insert(prods);
        
        hideLoader();
        showToast('Conta criada! Verifique seu email para confirmar. üìß','info',8000);
        showLogin();
        document.getElementById('loginEmail').value = email;
        document.getElementById('registerBtn').disabled=false;
        document.getElementById('registerBtn').innerHTML='<i class="fas fa-rocket"></i> Come√ßar Per√≠odo Gr√°tis';
    }

    function registerLocal({company,doc,phone,email,pass}) {
        const users = JSON.parse(localStorage.getItem('pdv_users')||'[]');
        if (users.find(u=>u.email===email)) {
            throw new Error('Email j√° cadastrado.');
        }
        
        const trialEnd = new Date(Date.now()+TRIAL_DAYS*86400000).toISOString();
        const uid = 'LOCAL_'+Date.now();
        
        const newUser = {
            id: uid,
            email: email,
            password: pass,
            companyName: company,
            document: doc,
            phone: phone,
            plan: 'professional',
            isTrial: true,
            validUntil: trialEnd,
            createdAt: new Date().toISOString()
        };
        
        users.push(newUser);
        localStorage.setItem('pdv_users',JSON.stringify(users));
        localStorage.setItem('pdv_data_'+uid, JSON.stringify({
            products: DEFAULT_PRODUCTS,
            salesHistory: [],
            cashierSessions: [],
            cashMovements: []
        }));
        
        hideLoader();
        showToast('Conta criada com sucesso! Fazendo login... üéâ','success');
        setTimeout(()=>{
            document.getElementById('loginEmail').value=email; 
            document.getElementById('loginPassword').value=pass; 
            loginUser();
        },1200);
    }

    function afterLogin() {
        loadUserData();
        document.getElementById('authContainer').style.display='none';
        document.getElementById('appContainer').style.display='grid';
        updateSubscriptionStatus();
        initApp();
        showToast(`Bem-vindo, ${currentUser.companyName}! üëã`,'success');
    }

    async function loadUserData() {
        if (useLocal || currentUser.source==='local') {
            const d = JSON.parse(localStorage.getItem('pdv_data_'+currentUser.id)||'null');
            products = d?.products || DEFAULT_PRODUCTS;
            salesHistory = d?.salesHistory || [];
            cashMovements = d?.cashMovements || [];
            
            // Recuperar sess√£o de caixa aberta
            const sessions = d?.cashierSessions || [];
            cashierSession = sessions.find(s => !s.closedAt) || null;
        } else {
            try {
                // Carregar produtos
                const {data:prods} = await sb
                    .from('products')
                    .select('*')
                    .eq('user_id',currentUser.id);
                products = prods?.length ? prods : DEFAULT_PRODUCTS;
                
                // Carregar vendas
                const {data:sales} = await sb
                    .from('sales')
                    .select('*')
                    .eq('user_id',currentUser.id)
                    .order('created_at',{ascending:false})
                    .limit(100);
                salesHistory = sales || [];
                
                // Carregar sess√µes de caixa
                const {data:sessions} = await sb
                    .from('cashier_sessions')
                    .select('*')
                    .eq('user_id',currentUser.id)
                    .order('opened_at',{ascending:false})
                    .limit(10);
                
                // Verificar se h√° caixa aberto
                cashierSession = sessions?.find(s => !s.closed_at) || null;
                
                // Carregar movimenta√ß√µes do caixa atual
                if (cashierSession) {
                    const {data:movements} = await sb
                        .from('cash_movements')
                        .select('*')
                        .eq('session_id', cashierSession.id)
                        .order('created_at',{ascending:false});
                    cashMovements = movements || [];
                }
            } catch(e) { 
                console.error('Erro ao carregar dados:', e);
                products = DEFAULT_PRODUCTS; 
                salesHistory = []; 
            }
        }
    }

    async function saveData() {
        if (!currentUser) return;
        
        if (useLocal || currentUser.source==='local') {
            // Salvar localmente
            const sessions = JSON.parse(localStorage.getItem('pdv_data_'+currentUser.id)||'{}').cashierSessions || [];
            
            // Atualizar ou adicionar sess√£o atual
            if (cashierSession) {
                const idx = sessions.findIndex(s => s.id === cashierSession.id);
                if (idx >= 0) {
                    sessions[idx] = cashierSession;
                } else {
                    sessions.push(cashierSession);
                }
            }
            
            localStorage.setItem('pdv_data_'+currentUser.id, JSON.stringify({
                products,
                salesHistory,
                cashierSessions: sessions,
                cashMovements
            }));
        } else {
            // Salvar no Supabase
            try {
                // Salvar produtos modificados
                for (const p of products) {
                    if (p.id && !String(p.id).startsWith('LOCAL')) {
                        await sb
                            .from('products')
                            .upsert({...p,user_id:currentUser.id})
                            .catch(()=>{});
                    }
                }
            } catch(e) {
                console.error('Erro ao salvar no Supabase:', e);
            }
        }
    }

    async function logout() {
        if (!confirm('Sair do sistema?')) return;
        
        await saveData();
        
        if (!useLocal && currentUser?.source!=='local') {
            await sb.auth.signOut().catch(()=>{});
        }
        
        currentUser=null; 
        cart=[]; 
        products=[]; 
        salesHistory=[];
        cashierSession=null;
        cashMovements=[];
        stopSaleTimer();
        
        document.getElementById('appContainer').style.display='none';
        document.getElementById('authContainer').style.display='flex';
        document.getElementById('loginCard').style.display='block';
        document.getElementById('registerCard').style.display='none';
        document.getElementById('loginPassword').value='';
        document.getElementById('accountModal').style.display='none';
        
        showToast('At√© logo! üëã','info');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // APP INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function initApp() {
        setTimeout(()=>{
            renderAll();
            setupBarcodeScanner();
            setupKeyboard();
            checkLowStock();
            startSaleTimer();
            updateCashierUI();
            hideLoader();
        },600);
        
        setInterval(saveData, 30000); // Auto-save a cada 30s
        setInterval(checkLowStock, 10000);
    }

    function renderAll() { 
        renderPOS(); 
        renderStock(); 
        updateDashboard(); 
        generateSalesChart(); 
    }

    // ‚îÄ‚îÄ NAVEGA√á√ÉO ‚îÄ‚îÄ
    function switchTab(tab) {
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach((b,i)=>{
            b.classList.remove('active');
            if(['pdv','stock','dashboard','cashier'][i]===tab){
                b.classList.add('active');
                b.classList.add('pop');
                setTimeout(()=>b.classList.remove('pop'),400);
            }
        });
        
        document.getElementById(tab).classList.add('active');
        
        if(tab==='dashboard'){
            updateDashboard();
            generateSalesChart();
        }
        if(tab==='pdv'){
            setTimeout(()=>{
                document.getElementById('barcodeInput').focus();
            },100);
        }
        if(tab==='stock'){
            filterStockTable();
        }
        if(tab==='cashier'){
            updateCashierUI();
            renderCashMovements();
        }
    }

    // ‚îÄ‚îÄ SUBSCRIPTION ‚îÄ‚îÄ
    function updateSubscriptionStatus() {
        if (!currentUser) return;
        
        const el = document.getElementById('subscriptionStatus');
        const daysLeft = Math.ceil((new Date(currentUser.validUntil)-new Date())/(86400000));
        
        if (currentUser.isTrial) {
            el.innerHTML=`<i class="fas fa-star"></i><span>Trial: ${daysLeft}d restantes</span>`;
            el.style.background = daysLeft<=3?'var(--danger)':'var(--warning)';
            el.style.color = daysLeft<=3?'white':'var(--text)';
            
            if(daysLeft<=3) {
                showToast(`‚ö†Ô∏è Seu trial vence em ${daysLeft} dia${daysLeft===1?'':'s'}!`,'warning',5000);
            }
        } else {
            el.innerHTML=`<i class="fas fa-crown"></i><span>Plano Ativo</span>`;
            el.style.background='var(--success)'; 
            el.style.color='white';
        }
    }

    function openAccountModal() {
        if (!currentUser) return;
        
        document.getElementById('accountCompanyName').textContent = currentUser.companyName;
        document.getElementById('accountEmail').textContent = currentUser.email;
        document.getElementById('accountDocument').textContent = formatDocument(currentUser.document||'');
        document.getElementById('accountValidUntil').textContent = new Date(currentUser.validUntil).toLocaleDateString('pt-BR');
        document.getElementById('accountPlanStatus').textContent = currentUser.isTrial?'TRIAL (7 dias gr√°tis)':'PROFISSIONAL';
        
        const mb = document.getElementById('modeBadge');
        mb.textContent = useLocal||currentUser.source==='local'?'üíæ Modo Local (Offline)':'‚òÅÔ∏è Modo Nuvem (Supabase)';
        mb.className = 'mode-badge '+(useLocal||currentUser.source==='local'?'mode-local':'mode-cloud');
        
        document.getElementById('accountModal').style.display='flex';
    }

    function showTermsModal() {
        alert(`TERMOS DE USO ‚Äî ${APP_NAME} v${APP_VER}\n\n` +
        `1. Per√≠odo de Teste: ${TRIAL_DAYS} dias gratuitos\n` +
        `2. Assinatura: R$ ${PRICE.toFixed(2)}/m√™s ap√≥s o trial\n` +
        `3. Cancelamento: a qualquer momento pelo sistema\n` +
        `4. Dados: armazenados ${useLocal?'localmente':'na nuvem'}\n` +
        `5. Suporte: dispon√≠vel 24/7\n\n` +
        `Ao se cadastrar, voc√™ concorda com estes termos.`);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONTROLE DE CAIXA (NOVO)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function updateCashierUI() {
        const isOpen = cashierSession && !cashierSession.closedAt;
        
        // Atualizar badge no PDV
        const badge = document.getElementById('cashierStatusBadge');
        if (isOpen) {
            badge.style.display = 'flex';
            badge.className = 'stat-badge cashier-open';
            badge.innerHTML = '<i class="fas fa-lock-open"></i><span>Caixa Aberto</span>';
        } else {
            badge.style.display = 'flex';
            badge.className = 'stat-badge cashier-closed';
            badge.innerHTML = '<i class="fas fa-lock"></i><span>Caixa Fechado</span>';
        }
        
        // Atualizar p√°gina de caixa
        const statusBadge = document.getElementById('cashierStatusBadgeFull');
        const openActions = document.getElementById('cashierActionsOpen');
        const closeActions = document.getElementById('cashierActionsClose');
        const details = document.getElementById('cashierDetails');
        
        if (isOpen) {
            statusBadge.className = 'cashier-status-badge cashier-open';
            statusBadge.innerHTML = '<i class="fas fa-lock-open"></i><span>Caixa Aberto</span>';
            openActions.style.display = 'none';
            closeActions.style.display = 'flex';
            details.style.display = 'block';
            
            // Preencher detalhes
            document.getElementById('cashierOperator').textContent = cashierSession.operator;
            document.getElementById('cashierOpenTime').textContent = new Date(cashierSession.openedAt).toLocaleString('pt-BR');
            document.getElementById('cashierInitial').textContent = formatCurrency(cashierSession.initialAmount);
            document.getElementById('cashierCurrent').textContent = formatCurrency(calculateCurrentBalance());
            
            // Desabilitar bot√£o de venda se caixa fechado
            const checkoutBtn = document.getElementById('btnCheckout');
            if (checkoutBtn && !checkoutBtn.disabled) {
                checkoutBtn.disabled = false;
            }
        } else {
            statusBadge.className = 'cashier-status-badge cashier-closed';
            statusBadge.innerHTML = '<i class="fas fa-lock"></i><span>Caixa Fechado</span>';
            openActions.style.display = 'flex';
            closeActions.style.display = 'none';
            details.style.display = 'none';
            
            // Desabilitar vendas quando caixa est√° fechado
            const checkoutBtn = document.getElementById('btnCheckout');
            if (checkoutBtn && cart.length > 0) {
                // N√£o desabilitar automaticamente - permitir vendas sem caixa aberto
                // checkoutBtn.disabled = true;
            }
        }
        
        updateCashierStats();
    }

    function calculateCurrentBalance() {
        if (!cashierSession) return 0;
        
        let balance = cashierSession.initialAmount;
        
        // Adicionar vendas
        const sessionSales = salesHistory.filter(s => 
            s.cashierSessionId === cashierSession.id
        );
        balance += sessionSales.reduce((sum, s) => sum + s.total, 0);
        
        // Adicionar suprimentos
        const supplies = cashMovements.filter(m => 
            m.sessionId === cashierSession.id && m.type === 'supply'
        );
        balance += supplies.reduce((sum, m) => sum + m.amount, 0);
        
        // Subtrair sangrias
        const withdrawals = cashMovements.filter(m => 
            m.sessionId === cashierSession.id && m.type === 'withdrawal'
        );
        balance -= withdrawals.reduce((sum, m) => sum + m.amount, 0);
        
        return balance;
    }

    function openCashierModal() {
        document.getElementById('cashierOperatorInput').value = currentUser.companyName;
        document.getElementById('cashierInitialAmount').value = '';
        document.getElementById('cashierOpenNotes').value = '';
        document.getElementById('cashierOpenModal').style.display = 'flex';
    }

    function closeCashierOpenModal() {
        document.getElementById('cashierOpenModal').style.display = 'none';
    }

    async function confirmOpenCashier() {
        const amount = parseFloat(document.getElementById('cashierInitialAmount').value);
        const notes = document.getElementById('cashierOpenNotes').value.trim();
        
        if (isNaN(amount) || amount < 0) {
            showToast('Digite um valor v√°lido para o saldo inicial', 'error');
            return;
        }
        
        showLoader();
        
        try {
            const sessionId = 'CASH_' + Date.now();
            cashierSession = {
                id: sessionId,
                userId: currentUser.id,
                operator: currentUser.companyName,
                openedAt: new Date().toISOString(),
                closedAt: null,
                initialAmount: amount,
                finalAmount: null,
                notes: notes,
                closeNotes: null
            };
            
            if (!useLocal && currentUser.source !== 'local') {
                // Salvar no Supabase
                await sb.from('cashier_sessions').insert({
                    id: sessionId,
                    user_id: currentUser.id,
                    operator: cashierSession.operator,
                    opened_at: cashierSession.openedAt,
                    initial_amount: amount,
                    notes: notes
                });
            }
            
            await saveData();
            updateCashierUI();
            closeCashierOpenModal();
            hideLoader();
            showToast('‚úÖ Caixa aberto com sucesso!', 'success');
        } catch (error) {
            hideLoader();
            showToast('Erro ao abrir caixa: ' + error.message, 'error');
        }
    }

    function closeCashierModal() {
        if (!cashierSession) return;
        
        // Calcular totais
        const sessionSales = salesHistory.filter(s => 
            s.cashierSessionId === cashierSession.id
        );
        const totalSales = sessionSales.reduce((sum, s) => sum + s.total, 0);
        
        const supplies = cashMovements.filter(m => 
            m.sessionId === cashierSession.id && m.type === 'supply'
        );
        const totalSupplies = supplies.reduce((sum, m) => sum + m.amount, 0);
        
        const withdrawals = cashMovements.filter(m => 
            m.sessionId === cashierSession.id && m.type === 'withdrawal'
        );
        const totalWithdrawals = withdrawals.reduce((sum, m) => sum + m.amount, 0);
        
        const finalBalance = cashierSession.initialAmount + totalSales + totalSupplies - totalWithdrawals;
        
        // Preencher modal
        document.getElementById('closeCashierInitial').textContent = formatCurrency(cashierSession.initialAmount);
        document.getElementById('closeCashierSales').textContent = formatCurrency(totalSales);
        document.getElementById('closeCashierSupplies').textContent = formatCurrency(totalSupplies);
        document.getElementById('closeCashierWithdrawals').textContent = formatCurrency(totalWithdrawals);
        document.getElementById('closeCashierFinal').textContent = formatCurrency(finalBalance);
        document.getElementById('cashierCloseNotes').value = '';
        
        document.getElementById('cashierCloseModal').style.display = 'flex';
    }

    function closeCashierCloseModal() {
        document.getElementById('cashierCloseModal').style.display = 'none';
    }

    async function confirmCloseCashier() {
        const closeNotes = document.getElementById('cashierCloseNotes').value.trim();
        
        if (!confirm('Confirma o fechamento do caixa? Esta a√ß√£o n√£o pode ser desfeita.')) {
            return;
        }
        
        showLoader();
        
        try {
            const finalBalance = calculateCurrentBalance();
            
            cashierSession.closedAt = new Date().toISOString();
            cashierSession.finalAmount = finalBalance;
            cashierSession.closeNotes = closeNotes;
            
            if (!useLocal && currentUser.source !== 'local') {
                // Atualizar no Supabase
                await sb.from('cashier_sessions')
                    .update({
                        closed_at: cashierSession.closedAt,
                        final_amount: finalBalance,
                        close_notes: closeNotes
                    })
                    .eq('id', cashierSession.id);
            }
            
            await saveData();
            
            // Limpar sess√£o atual
            cashierSession = null;
            
            updateCashierUI();
            closeCashierCloseModal();
            hideLoader();
            showToast('‚úÖ Caixa fechado com sucesso!', 'success');
        } catch (error) {
            hideLoader();
            showToast('Erro ao fechar caixa: ' + error.message, 'error');
        }
    }

    function openWithdrawalModal() {
        if (!cashierSession) {
            showToast('Abra o caixa primeiro', 'warning');
            return;
        }
        
        document.getElementById('withdrawalAmount').value = '';
        document.getElementById('withdrawalReason').value = '';
        document.getElementById('withdrawalModal').style.display = 'flex';
    }

    function closeWithdrawalModal() {
        document.getElementById('withdrawalModal').style.display = 'none';
    }

    async function confirmWithdrawal() {
        const amount = parseFloat(document.getElementById('withdrawalAmount').value);
        const reason = document.getElementById('withdrawalReason').value.trim();
        
        if (isNaN(amount) || amount <= 0) {
            showToast('Digite um valor v√°lido', 'error');
            return;
        }
        
        if (!reason) {
            showToast('Informe o motivo da sangria', 'error');
            return;
        }
        
        const currentBalance = calculateCurrentBalance();
        if (amount > currentBalance) {
            showToast('Saldo insuficiente no caixa', 'error');
            return;
        }
        
        showLoader();
        
        try {
            const movement = {
                id: 'MOV_' + Date.now(),
                sessionId: cashierSession.id,
                type: 'withdrawal',
                amount: amount,
                reason: reason,
                createdAt: new Date().toISOString(),
                operator: currentUser.companyName
            };
            
            cashMovements.unshift(movement);
            
            if (!useLocal && currentUser.source !== 'local') {
                await sb.from('cash_movements').insert({
                    id: movement.id,
                    session_id: cashierSession.id,
                    type: 'withdrawal',
                    amount: amount,
                    reason: reason,
                    operator: currentUser.companyName
                });
            }
            
            await saveData();
            updateCashierUI();
            renderCashMovements();
            closeWithdrawalModal();
            hideLoader();
            showToast('‚úÖ Sangria registrada!', 'success');
        } catch (error) {
            hideLoader();
            showToast('Erro ao registrar sangria: ' + error.message, 'error');
        }
    }

    function openSupplyModal() {
        if (!cashierSession) {
            showToast('Abra o caixa primeiro', 'warning');
            return;
        }
        
        document.getElementById('supplyAmount').value = '';
        document.getElementById('supplyReason').value = '';
        document.getElementById('supplyModal').style.display = 'flex';
    }

    function closeSupplyModal() {
        document.getElementById('supplyModal').style.display = 'none';
    }

    async function confirmSupply() {
        const amount = parseFloat(document.getElementById('supplyAmount').value);
        const reason = document.getElementById('supplyReason').value.trim();
        
        if (isNaN(amount) || amount <= 0) {
            showToast('Digite um valor v√°lido', 'error');
            return;
        }
        
        if (!reason) {
            showToast('Informe o motivo do suprimento', 'error');
            return;
        }
        
        showLoader();
        
        try {
            const movement = {
                id: 'MOV_' + Date.now(),
                sessionId: cashierSession.id,
                type: 'supply',
                amount: amount,
                reason: reason,
                createdAt: new Date().toISOString(),
                operator: currentUser.companyName
            };
            
            cashMovements.unshift(movement);
            
            if (!useLocal && currentUser.source !== 'local') {
                await sb.from('cash_movements').insert({
                    id: movement.id,
                    session_id: cashierSession.id,
                    type: 'supply',
                    amount: amount,
                    reason: reason,
                    operator: currentUser.companyName
                });
            }
            
            await saveData();
            updateCashierUI();
            renderCashMovements();
            closeSupplyModal();
            hideLoader();
            showToast('‚úÖ Suprimento registrado!', 'success');
        } catch (error) {
            hideLoader();
            showToast('Erro ao registrar suprimento: ' + error.message, 'error');
        }
    }

    function renderCashMovements() {
        const container = document.getElementById('cashMovementsList');
        
        if (!cashierSession || cashMovements.length === 0) {
            container.innerHTML = `
                <div style="text-align:center;color:#b2bec3;padding:40px">
                    <i class="fas fa-exchange-alt" style="font-size:2rem;opacity:.4;display:block;margin-bottom:10px"></i>
                    Nenhuma movimenta√ß√£o registrada
                </div>
            `;
            return;
        }
        
        const sessionMovements = cashMovements.filter(m => m.sessionId === cashierSession.id);
        
        container.innerHTML = sessionMovements.map(m => `
            <div class="cash-movement-card ${m.type}">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                    <div>
                        <strong style="font-size:1.1rem">
                            ${m.type === 'withdrawal' ? '‚ûñ' : '‚ûï'} 
                            ${formatCurrency(m.amount)}
                        </strong>
                        <div style="font-size:.85rem;color:#636e72;margin-top:4px">
                            ${m.type === 'withdrawal' ? 'Sangria' : 'Suprimento'}
                        </div>
                    </div>
                    <div style="text-align:right;font-size:.85rem;color:#636e72">
                        ${new Date(m.createdAt).toLocaleString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}
                    </div>
                </div>
                <div style="font-size:.9rem;color:var(--text)">
                    <strong>Motivo:</strong> ${m.reason}
                </div>
                <div style="font-size:.85rem;color:#636e72;margin-top:4px">
                    <strong>Operador:</strong> ${m.operator}
                </div>
            </div>
        `).join('');
    }

    function updateCashierStats() {
        if (!cashierSession) {
            document.getElementById('cashierTotalSales').textContent = 'R$ 0,00';
            document.getElementById('cashierTotalWithdrawals').textContent = 'R$ 0,00';
            document.getElementById('cashierTotalSupplies').textContent = 'R$ 0,00';
            return;
        }
        
        const sessionSales = salesHistory.filter(s => 
            s.cashierSessionId === cashierSession.id
        );
        const totalSales = sessionSales.reduce((sum, s) => sum + s.total, 0);
        
        const supplies = cashMovements.filter(m => 
            m.sessionId === cashierSession.id && m.type === 'supply'
        );
        const totalSupplies = supplies.reduce((sum, m) => sum + m.amount, 0);
        
        const withdrawals = cashMovements.filter(m => 
            m.sessionId === cashierSession.id && m.type === 'withdrawal'
        );
        const totalWithdrawals = withdrawals.reduce((sum, m) => sum + m.amount, 0);
        
        document.getElementById('cashierTotalSales').textContent = formatCurrency(totalSales);
        document.getElementById('cashierTotalWithdrawals').textContent = formatCurrency(totalWithdrawals);
        document.getElementById('cashierTotalSupplies').textContent = formatCurrency(totalSupplies);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CRON√îMETRO DE VENDA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function startSaleTimer() {
        stopSaleTimer();
        saleStartTime = Date.now();
        saleTimerInterval = setInterval(updateTimerDisplay, 1000);
        updateTimerDisplay();
    }

    function stopSaleTimer() {
        if (saleTimerInterval) { 
            clearInterval(saleTimerInterval); 
            saleTimerInterval=null; 
        }
    }

    function updateTimerDisplay() {
        const el = document.getElementById('liveSaleTimer');
        if (!el || !saleStartTime) return;
        
        const elapsed = Math.floor((Date.now()-saleStartTime)/1000);
        const m = Math.floor(elapsed/60).toString().padStart(2,'0');
        const s = (elapsed%60).toString().padStart(2,'0');
        el.textContent = `${m}:${s}`;
    }

    function getSaleProcessingTime() {
        if(!saleStartTime) return '0s';
        return ((Date.now()-saleStartTime)/1000).toFixed(1)+'s';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PDV / CARRINHO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderPOS() {
        const grid = document.getElementById('productsGrid');
        grid.innerHTML='';
        
        products.forEach(p=>{
            const sc = p.stock<3?'stock-low':p.stock<10?'stock-medium':'stock-high';
            const inCart = (cart.find(i=>i.id===p.id)||{qty:0}).qty;
            const card = document.createElement('div');
            card.className='product-card';
            card.setAttribute('data-product-id',p.id);
            card.onclick=()=>addToCart(p.id);
            card.innerHTML=`
                <span class="product-stock ${sc}">${p.stock}</span>
                <span class="product-emoji floating">${p.emoji}</span>
                <div class="product-name">${p.name}</div>
                ${p.category?`<div class="product-category">${getCatName(p.category)}</div>`:''}
                <div class="product-price">R$ ${p.price.toFixed(2)}</div>
                ${inCart>0?`<div style="margin-top:8px;background:var(--primary);color:white;padding:4px 10px;border-radius:10px;font-size:.8rem;font-weight:700">${inCart} no carrinho</div>`:''}
            `;
            grid.appendChild(card);
        });
    }

    function addToCart(id) {
        const p = products.find(x=>x.id===id);
        if (!p) return;
        
        const ci = cart.find(i=>i.id===id);
        const currentQtyInCart = ci ? ci.qty : 0;
        
        if (p.stock <= currentQtyInCart) {
            showToast(`‚ö†Ô∏è Estoque insuficiente de "${p.name}". Dispon√≠vel: ${p.stock}`, 'warning');
            return;
        }
        
        if (ci) ci.qty++; 
        else cart.push({...p, qty:1});

        highlightProductCard(id);
        updateCartUI();
        updateNotifications();
        showToast(`‚úÖ ${p.name} adicionado!`, 'success', 1800);
    }

    function highlightProductCard(id) {
        const card = document.querySelector(`[data-product-id="${id}"]`);
        if (!card) return;
        
        card.classList.add('highlight-add');
        const navBtn = document.querySelectorAll('.nav-btn')[0];
        navBtn.classList.add('pop');
        
        setTimeout(()=>{ 
            card.classList.remove('highlight-add'); 
            navBtn.classList.remove('pop'); 
        }, 650);
    }

    function removeFromCart(id, all=false) {
        const idx=cart.findIndex(i=>i.id===id);
        if(idx<0) return;
        
        const it=cart[idx];
        if(all||it.qty<=1) cart.splice(idx,1); 
        else it.qty--;
        
        updateCartUI(); 
        updateNotifications();
    }

    function updateCartItemQty(id, qty) {
        if(qty<1){
            removeFromCart(id,true);
            return;
        }
        
        const ci=cart.find(i=>i.id===id);
        const p=products.find(x=>x.id===id);
        
        if(ci&&p&&qty<=p.stock){
            ci.qty=qty;
            updateCartUI();
        } else {
            showToast('Quantidade superior ao estoque dispon√≠vel','warning');
        }
    }

    function clearCart() {
        if(!cart.length) return;
        
        if(confirm('Limpar carrinho? Todos os itens ser√£o removidos.')){
            cart=[]; 
            currentDiscount=0;
            updateCartUI(); 
            updateNotifications();
            showToast('Carrinho limpo','info');
        }
    }

    function removeDiscount() {
        currentDiscount=0;
        updateCartUI();
        showToast('Desconto removido','info');
    }

    function updateCartUI() {
        const container=document.getElementById('cartItems');
        const totalEl=document.getElementById('cartTotal');
        const btn=document.getElementById('btnCheckout');
        const ccBtn=document.getElementById('clearCartBtn');
        const summary=document.getElementById('cartSummary');
        const discBanner=document.getElementById('discountBanner');

        if(!cart.length){
            container.innerHTML=`<div style="text-align:center;color:#b2bec3;margin-top:50px;padding:30px">
                <i class="fas fa-shopping-basket" style="font-size:3rem;margin-bottom:15px;opacity:.5"></i>
                <p style="font-size:1rem;margin-bottom:8px">Cesta vazia üçÉ</p>
                <p style="font-size:.85rem">Clique nos produtos ou escaneie</p>
            </div>`;
            totalEl.textContent='R$ 0,00';
            btn.disabled=true; 
            ccBtn.disabled=true;
            summary.style.display='none';
            discBanner.classList.remove('show');
            document.getElementById('liveCartCount').textContent='0 itens';
            document.getElementById('liveCartTotal').textContent='R$ 0,00';
            return;
        }

        let sub=0, html='';
        cart.forEach(it=>{
            const tot=it.price*it.qty; 
            sub+=tot;
            html+=`<div class="cart-item">
                <div class="cart-item-info">
                    <div class="cart-item-name">${it.emoji} ${it.name}</div>
                    <div style="color:#636e72;font-size:.82rem">R$ ${it.price.toFixed(2)} un</div>
                    <div class="cart-item-qty">
                        <button class="qty-btn" onclick="updateCartItemQty(${it.id},${it.qty-1})">‚àí</button>
                        <span style="font-weight:800;min-width:24px;text-align:center">${it.qty}</span>
                        <button class="qty-btn" onclick="updateCartItemQty(${it.id},${it.qty+1})">+</button>
                        <span style="margin-left:8px;color:var(--primary);font-weight:700">R$ ${tot.toFixed(2)}</span>
                    </div>
                </div>
                <div class="remove-btn" onclick="removeFromCart(${it.id},true)" title="Remover"><i class="fas fa-trash"></i></div>
            </div>`;
        });

        const disc = sub*(currentDiscount/100);
        const total = sub-disc;

        container.innerHTML=html;
        totalEl.textContent=`R$ ${total.toFixed(2)}`;
        btn.disabled=false; 
        ccBtn.disabled=false;

        summary.style.display='block';
        document.getElementById('summarySubtotal').textContent=`R$ ${sub.toFixed(2)}`;
        
        const discRow=document.getElementById('summaryDiscountRow');
        if(currentDiscount>0){
            discRow.style.display='flex';
            document.getElementById('summaryDiscountLabel').textContent=`Desconto (${currentDiscount}%):`;
            document.getElementById('summaryDiscount').textContent=`-R$ ${disc.toFixed(2)}`;
        } else { 
            discRow.style.display='none'; 
        }
        
        document.getElementById('summaryTotal').textContent=`R$ ${total.toFixed(2)}`;

        if(currentDiscount>0){
            discBanner.classList.add('show');
            document.getElementById('discountBannerText').textContent=`üéâ Desconto de ${currentDiscount}% aplicado (‚àíR$ ${disc.toFixed(2)})`;
        } else { 
            discBanner.classList.remove('show'); 
        }

        const totalItems=cart.reduce((a,i)=>a+i.qty,0);
        document.getElementById('liveCartCount').textContent=`${totalItems} ${totalItems===1?'item':'itens'}`;
        document.getElementById('liveCartTotal').textContent=`R$ ${total.toFixed(2)}`;
    }

    // ‚îÄ‚îÄ SISTEMA DE DESCONTOS ‚îÄ‚îÄ
    function applyDiscount(pct=null) {
        if(!cart.length){
            showToast('Adicione produtos primeiro','warning');
            return;
        }
        
        if(pct===null){
            const v=prompt(`Desconto percentual (0-100):\nDesconto atual: ${currentDiscount}%`,'');
            if(v===null) return;
            pct=parseFloat(v);
            
            if(isNaN(pct)||pct<0||pct>100){
                showToast('Valor inv√°lido (0-100)','error');
                return;
            }
        }
        
        currentDiscount=pct;
        updateCartUI();
        
        if(pct>0) showToast(`üéâ Desconto de ${pct}% aplicado!`,'success');
        else showToast('Desconto removido','info');
    }

    function applyDiscountToSale(p){
        applyDiscount(p);
        
        // Atualizar modal se estiver aberto
        if(document.getElementById('paymentModal').style.display==='flex'){
            const sub=cart.reduce((a,i)=>a+i.price*i.qty,0);
            const disc=sub*(currentDiscount/100);
            const total=sub-disc;
            document.getElementById('modalSubtotal').textContent=`R$ ${sub.toFixed(2)}`;
            document.getElementById('modalDiscount').textContent=`‚àíR$ ${disc.toFixed(2)}`;
            document.getElementById('modalTotalValue').textContent=`R$ ${total.toFixed(2)}`;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PAGAMENTO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function openPaymentModal() {
        if(!cart.length){
            showToast('Carrinho vazio','warning');
            return;
        }
        
        const sub=cart.reduce((a,i)=>a+i.price*i.qty,0);
        const disc=sub*(currentDiscount/100);
        const total=sub-disc;
        
        document.getElementById('modalSubtotal').textContent=`R$ ${sub.toFixed(2)}`;
        document.getElementById('modalDiscount').textContent=`‚àíR$ ${disc.toFixed(2)}`;
        document.getElementById('modalTotalValue').textContent=`R$ ${total.toFixed(2)}`;
        document.getElementById('paymentModal').style.display='flex';
    }

    function closePaymentModal(){
        document.getElementById('paymentModal').style.display='none';
    }

    async function processPayment(method) {
        closePaymentModal();
        showLoader();
        
        try {
            const processingTime = getSaleProcessingTime();
            let sub=0;
            const cartCopy=JSON.parse(JSON.stringify(cart));
            
            cartCopy.forEach(it=>{
                sub+=it.price*it.qty;
            });
            
            const disc=sub*(currentDiscount/100);
            let total=sub-disc;
            let pm=method;
            
            // Aplicar desconto do Pix
            if(method==='Pix'){
                total=total*0.95; 
                pm='Pix (5% OFF)';
            }

            const sid='V'+Date.now().toString().slice(-6);
            const sale={
                id:sid, 
                date:new Date().toLocaleString('pt-BR'), 
                timestamp:Date.now(),
                subtotal:sub, 
                discount:disc, 
                total,
                itemsCount:cartCopy.reduce((a,i)=>a+i.qty,0),
                items:cartCopy, 
                method:pm, 
                processingTime,
                cashierSessionId: cashierSession?.id || null
            };

            // Baixar estoque
            cartCopy.forEach(ci=>{
                const p=products.find(x=>x.id===ci.id);
                if(p) p.stock=Math.max(0,p.stock-ci.qty);
            });

            salesHistory.unshift(sale);
            currentSaleData=sale;
            cart=[]; 
            currentDiscount=0;
            
            await saveData();

            // Salvar no Supabase
            if(!useLocal && currentUser?.source!=='local'){
                try {
                    await sb.from('sales').insert({
                        id:sid, 
                        user_id:currentUser.id,
                        subtotal:sub, 
                        discount:disc, 
                        total,
                        items_count:sale.itemsCount,
                        payment_method:pm,
                        cashier_session_id: cashierSession?.id || null,
                        receipt_data:{items:cartCopy, processingTime}
                    });
                } catch(e){ 
                    console.warn('Venda salva apenas local:',e); 
                }
            }

            // Atualizar interface
            updateCartUI(); 
            renderPOS(); 
            renderStock();
            stopSaleTimer();
            updateCashierUI();
            
            showToast(`üéâ Venda #${sid} finalizada via ${pm}!`,'success',4000);
            updateDashboard(); 
            generateSalesChart();
            
            hideLoader();
            setTimeout(() => {
                openReceiptModal();
            }, 500);
            
        } catch (error) {
            hideLoader();
            showToast('Erro ao processar venda: ' + error.message, 'error');
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RECIBOS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function openReceiptModal(){
        if(!currentSaleData) {
            showToast('Nenhuma venda para exibir','warning');
            return;
        }
        
        document.getElementById('receiptId').textContent=currentSaleData.id;
        document.getElementById('receiptDate').textContent=currentSaleData.date;
        document.getElementById('receiptMethod').textContent=currentSaleData.method;
        document.getElementById('receiptTotal').textContent=`R$ ${currentSaleData.total.toFixed(2)}`;
        document.getElementById('receiptModal').style.display='flex';
    }

    function closeReceiptModal(){
        document.getElementById('receiptModal').style.display='none';
    }

    function newSale() {
        closeReceiptModal();
        currentSaleData = null;
        startSaleTimer();
        switchTab('pdv');
        document.getElementById('barcodeInput').focus();
        showToast('Nova venda iniciada! üöÄ','success');
    }

    function goToPdv() {
        closeReceiptModal();
        switchTab('pdv');
        document.getElementById('barcodeInput').focus();
    }

    function printReceiptFromModal(){
        if(!currentSaleData) return;
        
        const s=currentSaleData;
        const cn = currentUser?.companyName || APP_NAME;
        const win=window.open('','ThermalReceipt','width=340,height=700,toolbar=no,menubar=no,scrollbars=yes');
        
        if(!win) {
            showToast('Permita pop-ups para imprimir','warning');
            return;
        }
        
        const items=s.items.map(it=>`
            <tr><td colspan="2">${it.qty}x ${it.name}</td></tr>
            <tr><td style="padding-left:10px;color:#555">R$ ${it.price.toFixed(2)} un</td><td style="text-align:right;font-weight:bold">R$ ${(it.price*it.qty).toFixed(2)}</td></tr>
        `).join('');
        
        win.document.write(`<!DOCTYPE html><html><head>
            <meta charset="UTF-8">
            <title>Cupom - ${s.id}</title>
            <style>
                *{margin:0;padding:0;box-sizing:border-box}
                body{font-family:'Courier New',Courier,monospace;font-size:12px;width:300px;padding:15px;color:#000}
                .center{text-align:center}.bold{font-weight:bold}
                .separator{border-top:1px dashed #000;margin:8px 0}
                table{width:100%;border-collapse:collapse}
                td{padding:2px 0}
                .total-row{font-size:15px;font-weight:bold;border-top:2px solid #000;padding-top:6px;margin-top:6px}
                .footer{margin-top:15px;text-align:center;font-size:11px;color:#444}
                .logo{font-size:18px;font-weight:bold;letter-spacing:1px}
            </style>
        </head><body>
            <div class="center">
                <div class="logo">‚ú® ${cn.toUpperCase()}</div>
                <div style="font-size:10px;margin-top:3px">Sistema Profissional de Vendas</div>
                <div class="separator"></div>
                <div>CUPOM N√ÉO FISCAL</div>
                <div class="separator"></div>
            </div>
            <div>ID: <b>${s.id}</b></div>
            <div>Data: ${s.date}</div>
            <div class="separator"></div>
            <div class="bold">ITENS DA COMPRA</div>
            <div class="separator"></div>
            <table>${items}</table>
            <div class="separator"></div>
            <table>
                <tr><td>Subtotal:</td><td style="text-align:right">R$ ${s.subtotal.toFixed(2)}</td></tr>
                ${s.discount>0?`<tr><td style="color:green">Desconto:</td><td style="text-align:right;color:green">-R$ ${s.discount.toFixed(2)}</td></tr>`:''}
                <tr class="total-row"><td>TOTAL:</td><td style="text-align:right">R$ ${s.total.toFixed(2)}</td></tr>
            </table>
            <div class="separator"></div>
            <div>Pagamento: <b>${s.method}</b></div>
            <div>Processado em: ${s.processingTime}</div>
            <div class="footer">
                <div class="separator"></div>
                Obrigado pela prefer√™ncia! üåü<br>
                Volte sempre!<br>
                <div style="margin-top:8px;font-size:10px">Gerado por ${APP_NAME} v${APP_VER}</div>
            </div>
            <script>setTimeout(()=>{window.print();},300);<\/script>
        </body></html>`);
        
        win.document.close();
        showToast('üñ®Ô∏è Impress√£o iniciada!','success');
    }

    function sendViaWhatsapp(){
        if(!currentSaleData) return;
        
        const s=currentSaleData;
        const cn = currentUser?.companyName||APP_NAME;
        let t=`*‚ú® ${cn}*%0A`;
        t+=`*Comprovante de Venda*%0A`;
        t+=`ID: \`${s.id}\`%0A`;
        t+=`Data: ${s.date}%0A`;
        t+=`--------------------------------%0A`;
        t+=`*ITENS:*%0A`;
        s.items.forEach(i=>{
            t+=`${i.qty}x ${i.emoji} ${i.name}%0A  R$ ${(i.price*i.qty).toFixed(2)}%0A`;
        });
        t+=`--------------------------------%0A`;
        if(s.discount>0) t+=`Desconto: -R$ ${s.discount.toFixed(2)}%0A`;
        t+=`*TOTAL: R$ ${s.total.toFixed(2)}*%0A`;
        t+=`Pagamento: ${s.method}%0A`;
        t+=`--------------------------------%0A`;
        t+=`Obrigado pela prefer√™ncia! üåü%0AVolte sempre!`;
        
        window.open(`https://api.whatsapp.com/send?text=${t}`,'_blank');
        showToast('Comprovante preparado para WhatsApp üì±','success');
    }

    function sendViaEmail(){
        if(!currentSaleData) return;
        
        const s=currentSaleData;
        const cn = currentUser?.companyName||APP_NAME;
        let b=`${cn} ‚Äî Comprovante de Venda\n`;
        b+=`${'='.repeat(40)}\n`;
        b+=`ID da Venda: ${s.id}\n`;
        b+=`Data/Hora: ${s.date}\n`;
        b+=`Forma de Pagamento: ${s.method}\n`;
        b+=`${'‚îÄ'.repeat(40)}\n`;
        b+=`ITENS DA COMPRA:\n\n`;
        s.items.forEach(i=>{
            b+=`  ${i.qty}x ${i.name}\n     R$ ${i.price.toFixed(2)} un = R$ ${(i.price*i.qty).toFixed(2)}\n\n`;
        });
        b+=`${'‚îÄ'.repeat(40)}\n`;
        b+=`Subtotal: R$ ${s.subtotal.toFixed(2)}\n`;
        if(s.discount>0) b+=`Desconto: -R$ ${s.discount.toFixed(2)}\n`;
        b+=`TOTAL: R$ ${s.total.toFixed(2)}\n`;
        b+=`${'='.repeat(40)}\n`;
        b+=`Tempo de processamento: ${s.processingTime}\n\n`;
        b+=`Obrigado pela prefer√™ncia! üåü\nVolte sempre!\n\n`;
        b+=`‚Äî ${APP_NAME} v${APP_VER}`;
        
        window.location.href=`mailto:?subject=${encodeURIComponent(`Comprovante ${s.id} - ${cn}`)}&body=${encodeURIComponent(b)}`;
        showToast('Cliente de email aberto com comprovante üìß','info');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ESTOQUE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderStock(){
        const tbody=document.getElementById('stockTableBody');
        tbody.innerHTML='';
        
        products.forEach(p=>{
            const sc=p.stock<5?'stock-low':p.stock<15?'stock-medium':'stock-high';
            const tr=document.createElement('tr');
            tr.innerHTML=`<td><span style="font-size:1.3rem">${p.emoji}</span> ${p.name}</td>
                <td><b>R$ ${p.price.toFixed(2)}</b></td>
                <td>
                    <span class="product-stock ${sc}" style="position:static;display:inline-block">${p.stock}</span>
                    <input type="number" value="${p.stock}" onchange="updateStock(${p.id},this.value)"
                        style="width:65px;padding:5px 8px;border-radius:8px;border:1px solid #dfe6e9;margin-left:8px;min-width:unset;flex:unset">
                </td>
                <td>${getCatName(p.category)||'‚Äî'}</td>
                <td>
                    <button onclick="editProduct(${p.id})" style="background:var(--secondary);color:white;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;margin-right:5px;font-weight:700">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteProduct(${p.id})" style="background:var(--danger);color:white;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-weight:700">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>`;
            tbody.appendChild(tr);
        });
    }

    function filterStockTable(){
        const q=document.getElementById('stockSearch').value.toLowerCase();
        document.querySelectorAll('#stockTableBody tr').forEach(r=>{
            r.style.display=r.textContent.toLowerCase().includes(q)?'':'none';
        });
    }

    async function addProduct(){
        const name=document.getElementById('newProdName').value.trim();
        const price=parseFloat(document.getElementById('newProdPrice').value);
        const stock=parseInt(document.getElementById('newProdStock').value);
        const emojiVal=document.getElementById('newProdEmoji').value.trim();
        const cat=document.getElementById('newProdCategory').value||'outro';
        
        if(!name||isNaN(price)||price<=0||isNaN(stock)||stock<0){
            showToast('Preencha os campos corretamente','error');
            return;
        }
        
        let emoji='üì¶';
        if(emojiVal){
            const emojiRegex=/[\p{Emoji_Presentation}\p{Emoji}\uFE0F]/u;
            if(emojiRegex.test(emojiVal.charAt(0))) emoji=emojiVal.charAt(0);
            else {
                const found=EMOJI_DB.find(e=>e.keys.some(k=>k.includes(emojiVal.toLowerCase())));
                emoji=found?found.char:'üì¶';
            }
        }
        
        const newId=products.length?Math.max(...products.map(p=>typeof p.id==='number'?p.id:0))+1:1;
        const np={id:newId,name,price,stock,emoji,category:cat};
        
        if(!useLocal&&currentUser?.source!=='local'){
            try{
                const {data,error}=await sb.from('products')
                    .insert({...np,id:undefined,user_id:currentUser.id})
                    .select()
                    .single();
                if(!error&&data) np.id=data.id;
            }catch(e){
                console.warn('Produto salvo localmente:',e);
            }
        }
        
        products.push(np);
        await saveData();
        
        document.getElementById('newProdName').value='';
        document.getElementById('newProdPrice').value='';
        document.getElementById('newProdStock').value='';
        document.getElementById('newProdEmoji').value='';
        document.getElementById('newProdCategory').value='';
        document.getElementById('emojiPreviewBadge').textContent='üì¶';
        
        showToast(`"${name}" ${emoji} adicionado!`,'success');
        renderStock(); 
        renderPOS(); 
        checkLowStock();
    }

    function editProduct(id){
        const p=products.find(x=>x.id===id);
        if(!p) return;
        
        document.getElementById('newProdName').value=p.name;
        document.getElementById('newProdPrice').value=p.price;
        document.getElementById('newProdStock').value=p.stock;
        document.getElementById('newProdEmoji').value=p.emoji;
        document.getElementById('newProdCategory').value=p.category||'';
        document.getElementById('emojiPreviewBadge').textContent=p.emoji;
        
        const btn=document.querySelector('.btn-checkout[onclick="addProduct()"]');
        if(btn){
            btn.innerHTML='<i class="fas fa-save"></i> Salvar Altera√ß√µes';
            btn.setAttribute('onclick',`saveEdit(${id})`);
        }
        
        const formAdd=document.querySelector('.form-add');
        formAdd.scrollIntoView({behavior:'smooth'});
        showToast(`Editando: ${p.name}.`,'info');
    }

    async function saveEdit(id){
        const p=products.find(x=>x.id===id);
        if(!p) return;
        
        p.name=document.getElementById('newProdName').value.trim()||p.name;
        p.price=parseFloat(document.getElementById('newProdPrice').value)||p.price;
        p.stock=parseInt(document.getElementById('newProdStock').value)??p.stock;
        p.category=document.getElementById('newProdCategory').value||p.category;
        
        const ev=document.getElementById('newProdEmoji').value.trim();
        if(ev) p.emoji=ev.charAt(0)||p.emoji;
        
        if(!useLocal&&currentUser?.source!=='local'){
            await sb.from('products')
                .update(p)
                .eq('id',id)
                .catch(()=>{});
        }
        
        await saveData();
        
        const btn=document.querySelector('[onclick^="saveEdit"]');
        if(btn){
            btn.innerHTML='<i class="fas fa-plus-circle"></i> Adicionar';
            btn.setAttribute('onclick','addProduct()');
        }
        
        document.getElementById('newProdName').value='';
        document.getElementById('newProdPrice').value='';
        document.getElementById('newProdStock').value='';
        document.getElementById('newProdEmoji').value='';
        document.getElementById('newProdCategory').value='';
        document.getElementById('emojiPreviewBadge').textContent='üì¶';
        
        showToast(`"${p.name}" atualizado!`,'success');
        renderStock(); 
        renderPOS();
    }

    async function updateStock(id,qty){
        const p=products.find(x=>x.id===id);
        if(!p) return;
        
        p.stock=Math.max(0,parseInt(qty)||0);
        
        if(!useLocal&&currentUser?.source!=='local'){
            await sb.from('products')
                .update({stock:p.stock})
                .eq('id',id)
                .catch(()=>{});
        }
        
        await saveData();
        checkLowStock(); 
        renderStock(); 
        renderPOS();
    }

    async function deleteProduct(id){
        const p=products.find(x=>x.id===id);
        if(!p||!confirm(`Excluir "${p.name}"?`)) return;
        
        if(!useLocal&&currentUser?.source!=='local'){
            await sb.from('products')
                .delete()
                .eq('id',id)
                .catch(()=>{});
        }
        
        products=products.filter(x=>x.id!==id);
        cart=cart.filter(i=>i.id!==id);
        await saveData();
        
        showToast(`"${p.name}" exclu√≠do`,'info');
        renderStock(); 
        renderPOS(); 
        updateCartUI(); 
        checkLowStock();
    }

    function checkLowStock(){
        const n=products.filter(p=>p.stock<5).length;
        const nb=document.getElementById('stockNotification');
        const lb=document.getElementById('lowStockBadge');
        
        if(n>0){
            nb.textContent=n;
            nb.style.display='flex';
            lb.style.display='flex';
            document.getElementById('lowStockCount').textContent=`${n} produto${n>1?'s':''}`;
        } else{
            nb.style.display='none';
            lb.style.display='none';
        }
        
        document.getElementById('dashLowStock').textContent=n;
    }

    function exportStockCSV(){
        let csv='Produto;Pre√ßo;Estoque;Categoria;Emoji\n';
        products.forEach(p=>{
            csv+=`"${p.name}";${p.price.toFixed(2)};${p.stock};"${getCatName(p.category)}";"${p.emoji}"\n`;
        });
        dlCSV(csv,`estoque_${now()}.csv`);
        showToast('Estoque exportado! üìä','success');
    }

    // ‚îÄ‚îÄ SISTEMA DE EMOJIS INTELIGENTE ‚îÄ‚îÄ
    function suggestEmoji(){
        const name=document.getElementById('newProdName').value.toLowerCase();
        const cat=document.getElementById('newProdCategory').value;
        
        if(!name) return;
        
        const found=EMOJI_DB.find(e=>e.keys.some(k=>name.includes(k)||k.includes(name.split(' ')[0])));
        
        if(found){
            document.getElementById('newProdEmoji').value=found.char;
            document.getElementById('emojiPreviewBadge').textContent=found.char;
            if(!cat && found.cat) document.getElementById('newProdCategory').value=found.cat;
        }
    }

    function updateEmojiPreview(){
        const val=document.getElementById('newProdEmoji').value.trim();
        const preview=document.getElementById('emojiPreviewBadge');
        
        if(!val){
            preview.textContent='üì¶';
            return;
        }
        
        const emojiRegex=/[\p{Emoji_Presentation}\p{Emoji}\uFE0F]/u;
        if(emojiRegex.test(val.charAt(0))){
            preview.textContent=val.charAt(0);
        } else{
            const found=EMOJI_DB.find(e=>e.keys.some(k=>k.includes(val.toLowerCase())));
            preview.textContent=found?found.char:'‚ùì';
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DASHBOARD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateDashboard(){
        const today=new Date().toDateString();
        const todaySales=salesHistory.filter(s=>new Date(s.timestamp).toDateString()===today);
        const todayTotal=todaySales.reduce((a,s)=>a+s.total,0);
        
        document.getElementById('dashTotalSales').textContent=`R$ ${todayTotal.toFixed(2)}`;
        document.getElementById('dashTotalTickets').textContent=todaySales.length;
        
        const avg=todaySales.length?todayTotal/todaySales.length:0;
        document.getElementById('dashAvgTicket').textContent=`M√©dia: R$ ${avg.toFixed(2)}`;
        
        const freq={};
        salesHistory.forEach(s=>(s.items||[]).forEach(i=>{
            freq[i.name]=(freq[i.name]||0)+i.qty;
        }));
        
        const top=Object.entries(freq).sort((a,b)=>b[1]-a[1])[0];
        document.getElementById('dashTopProduct').textContent=top?top[0].substring(0,14)+(top[0].length>14?'‚Ä¶':''):'-';
        document.getElementById('dashTopProductQty').textContent=top?`${top[1]} unidades`:'0 unidades';
        
        const yesterday=new Date(); 
        yesterday.setDate(yesterday.getDate()-1);
        const yesterdaySales=salesHistory.filter(s=>new Date(s.timestamp).toDateString()===yesterday.toDateString());
        const yesterdayTotal=yesterdaySales.reduce((a,s)=>a+s.total,0);
        
        const changeEl=document.getElementById('dashSalesChange');
        if(yesterdayTotal>0){
            const pct=((todayTotal-yesterdayTotal)/yesterdayTotal*100).toFixed(1);
            changeEl.textContent=`${pct>0?'+':''}${pct}% vs ontem`;
            changeEl.style.color=pct>=0?'var(--success)':'var(--danger)';
        } else { 
            changeEl.textContent='Sem dados de ontem'; 
            changeEl.style.color='var(--text-light)'; 
        }
        
        checkLowStock();
        renderSalesHistory();
    }

    function renderSalesHistory(){
        const tbody=document.getElementById('salesHistoryBody');
        const f=document.getElementById('salesFilter').value;
        const now2=new Date();
        let list=salesHistory;
        
        if(f==='today'){
            const d=now2.toDateString();
            list=list.filter(s=>new Date(s.timestamp).toDateString()===d);
        } else if(f==='week'){
            const w=new Date(now2-7*86400000);
            list=list.filter(s=>new Date(s.timestamp)>=w);
        } else if(f==='month'){
            const m=new Date(now2-30*86400000);
            list=list.filter(s=>new Date(s.timestamp)>=m);
        }
        
        list=list.slice(0,50);
        
        if(!list.length){
            tbody.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#b2bec3;padding:40px">
                <i class="fas fa-chart-line" style="font-size:2rem;opacity:.4;display:block;margin-bottom:10px"></i>
                Nenhuma venda no per√≠odo
            </td></tr>`;
            return;
        }
        
        tbody.innerHTML=list.map(s=>`<tr>
            <td>${s.date}</td>
            <td><span style="background:#f8f9ff;padding:4px 10px;border-radius:10px;font-size:.85rem;font-weight:700">${s.method}</span></td>
            <td>${s.itemsCount} itens</td>
            <td style="font-weight:900;color:var(--primary)">R$ ${s.total.toFixed(2)}</td>
            <td><button onclick="viewSale('${s.id}')" style="background:var(--primary);color:white;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-weight:700">
                <i class="fas fa-eye"></i>
            </button></td>
        </tr>`).join('');
    }

    function filterSalesHistory(){
        renderSalesHistory();
    }

    function viewSale(id){
        const s=salesHistory.find(x=>x.id===id);
        if(!s) return;
        
        let d=`‚ïê‚ïê‚ïê‚ïê DETALHES DA VENDA ‚ïê‚ïê‚ïê‚ïê\n\nID: ${s.id}\nData: ${s.date}\nPagamento: ${s.method}\nProcessado em: ${s.processingTime||'-'}\n\n‚îÄ‚îÄ ITENS ‚îÄ‚îÄ\n\n`;
        (s.items||[]).forEach(i=>{
            d+=`${i.qty}x ${i.emoji} ${i.name}\n   R$ ${i.price.toFixed(2)} un = R$ ${(i.price*i.qty).toFixed(2)}\n\n`;
        });
        d+=`‚îÄ‚îÄ TOTAIS ‚îÄ‚îÄ\n\nSubtotal: R$ ${s.subtotal.toFixed(2)}\nDesconto: R$ ${s.discount.toFixed(2)}\nTOTAL: R$ ${s.total.toFixed(2)}`;
        alert(d);
    }

    function generateSalesChart(){
        const el=document.getElementById('salesChart');
        const days=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
        const vals=[0,0,0,0,0,0,0];
        const counts=[0,0,0,0,0,0,0];
        
        salesHistory.forEach(s=>{
            const d=new Date(s.timestamp).getDay();
            vals[d]+=s.total;
            counts[d]++;
        });
        
        const mx=Math.max(...vals,1);
        const totalWeek=vals.reduce((a,b)=>a+b,0);
        
        el.innerHTML=`
            <div style="display:flex;justify-content:space-around;align-items:flex-end;height:220px;padding:0 10px;position:relative">
                ${days.map((d,i)=>`
                    <div class="chart-bar-wrap" title="${counts[i]} venda(s) ‚Äî R$ ${vals[i].toFixed(2)}">
                        <div style="font-size:.7rem;color:var(--primary);font-weight:800;margin-bottom:4px;text-align:center;min-height:18px">
                            ${vals[i]>0?'R$ '+vals[i].toFixed(0):''}
                        </div>
                        <div class="chart-bar" style="height:${Math.max(Math.round((vals[i]/mx)*160),4)}px;width:34px;
                            ${vals[i]===mx&&mx>0?'background:linear-gradient(0deg,var(--primary),var(--accent));box-shadow:0 4px 15px rgba(108,92,231,.4)':''}">
                        </div>
                        <div class="chart-label">${d}</div>
                        ${counts[i]>0?`<div style="font-size:.65rem;color:var(--text-light)">${counts[i]}v</div>`:''}
                    </div>
                `).join('')}
            </div>
            <div style="text-align:center;margin-top:15px;padding-top:12px;border-top:1px solid #f1f2f6">
                <span style="font-weight:700;color:var(--primary)">Total: R$ ${totalWeek.toFixed(2)}</span>
                <span style="color:var(--text-light);margin-left:15px;font-size:.85rem">${salesHistory.length} venda(s)</span>
            </div>
        `;
    }

    function exportSalesCSV(){
        let csv='ID;Data/Hora;M√©todo;N¬∫ Itens;Subtotal;Desconto;Total;Tempo\n';
        salesHistory.forEach(s=>{
            csv+=`"${s.id}";"${s.date}";"${s.method}";${s.itemsCount};"${s.subtotal.toFixed(2)}";"${s.discount.toFixed(2)}";"${s.total.toFixed(2)}";"${s.processingTime||'-'}"\n`;
        });
        dlCSV(csv,`vendas_${now()}.csv`);
        showToast('Hist√≥rico exportado! üìä','success');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SCANNER / BUSCA / VOZ
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function setupBarcodeScanner(){
        const input=document.getElementById('barcodeInput');
        
        input.addEventListener('input',function(){
            const t=this.value.toLowerCase().trim();
            if(t.length>1) showSuggestions(t); 
            else hideSuggestions();
            suggestionIndex=-1;
        });
        
        input.addEventListener('keydown',function(e){
            const items=document.querySelectorAll('.suggestion-item');
            
            if(e.key==='ArrowDown'){
                e.preventDefault();
                suggestionIndex=Math.min(suggestionIndex+1,items.length-1);
                highlightSuggestion(items);
            } else if(e.key==='ArrowUp'){
                e.preventDefault();
                suggestionIndex=Math.max(suggestionIndex-1,0);
                highlightSuggestion(items);
            } else if(e.key==='Enter'){
                e.preventDefault();
                
                if(suggestionIndex>=0&&items[suggestionIndex]){
                    items[suggestionIndex].click(); 
                    return;
                }
                
                const t=this.value.toLowerCase().trim();
                const f=products.find(p=>p.id==t||p.name.toLowerCase().includes(t));
                
                if(f){
                    addToCart(f.id);
                    this.value='';
                    hideSuggestions();
                    suggestionIndex=-1;
                } else {
                    showToast('Produto n√£o encontrado.','error');
                }
            } else if(e.key==='Escape'){
                hideSuggestions();
                suggestionIndex=-1;
            }
        });
        
        document.addEventListener('click',function(e){
            if(!e.target.closest('#barcodeInput')&&!e.target.closest('#suggestionsBox')){
                hideSuggestions();
            }
        });
    }

    function highlightSuggestion(items){
        items.forEach((it,i)=>{
            if(i===suggestionIndex) it.classList.add('active-suggestion');
            else it.classList.remove('active-suggestion');
        });
    }

    function showSuggestions(term){
        const box=document.getElementById('suggestionsBox');
        const list=products.filter(p=>
            p.name.toLowerCase().includes(term)||
            (p.category&&p.category.includes(term))
        ).slice(0,6);
        
        if(!list.length){
            box.style.display='none';
            return;
        }
        
        box.innerHTML=list.map(p=>`
            <div class="suggestion-item" onclick="selectSuggestion(${p.id})">
                <span style="font-size:2rem">${p.emoji}</span>
                <div style="flex:1">
                    <div style="font-weight:800">${p.name}</div>
                    <div style="font-size:.82rem;color:#636e72">
                        <span style="color:var(--primary);font-weight:700">R$ ${p.price.toFixed(2)}</span>
                        &nbsp;|&nbsp; Estoque: <span style="${p.stock<5?'color:var(--danger);font-weight:700':''}">${p.stock} un</span>
                    </div>
                </div>
                <span style="font-size:1.4rem">+</span>
            </div>
        `).join('');
        
        box.style.display='block';
    }

    function hideSuggestions(){
        document.getElementById('suggestionsBox').style.display='none';
    }

    function selectSuggestion(id){
        addToCart(id);
        document.getElementById('barcodeInput').value='';
        hideSuggestions();
        suggestionIndex=-1;
    }

    function openVoiceSearch(){
        const SpeechRec=window.SpeechRecognition||window.webkitSpeechRecognition;
        
        if(!SpeechRec){
            showToast('Reconhecimento de voz n√£o suportado','warning');
            return;
        }
        
        const R=new SpeechRec();
        R.lang='pt-BR'; 
        R.interimResults=false; 
        R.maxAlternatives=3;
        
        showToast('üé§ Ouvindo... fale o nome do produto','info',3000);
        R.start();
        
        R.onresult=function(e){
            const transcripts=Array.from(e.results[0]).map(r=>r.transcript.toLowerCase());
            let found=null;
            
            for(const t of transcripts){
                found=products.find(p=>
                    p.name.toLowerCase().includes(t)||
                    t.includes(p.name.toLowerCase().split(' ')[0])
                );
                if(found) break;
            }
            
            if(found){
                addToCart(found.id);
                showToast(`üé§ Adicionado: ${found.name}!`,'success');
            } else {
                showToast(`Produto "${transcripts[0]}" n√£o encontrado.`,'warning');
            }
        };
        
        R.onerror=function(ev){
            if(ev.error==='no-speech') showToast('Nenhuma fala detectada','warning');
            else showToast('Erro no reconhecimento de voz','error');
        };
    }

    function openQuickProductModal(){
        document.getElementById('quickProductModal').style.display='flex';
        document.getElementById('quickProdName').focus();
    }

    function closeQuickProductModal(){
        document.getElementById('quickProductModal').style.display='none';
        document.getElementById('quickProdName').value='';
        document.getElementById('quickProdPrice').value='';
    }

    function addQuickProduct(){
        const name=document.getElementById('quickProdName').value.trim();
        const price=parseFloat(document.getElementById('quickProdPrice').value);
        
        if(!name||isNaN(price)||price<=0){
            showToast('Preencha nome e pre√ßo','error');
            return;
        }
        
        const found=EMOJI_DB.find(e=>e.keys.some(k=>name.toLowerCase().includes(k)));
        const emoji=found?found.char:'‚ö°';
        
        const newId=products.length?Math.max(...products.map(p=>typeof p.id==='number'?p.id:0))+1:1;
        const np={id:newId,name,price,stock:999,emoji,category:'outro'};
        
        products.push(np);
        closeQuickProductModal();
        addToCart(newId);
        showToast(`${emoji} "${name}" adicionado!`,'success');
    }

    // ‚îÄ‚îÄ ATALHOS DE TECLADO ‚îÄ‚îÄ
    function setupKeyboard(){
        document.addEventListener('keydown',function(e){
            if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT') return;
            
            switch(e.key){
                case 'F1': e.preventDefault(); switchTab('pdv'); break;
                case 'F2': e.preventDefault(); switchTab('stock'); break;
                case 'F3': e.preventDefault(); switchTab('dashboard'); break;
                case 'F4': e.preventDefault(); switchTab('cashier'); break;
                case 'F5': e.preventDefault(); if(cart.length) openPaymentModal(); break;
                case 'F8': e.preventDefault(); clearCart(); break;
                case 'F9': e.preventDefault(); applyDiscount(10); break;
                case 'Escape': 
                    e.preventDefault(); 
                    document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none'); 
                    hideSuggestions(); 
                    break;
            }
        });
        
        document.getElementById('barcodeInput').addEventListener('keydown',e=>{
            if(e.key==='F2'){
                e.preventDefault();
                openVoiceSearch();
            }
        });
    }

    // ‚îÄ‚îÄ MODO ESCURO ‚îÄ‚îÄ
    function toggleDarkMode(){
        const isDark=document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode',isDark);
        document.querySelector('.dark-mode-toggle').innerHTML=isDark?'‚òÄÔ∏è':'üåô';
        
        if(isDark) applyDark(); 
        else removeDark();
        
        showToast(`Modo ${isDark?'escuro üåô':'claro ‚òÄÔ∏è'} ativado`,'info');
    }

    function applyDark(){
        if(document.getElementById('dms')) return;
        
        const s=document.createElement('style'); 
        s.id='dms';
        s.textContent=`
            body{background:linear-gradient(135deg,#1a1a2e,#16213e)!important;color:#e0e0e0}
            .app-container{background:rgba(30,30,46,.92)!important}
            .content-area{background:linear-gradient(135deg,rgba(40,40,60,.9),rgba(30,30,50,.8))!important}
            .product-card,.cart-panel,.table-container,.card-metric,.chart-container,.modal-content,.stat-badge,.auth-card,.cashier-control{background:rgba(45,45,65,.97)!important;color:#e0e0e0}
            .scan-input,input:not([type=checkbox]),select,textarea{background:rgba(60,60,80,.9)!important;color:#e0e0e0!important;border-color:#6c5ce7!important}
            h2,h3{color:#a29bfe!important}
            table th{background:rgba(108,92,231,.2)!important;color:#a29bfe!important}
            tr:hover{background:rgba(108,92,231,.1)!important}
            .cart-item,.cash-movement-card{background:rgba(60,60,80,.8)!important}
            .cart-item:hover{background:rgba(108,92,231,.2)!important}
            .cart-summary{background:rgba(40,40,60,.8)!important}
            .product-category{background:rgba(60,60,80,.8)!important;color:#ccc!important}
            .quick-action-btn{background:rgba(60,60,80,.9)!important;color:#e0e0e0!important;border-color:#6c5ce7!important}
            .sidebar{background:rgba(20,20,40,.6)!important}
        `;
        document.head.appendChild(s);
    }

    function removeDark(){
        document.getElementById('dms')?.remove();
    }

    function updateNotifications(){
        const cn=document.getElementById('cartNotification');
        const n=cart.reduce((a,i)=>a+i.qty,0);
        
        if(n>0){
            cn.textContent=n;
            cn.style.display='flex';
        }else{
            cn.style.display='none';
        }
    }

    // ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
    function showToast(msg, type='success', dur=3000){
        const t=document.getElementById('toast');
        t.className='toast '+type;
        t.querySelector('.toast-message').textContent=msg;
        
        const icons={
            success:'fa-check-circle',
            warning:'fa-exclamation-triangle',
            error:'fa-times-circle',
            info:'fa-info-circle'
        };
        
        t.querySelector('.toast-icon').className=`fas ${icons[type]||'fa-info-circle'} toast-icon`;
        t.classList.add('show');
        
        clearTimeout(t._to);
        t._to=setTimeout(()=>t.classList.remove('show'),dur);
    }

    function showLoader(){
        document.getElementById('loader').style.display='flex';
    }

    function hideLoader(){
        document.getElementById('loader').style.display='none';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BOOT ‚Äî INICIALIZA√á√ÉO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    (function boot(){
        initSB();
        createMagicParticles();
        
        if(localStorage.getItem('darkMode')==='true'){
            document.body.classList.add('dark-mode');
            applyDark();
        }
        
        // Tentar restaurar sess√£o Supabase
        if(!useLocal){
            sb.auth.getSession().then(({data:{session}})=>{
                if(session){
                    sb.from('profiles')
                        .select('*')
                        .eq('id',session.user.id)
                        .single()
                        .then(({data:profile})=>{
                            currentUser={
                                id:session.user.id, 
                                email:session.user.email,
                                companyName:profile?.company_name||'Empresa',
                                document:profile?.document||'', 
                                phone:profile?.phone||'',
                                plan:profile?.plan||'professional',
                                isTrial:profile?.is_trial??true,
                                validUntil:profile?.valid_until||new Date(Date.now()+TRIAL_DAYS*86400000).toISOString(),
                                source:'supabase'
                            };
                            
                            loadUserData().then(()=>{
                                document.getElementById('authContainer').style.display='none';
                                document.getElementById('appContainer').style.display='grid';
                                updateSubscriptionStatus();
                                initApp();
                                showToast(`Sess√£o restaurada! Bem-vindo, ${currentUser.companyName} üëã`,'success');
                            });
                        });
                }
            }).catch(()=>{});
        }
        
        console.log(`%c${APP_NAME} v${APP_VER}`,
            'font-size:16px;font-weight:bold;color:#6c5ce7;background:#f8f9ff;padding:5px 10px;border-radius:6px');
        console.log(`Modo: ${useLocal?'üî∂ LocalStorage (Offline)':'üü¢ Supabase (Nuvem)'}`);
        
        // Event listeners de login
        document.getElementById('loginPassword').addEventListener('keypress',e=>{
            if(e.key==='Enter')loginUser();
        });
        document.getElementById('loginEmail').addEventListener('keypress',e=>{
            if(e.key==='Enter')loginUser();
        });
    })();
</script>
</body>
</html>
