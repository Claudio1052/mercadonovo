<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV M√°gico ‚ú® Pro | Sistema Inteligente</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #e0e5ec;
            --glass: rgba(255,255,255,0.85);
            --primary: #6c5ce7;
            --primary-light: #8579ec;
            --primary-dark: #5649c0;
            --secondary: #00cec9;
            --accent: #fd79a8;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #ff7675;
            --info: #0984e3;
            --whatsapp: #25D366;
            --text: #2d3436;
            --text-light: #636e72;
            --shadow: 0 20px 40px rgba(31,38,135,0.15);
            --shadow-light: 0 10px 20px rgba(31,38,135,0.1);
            --border: 1px solid rgba(255,255,255,0.25);
            --border-radius: 24px;
            --transition: all 0.3s cubic-bezier(0.175,0.885,0.32,1.275);
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Nunito',sans-serif; }
        body {
            background: linear-gradient(135deg,#a8edea 0%,#fed6e3 100%);
            min-height:100vh; display:flex; padding:20px;
            color:var(--text); overflow-x:hidden;
        }

        /* ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ */
        .auth-container { display:flex; justify-content:center; align-items:center; width:100%; min-height:100vh; padding:20px; }
        .auth-card { background:var(--glass); backdrop-filter:blur(20px); border-radius:var(--border-radius); box-shadow:var(--shadow); border:var(--border); padding:40px; width:100%; max-width:480px; animation:fadeIn .5s ease; }
        .auth-header { text-align:center; margin-bottom:30px; }
        .auth-logo { font-size:2.5rem; margin-bottom:15px; color:var(--primary); }
        .auth-title { font-size:2rem; font-weight:900; color:var(--primary); margin-bottom:10px; }
        .auth-subtitle { color:var(--text-light); margin-bottom:25px; }
        .auth-form { display:flex; flex-direction:column; gap:20px; }
        .form-group { display:flex; flex-direction:column; gap:8px; }
        .form-label { font-weight:700; color:var(--text); font-size:.9rem; }
        .form-input { padding:16px 20px; border-radius:16px; border:2px solid #dfe6e9; font-size:1rem; outline:none; background:rgba(255,255,255,.9); transition:var(--transition); }
        .form-input:focus { border-color:var(--primary); box-shadow:0 0 0 4px rgba(108,92,231,.2); transform:translateY(-2px); }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
        .auth-btn { background:linear-gradient(90deg,var(--primary),var(--primary-light)); color:white; border:none; padding:18px; border-radius:18px; font-weight:900; font-size:1.1rem; cursor:pointer; transition:var(--transition); margin-top:10px; display:flex; align-items:center; justify-content:center; gap:10px; }
        .auth-btn:hover { transform:translateY(-5px); box-shadow:0 15px 30px rgba(108,92,231,.4); }
        .auth-btn:disabled { opacity:.6; cursor:not-allowed; transform:none !important; }
        .auth-switch { text-align:center; margin-top:25px; color:var(--text-light); }
        .auth-switch a { color:var(--primary); text-decoration:none; font-weight:700; cursor:pointer; }
        .auth-switch a:hover { text-decoration:underline; }
        .plan-card { background:white; border-radius:20px; padding:25px; margin-top:20px; border:3px solid var(--primary); text-align:center; position:relative; overflow:hidden; }
        .plan-badge { position:absolute; top:15px; right:-30px; background:var(--success); color:white; padding:5px 30px; transform:rotate(45deg); font-size:.8rem; font-weight:700; }
        .plan-price { font-size:2.5rem; font-weight:900; color:var(--primary); margin:10px 0; }
        .plan-period { font-size:1rem; color:var(--text-light); }
        .plan-features { list-style:none; margin:20px 0; text-align:left; }
        .plan-features li { padding:8px 0; display:flex; align-items:center; gap:10px; }
        .plan-features li i { color:var(--success); }
        .terms-checkbox { display:flex; align-items:flex-start; gap:10px; margin:15px 0; font-size:.9rem; }
        .terms-checkbox input { margin-top:3px; }
        .terms-checkbox a { color:var(--primary); text-decoration:none; }
        .error-msg { color:var(--danger); font-size:.88rem; font-weight:700; margin-top:-10px; padding:10px 15px; background:rgba(255,118,117,.1); border-radius:12px; border-left:4px solid var(--danger); display:none; }
        .error-msg.show { display:block; }

        /* ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ */
        .app-container { display:none; grid-template-columns:80px 1fr; width:100%; height:calc(100vh - 40px); background:var(--glass); backdrop-filter:blur(20px); border-radius:var(--border-radius); box-shadow:var(--shadow); border:var(--border); overflow:hidden; z-index:10; position:relative; }
        .sidebar { display:flex; flex-direction:column; align-items:center; padding-top:30px; background:rgba(255,255,255,.3); border-right:var(--border); position:relative; overflow:hidden; }
        .sidebar::before { content:''; position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(180deg,rgba(255,255,255,.6) 0%,rgba(255,255,255,.2) 100%); z-index:-1; }
        .nav-btn { width:56px; height:56px; border-radius:18px; border:none; background:transparent; font-size:1.5rem; margin-bottom:15px; cursor:pointer; transition:var(--transition); color:#b2bec3; display:flex; align-items:center; justify-content:center; position:relative; }
        .nav-btn:hover { transform:translateY(-5px); background:#fff; box-shadow:0 10px 20px rgba(108,92,231,.2); }
        .nav-btn.active { background:var(--primary); color:#fff; box-shadow:0 10px 20px -5px rgba(108,92,231,.4); transform:scale(1.05); }
        .nav-notification { position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; font-size:.7rem; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; font-weight:800; }
        .content-area { padding:30px; overflow-y:auto; position:relative; background:linear-gradient(135deg,rgba(255,255,255,.9) 0%,rgba(248,248,255,.8) 100%); }
        .section { display:none; height:100%; animation:fadeIn .5s ease; }
        .section.active { display:block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        @keyframes zoomIn { from{transform:scale(.7);opacity:0} to{transform:scale(1);opacity:1} }
        @keyframes spin { to{transform:rotate(360deg)} }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

        h2 { font-weight:900; font-size:2.2rem; margin-bottom:20px; color:var(--primary); display:flex; align-items:center; gap:15px; position:relative; }
        h2::after { content:''; position:absolute; bottom:-8px; left:0; width:60px; height:4px; background:linear-gradient(90deg,var(--primary),var(--secondary)); border-radius:2px; }

        /* ‚îÄ‚îÄ‚îÄ PDV ‚îÄ‚îÄ‚îÄ */
        .pdv-header { display:flex; gap:15px; margin-bottom:25px; flex-wrap:wrap; }
        .scan-input { flex:1; min-width:300px; padding:18px 20px; border-radius:18px; border:2px solid var(--primary); font-size:1.1rem; outline:none; background:rgba(255,255,255,.9); transition:var(--transition); box-shadow:0 5px 15px rgba(0,0,0,.05); }
        .scan-input:focus { border-color:var(--secondary); box-shadow:0 0 0 4px rgba(0,206,201,.2); transform:translateY(-2px); }
        .quick-actions { display:flex; gap:10px; }
        .quick-action-btn { padding:12px 20px; background:white; border:2px solid #dfe6e9; border-radius:15px; font-weight:700; cursor:pointer; transition:var(--transition); display:flex; align-items:center; gap:8px; }
        .quick-action-btn:hover { background:var(--primary); color:white; border-color:var(--primary); transform:translateY(-3px); }
        .pdv-grid { display:grid; grid-template-columns:2fr 1fr; gap:25px; height:calc(100% - 100px); }
        .product-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:20px; align-content:start; overflow-y:auto; padding-right:10px; max-height:calc(100vh - 200px); }
        .product-card { background:white; border-radius:22px; padding:20px; text-align:center; cursor:pointer; transition:var(--transition); border:2px solid transparent; box-shadow:var(--shadow-light); position:relative; overflow:hidden; display:flex; flex-direction:column; justify-content:space-between; }
        .product-card::before { content:''; position:absolute; top:0; left:0; width:100%; height:6px; background:linear-gradient(90deg,var(--primary),var(--secondary)); opacity:0; transition:opacity .3s; }
        .product-card:hover { transform:translateY(-10px) scale(1.03); border-color:var(--secondary); box-shadow:0 20px 40px rgba(0,206,201,.2); }
        .product-card:hover::before { opacity:1; }
        .product-emoji { font-size:3.5rem; margin-bottom:15px; display:block; transition:transform .3s; }
        .product-card:hover .product-emoji { transform:scale(1.2) rotate(5deg); }
        .product-name { font-weight:800; font-size:1rem; margin-bottom:8px; color:var(--text); }
        .product-price { color:var(--primary); font-weight:900; font-size:1.3rem; margin-bottom:5px; }
        .product-stock { position:absolute; top:10px; right:10px; font-size:.75rem; background:#dfe6e9; padding:4px 10px; border-radius:12px; font-weight:700; }
        .stock-low { background:var(--danger); color:white; }
        .stock-medium { background:var(--warning); color:var(--text); }
        .stock-high { background:var(--success); color:white; }
        .product-category { font-size:.75rem; color:var(--text-light); background:#f8f9fa; padding:3px 10px; border-radius:10px; margin-top:5px; display:inline-block; }

        /* ‚îÄ‚îÄ‚îÄ CART ‚îÄ‚îÄ‚îÄ */
        .cart-panel { background:white; border-radius:28px; padding:25px; display:flex; flex-direction:column; box-shadow:var(--shadow-light); height:100%; }
        .cart-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
        .clear-cart { background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:12px; font-size:.85rem; cursor:pointer; transition:var(--transition); display:flex; align-items:center; gap:5px; }
        .clear-cart:hover { background:#ff5252; transform:translateY(-2px); }
        .cart-items { flex:1; overflow-y:auto; margin:15px 0; padding-right:5px; }
        .cart-item { display:flex; justify-content:space-between; align-items:center; background:#f8f9fa; margin-bottom:12px; padding:15px; border-radius:16px; font-size:.95rem; transition:var(--transition); border-left:4px solid var(--primary); }
        .cart-item:hover { background:#f1f3ff; transform:translateX(5px); }
        .cart-item-info { flex:1; }
        .cart-item-name { font-weight:700; margin-bottom:5px; }
        .cart-item-qty { display:flex; align-items:center; gap:10px; margin-top:8px; }
        .qty-btn { width:28px; height:28px; border-radius:8px; border:1px solid #dfe6e9; background:white; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:bold; transition:var(--transition); }
        .qty-btn:hover { background:var(--primary); color:white; border-color:var(--primary); }
        .remove-btn { color:var(--danger); cursor:pointer; padding:8px; border-radius:10px; transition:var(--transition); }
        .remove-btn:hover { background:var(--danger); color:white; transform:rotate(90deg); }
        .cart-footer { border-top:2px dashed #dfe6e9; padding-top:20px; }
        .cart-total { font-size:1.8rem; font-weight:900; text-align:right; margin-bottom:20px; color:var(--primary); display:flex; justify-content:space-between; align-items:center; }
        .cart-total-label { font-size:1.2rem; color:var(--text-light); }
        .btn-checkout { background:linear-gradient(90deg,var(--primary),var(--primary-light)); color:white; border:none; padding:18px; border-radius:18px; font-weight:900; font-size:1.2rem; cursor:pointer; width:100%; transition:var(--transition); box-shadow:0 10px 20px rgba(108,92,231,.3); display:flex; align-items:center; justify-content:center; gap:10px; }
        .btn-checkout:hover { transform:translateY(-5px); box-shadow:0 15px 30px rgba(108,92,231,.4); }
        .btn-checkout:disabled { background:#b2bec3; cursor:not-allowed; box-shadow:none; transform:none; }

        /* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.7); backdrop-filter:blur(10px); z-index:2000; display:none; justify-content:center; align-items:center; animation:fadeIn .3s ease; }
        .modal-content { background:white; padding:40px; border-radius:32px; width:450px; max-width:90%; text-align:center; animation:zoomIn .4s cubic-bezier(.175,.885,.32,1.275); box-shadow:0 30px 60px rgba(0,0,0,.2); border:var(--border); max-height:90vh; overflow-y:auto; }
        .payment-options, .receipt-options { display:grid; gap:15px; margin:30px 0; }
        .btn-pay, .btn-receipt { padding:18px; border:2px solid #dfe6e9; background:white; border-radius:18px; font-size:1.1rem; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:12px; transition:var(--transition); }
        .btn-pay:hover { transform:translateY(-5px); border-color:var(--primary); background:#f8f9fa; color:var(--primary); box-shadow:0 10px 20px rgba(0,0,0,.1); }
        .btn-whatsapp { color:var(--whatsapp); border-color:var(--whatsapp); }
        .btn-whatsapp:hover { background:var(--whatsapp); color:white; border-color:var(--whatsapp); }
        .btn-email { color:var(--info); border-color:var(--info); }
        .btn-email:hover { background:var(--info); color:white; border-color:var(--info); }

        /* ‚îÄ‚îÄ‚îÄ STOCK/DASHBOARD ‚îÄ‚îÄ‚îÄ */
        .table-container { background:white; padding:25px; border-radius:24px; overflow:hidden; box-shadow:var(--shadow-light); }
        table { width:100%; border-collapse:collapse; }
        th,td { padding:15px; text-align:left; border-bottom:1px solid #f1f2f6; }
        th { color:var(--primary); font-weight:800; background:#f8f9ff; }
        tr:hover { background:#f8f9fa; }
        .form-add { display:flex; gap:10px; margin-bottom:25px; flex-wrap:wrap; }
        input, select { padding:14px; border-radius:14px; border:2px solid #dfe6e9; flex:1; min-width:150px; transition:var(--transition); font-size:1rem; }
        input:focus, select:focus { border-color:var(--primary); outline:none; box-shadow:0 0 0 3px rgba(108,92,231,.1); }
        .dashboard-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:25px; margin-bottom:30px; }
        .card-metric { background:white; padding:25px; border-radius:24px; display:flex; align-items:center; gap:20px; box-shadow:var(--shadow-light); transition:var(--transition); position:relative; overflow:hidden; }
        .card-metric:hover { transform:translateY(-10px); box-shadow:0 20px 40px rgba(0,0,0,.1); }
        .card-metric::before { content:''; position:absolute; top:0; left:0; width:8px; height:100%; background:linear-gradient(180deg,var(--primary),var(--secondary)); }
        .metric-icon { font-size:2.8rem; background:linear-gradient(135deg,var(--primary),var(--secondary)); width:70px; height:70px; display:flex; align-items:center; justify-content:center; border-radius:50%; color:white; }
        .metric-info p { color:var(--text-light); font-size:.9rem; margin-bottom:5px; }
        .metric-info h3 { font-size:2rem; color:var(--text); }
        .chart-container { background:white; padding:25px; border-radius:24px; margin-bottom:30px; box-shadow:var(--shadow-light); }
        .chart-bars { display:flex; justify-content:space-around; align-items:flex-end; height:200px; padding:0 20px; }
        .chart-bar-wrap { display:flex; flex-direction:column; align-items:center; gap:8px; }
        .chart-bar { width:30px; background:linear-gradient(0deg,var(--primary),var(--secondary)); border-radius:5px 5px 0 0; transition:height .6s ease; }
        .chart-label { font-size:.8rem; color:var(--text-light); font-weight:700; }

        /* ‚îÄ‚îÄ‚îÄ MISC ‚îÄ‚îÄ‚îÄ */
        .toast { position:fixed; bottom:30px; right:30px; background:var(--success); color:white; padding:20px 30px; border-radius:18px; box-shadow:0 20px 40px rgba(0,0,0,.2); transform:translateX(400px); transition:transform .4s cubic-bezier(.175,.885,.32,1.275); font-weight:700; z-index:3000; display:flex; align-items:center; gap:15px; max-width:350px; }
        .toast.show { transform:translateX(0); }
        .toast.success { background:var(--success); }
        .toast.warning { background:var(--warning); color:var(--text); }
        .toast.error { background:var(--danger); }
        .toast.info { background:var(--info); }
        .low-stock-badge { position:fixed; bottom:30px; left:30px; background:var(--danger); color:white; padding:15px 25px; border-radius:16px; display:flex; align-items:center; gap:12px; cursor:pointer; z-index:100; box-shadow:0 10px 20px rgba(255,118,117,.3); transition:var(--transition); }
        .low-stock-badge:hover { transform:translateY(-5px); }
        .loader { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,.9); z-index:9999; justify-content:center; align-items:center; flex-direction:column; gap:20px; }
        .loader-spinner { width:60px; height:60px; border:6px solid #dfe6e9; border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
        .suggestions-box { position:absolute; background:white; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,.15); z-index:1000; max-height:300px; overflow-y:auto; display:none; width:100%; margin-top:5px; }
        .suggestion-item { padding:15px; cursor:pointer; border-bottom:1px solid #f1f2f6; display:flex; align-items:center; gap:15px; transition:var(--transition); }
        .suggestion-item:hover { background:#f8f9ff; }
        .live-stats { display:flex; gap:15px; margin-bottom:25px; flex-wrap:wrap; }
        .stat-badge { background:white; padding:12px 20px; border-radius:16px; display:flex; align-items:center; gap:10px; box-shadow:var(--shadow-light); font-weight:700; }
        .stat-badge i { color:var(--primary); font-size:1.2rem; }
        .dark-mode-toggle { position:absolute; bottom:30px; left:50%; transform:translateX(-50%); background:transparent; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-light); transition:var(--transition); }
        .dark-mode-toggle:hover { color:var(--primary); transform:translateX(-50%) rotate(30deg); }
        .floating-action-btn { position:fixed; bottom:30px; right:30px; width:60px; height:60px; border-radius:50%; background:var(--primary); color:white; border:none; font-size:1.5rem; cursor:pointer; box-shadow:0 10px 20px rgba(108,92,231,.3); z-index:100; display:flex; align-items:center; justify-content:center; transition:var(--transition); }
        .floating-action-btn:hover { transform:scale(1.1) rotate(90deg); }
        .floating { animation:float 3s ease-in-out infinite; }
        .mode-badge { display:inline-flex; align-items:center; gap:6px; padding:6px 14px; border-radius:20px; font-size:.8rem; font-weight:700; }
        .mode-local { background:#ffeaa7; color:#e17055; }
        .mode-cloud { background:#d4edda; color:#155724; }

        @media(max-width:992px){
            .pdv-grid{grid-template-columns:1fr;height:auto}
            .product-list{max-height:400px}
            .app-container{grid-template-columns:1fr;grid-template-rows:80px 1fr}
            .sidebar{flex-direction:row;justify-content:center;padding-top:0;padding:10px}
            .nav-btn{margin-bottom:0;margin-right:10px}
        }
        @media(max-width:768px){
            .dashboard-cards{grid-template-columns:1fr}
            .form-add,.pdv-header{flex-direction:column}
            .scan-input,.form-row{min-width:100%;grid-template-columns:1fr}
            body{padding:10px}
        }
    </style>
</head>
<body>

<!-- Loader -->
<div class="loader" id="loader">
    <div class="loader-spinner"></div>
    <p>Carregando magia... ‚ú®</p>
</div>

<!-- Auth -->
<div class="auth-container" id="authContainer">
    <!-- Login -->
    <div class="auth-card" id="loginCard">
        <div class="auth-header">
            <div class="auth-logo">‚ú®</div>
            <h1 class="auth-title">PDV M√°gico Pro</h1>
            <p class="auth-subtitle">Sistema Inteligente de Vendas</p>
        </div>
        <div class="error-msg" id="loginError"></div>
        <div class="auth-form">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="loginEmail" placeholder="seu@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">Senha</label>
                <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="auth-btn" id="loginBtn" onclick="loginUser()">
                <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
            </button>
            <div class="auth-switch">
                N√£o tem conta? <a onclick="showRegister()">Cadastre-se gratuitamente</a>
            </div>
        </div>
    </div>

    <!-- Register -->
    <div class="auth-card" id="registerCard" style="display:none">
        <div class="auth-header">
            <div class="auth-logo">üöÄ</div>
            <h1 class="auth-title">Criar Conta</h1>
            <p class="auth-subtitle">7 dias gr√°tis, depois R$ 29,90/m√™s</p>
        </div>
        <div class="plan-card">
            <div class="plan-badge">7 DIAS GR√ÅTIS</div>
            <h3>Plano Profissional</h3>
            <div class="plan-price">R$ 29,90</div>
            <div class="plan-period">por m√™s</div>
            <ul class="plan-features">
                <li><i class="fas fa-check"></i> PDV Completo</li>
                <li><i class="fas fa-check"></i> Gest√£o de Estoque</li>
                <li><i class="fas fa-check"></i> Dashboard Avan√ßado</li>
                <li><i class="fas fa-check"></i> Suporte 24/7</li>
            </ul>
        </div>
        <div class="error-msg" id="registerError"></div>
        <div class="auth-form" style="margin-top:20px">
            <div class="form-group">
                <label class="form-label">Nome da Empresa</label>
                <input type="text" class="form-input" id="regCompany" placeholder="Sua Empresa LTDA">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">CNPJ/CPF</label>
                    <input type="text" class="form-input" id="regDocument" placeholder="000.000.000-00">
                </div>
                <div class="form-group">
                    <label class="form-label">Telefone</label>
                    <input type="tel" class="form-input" id="regPhone" placeholder="(11) 99999-9999">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="regEmail" placeholder="seu@email.com">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-input" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirmar Senha</label>
                    <input type="password" class="form-input" id="regConfirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
            </div>
            <div class="terms-checkbox">
                <input type="checkbox" id="regTerms">
                <label for="regTerms">Concordo com os <a href="#" onclick="showTermsModal()">Termos de Uso</a> e autorizo cobran√ßa de R$ 29,90/m√™s ap√≥s o trial.</label>
            </div>
            <button class="auth-btn" id="registerBtn" onclick="registerUser()">
                <i class="fas fa-rocket"></i> Come√ßar Per√≠odo Gr√°tis
            </button>
            <div class="auth-switch">J√° tem conta? <a onclick="showLogin()">Fa√ßa login</a></div>
        </div>
    </div>
</div>

<!-- App -->
<div class="app-container" id="appContainer">
    <nav class="sidebar">
        <button class="nav-btn active" onclick="switchTab('pdv')" title="Vendas">üõí<span class="nav-notification" id="cartNotification" style="display:none">0</span></button>
        <button class="nav-btn" onclick="switchTab('stock')" title="Estoque">üì¶<span class="nav-notification" id="stockNotification" style="display:none">0</span></button>
        <button class="nav-btn" onclick="switchTab('dashboard')" title="Dashboard">üìä</button>
        <button class="nav-btn" onclick="openAccountModal()" title="Conta">üë§</button>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Modo Escuro">üåô</button>
    </nav>
    <main class="content-area">
        <!-- PDV -->
        <section id="pdv" class="section active">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                <h2><i class="fas fa-cash-register"></i> Caixa Inteligente ‚ú®</h2>
                <div class="stat-badge" id="subscriptionStatus" style="background:var(--success);color:white">
                    <i class="fas fa-crown"></i><span>Plano Ativo</span>
                </div>
            </div>
            <div class="pdv-header">
                <input type="text" id="barcodeInput" class="scan-input" placeholder="üîç Escaneie ou digite o nome do produto...">
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="openVoiceSearch()"><i class="fas fa-microphone"></i> Voz</button>
                    <button class="quick-action-btn" onclick="applyDiscount()"><i class="fas fa-tag"></i> Desconto</button>
                    <button class="quick-action-btn" onclick="openQuickProductModal()"><i class="fas fa-plus"></i> R√°pido</button>
                </div>
            </div>
            <div style="position:relative">
                <div class="suggestions-box" id="suggestionsBox"></div>
            </div>
            <div class="live-stats">
                <div class="stat-badge"><i class="fas fa-shopping-cart"></i><span id="liveCartCount">0 itens</span></div>
                <div class="stat-badge"><i class="fas fa-dollar-sign"></i><span id="liveCartTotal">R$ 0,00</span></div>
            </div>
            <div class="pdv-grid">
                <div class="product-list" id="productsGrid"></div>
                <div class="cart-panel">
                    <div class="cart-header">
                        <h3><i class="fas fa-shopping-basket"></i> Cesta</h3>
                        <button class="clear-cart" onclick="clearCart()" id="clearCartBtn" disabled><i class="fas fa-trash"></i> Limpar</button>
                    </div>
                    <div class="cart-items" id="cartItems">
                        <div style="text-align:center;color:#b2bec3;margin-top:50px;padding:30px">
                            <i class="fas fa-shopping-basket" style="font-size:3rem;margin-bottom:15px;opacity:.5"></i>
                            <p>Cesta vazia üçÉ</p>
                        </div>
                    </div>
                    <div class="cart-footer">
                        <div class="cart-total"><span class="cart-total-label">Total:</span><span id="cartTotal">R$ 0,00</span></div>
                        <button class="btn-checkout" id="btnCheckout" onclick="openPaymentModal()" disabled><i class="fas fa-rocket"></i> Finalizar Venda üöÄ</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- STOCK -->
        <section id="stock" class="section">
            <h2><i class="fas fa-boxes"></i> Gest√£o de Estoque üì¶</h2>
            <div class="form-add">
                <input type="text" id="newProdName" placeholder="Nome do Produto" oninput="suggestEmoji()">
                <input type="number" id="newProdPrice" placeholder="Pre√ßo (R$)" step="0.01" min="0">
                <input type="number" id="newProdStock" placeholder="Qtd" min="0">
                <select id="newProdCategory">
                    <option value="">Categoria...</option>
                    <option value="alimento">üçî Alimentos</option>
                    <option value="bebida">ü•§ Bebidas</option>
                    <option value="limpeza">üßº Limpeza</option>
                    <option value="eletronico">üì± Eletr√¥nicos</option>
                    <option value="vestuario">üëï Vestu√°rio</option>
                    <option value="outro">üì¶ Outros</option>
                </select>
                <input type="text" id="newProdEmoji" placeholder="Emoji" style="max-width:80px">
                <button class="btn-checkout" style="width:auto;padding:14px 25px" onclick="addProduct()"><i class="fas fa-plus-circle"></i> Adicionar</button>
            </div>
            <div class="table-container">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                    <h3 style="margin:0">Produtos Cadastrados</h3>
                    <div style="display:flex;gap:10px">
                        <input type="text" id="stockSearch" placeholder="Buscar..." style="width:200px" oninput="filterStockTable()">
                        <button class="quick-action-btn" onclick="exportStockCSV()"><i class="fas fa-file-export"></i> Exportar</button>
                    </div>
                </div>
                <table id="stockTable">
                    <thead><tr><th>Item</th><th>Pre√ßo</th><th>Estoque</th><th>Categoria</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="stockTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- DASHBOARD -->
        <section id="dashboard" class="section">
            <h2><i class="fas fa-chart-line"></i> Dashboard üìà</h2>
            <div class="dashboard-cards">
                <div class="card-metric"><div class="metric-icon">üí∞</div><div class="metric-info"><p>Vendas Hoje</p><h3 id="dashTotalSales">R$ 0,00</h3><p style="font-size:.8rem;color:var(--success)" id="dashSalesChange">+0% vs ontem</p></div></div>
                <div class="card-metric"><div class="metric-icon">üßæ</div><div class="metric-info"><p>Tickets</p><h3 id="dashTotalTickets">0</h3><p style="font-size:.8rem;color:var(--text-light)" id="dashAvgTicket">M√©dia: R$ 0,00</p></div></div>
                <div class="card-metric"><div class="metric-icon">üî•</div><div class="metric-info"><p>Mais Vendido</p><h3 id="dashTopProduct">-</h3><p style="font-size:.8rem;color:var(--text-light)" id="dashTopProductQty">0 unidades</p></div></div>
                <div class="card-metric"><div class="metric-icon">üì¶</div><div class="metric-info"><p>Estoque Baixo</p><h3 id="dashLowStock">0</h3><p style="font-size:.8rem;color:var(--danger)">Itens cr√≠ticos</p></div></div>
            </div>
            <div class="chart-container">
                <h3>Vendas por Dia da Semana</h3>
                <div class="chart-bars" id="salesChart"></div>
            </div>
            <div class="table-container">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                    <h3 style="margin:0">Hist√≥rico de Vendas</h3>
                    <div style="display:flex;gap:10px;align-items:center">
                        <select id="salesFilter" onchange="filterSalesHistory()" style="width:160px">
                            <option value="all">Todas as vendas</option>
                            <option value="today">Hoje</option>
                            <option value="week">Esta semana</option>
                            <option value="month">Este m√™s</option>
                        </select>
                        <button class="quick-action-btn" onclick="exportSalesCSV()"><i class="fas fa-download"></i> Exportar</button>
                    </div>
                </div>
                <table>
                    <thead><tr><th>Data/Hora</th><th>M√©todo</th><th>Itens</th><th>Total</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="salesHistoryBody"></tbody>
                </table>
            </div>
        </section>
    </main>
</div>

<!-- Badges -->
<div class="low-stock-badge" id="lowStockBadge" onclick="switchTab('stock')" style="display:none">
    <i class="fas fa-exclamation-triangle"></i>
    <div><strong id="lowStockCount">0 produtos</strong> com estoque baixo</div>
</div>
<button class="floating-action-btn" onclick="quickSale()"><i class="fas fa-bolt"></i></button>

<!-- MODALS -->
<div class="modal-overlay" id="paymentModal">
    <div class="modal-content">
        <h2>Pagamento üí∏</h2>
        <p style="color:#636e72">Total:</p>
        <p style="font-size:2.5rem;font-weight:900;color:var(--primary)" id="modalTotalValue">R$ 0,00</p>
        <div style="margin:20px 0;padding:15px;background:#f8f9fa;border-radius:16px">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Subtotal:</span><span id="modalSubtotal">R$ 0,00</span></div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Desconto:</span><span id="modalDiscount" style="color:var(--success)">R$ 0,00</span></div>
            <div style="display:flex;justify-content:space-between;font-weight:700"><span>Total:</span><span id="modalTotalWithDiscount">R$ 0,00</span></div>
        </div>
        <div class="payment-options">
            <button class="btn-pay" onclick="processPayment('Pix')"><i class="fas fa-qrcode"></i> üí† Pix (5% OFF)</button>
            <button class="btn-pay" onclick="processPayment('Cart√£o Cr√©dito')"><i class="fas fa-credit-card"></i> üí≥ Cr√©dito</button>
            <button class="btn-pay" onclick="processPayment('Cart√£o D√©bito')"><i class="fas fa-credit-card"></i> üí≥ D√©bito</button>
            <button class="btn-pay" onclick="processPayment('Dinheiro')"><i class="fas fa-money-bill-wave"></i> üíµ Dinheiro</button>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px">
            <button class="btn-checkout" style="background:#ff7675;flex:1" onclick="closePaymentModal()"><i class="fas fa-times"></i> Cancelar</button>
            <button class="btn-checkout" style="flex:2" onclick="applyDiscountToSale(10)"><i class="fas fa-tag"></i> 10% OFF</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="receiptModal">
    <div class="modal-content">
        <h2>Venda Finalizada! üéâ</h2>
        <p style="color:#636e72;margin-bottom:20px">Comprovante gerado com sucesso!</p>
        <div style="background:#f8f9fa;padding:20px;border-radius:16px;margin-bottom:25px;text-align:left">
            <p><strong>ID:</strong> <span id="receiptId">#0000</span></p>
            <p><strong>Data:</strong> <span id="receiptDate">-</span></p>
            <p><strong>M√©todo:</strong> <span id="receiptMethod">-</span></p>
            <p><strong>Total:</strong> <span id="receiptTotal" style="font-weight:900;color:var(--primary)">R$ 0,00</span></p>
        </div>
        <div class="receipt-options">
            <button class="btn-receipt" onclick="printReceiptFromModal()"><i class="fas fa-print"></i> üñ®Ô∏è Imprimir</button>
            <button class="btn-receipt btn-whatsapp" onclick="sendViaWhatsapp()"><i class="fab fa-whatsapp"></i> üì± WhatsApp</button>
            <button class="btn-receipt btn-email" onclick="sendViaEmail()"><i class="fas fa-envelope"></i> üìß Email</button>
        </div>
        <button class="btn-checkout" style="background:#b2bec3;margin-top:20px" onclick="closeReceiptModal()"><i class="fas fa-redo"></i> Nova Venda</button>
    </div>
</div>

<div class="modal-overlay" id="quickProductModal">
    <div class="modal-content">
        <h2>Produto R√°pido ‚ö°</h2>
        <div style="margin:25px 0;display:flex;flex-direction:column;gap:15px">
            <input type="text" id="quickProdName" placeholder="Nome do produto">
            <input type="number" id="quickProdPrice" placeholder="Pre√ßo (R$)" step="0.01" min="0">
            <div style="display:flex;gap:10px">
                <button class="btn-checkout" style="flex:1;background:#ff7675" onclick="closeQuickProductModal()">Cancelar</button>
                <button class="btn-checkout" style="flex:2" onclick="addQuickProduct()"><i class="fas fa-bolt"></i> Adicionar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="accountModal">
    <div class="modal-content">
        <h2>Minha Conta üë§</h2>
        <div style="text-align:center;margin-bottom:25px">
            <div style="width:80px;height:80px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 15px;color:white;font-size:2rem">üëë</div>
            <h3 id="accountCompanyName">-</h3>
            <p style="color:var(--text-light)" id="accountEmail">-</p>
            <span class="mode-badge" id="modeBadge">-</span>
        </div>
        <div style="background:#f8f9fa;padding:20px;border-radius:16px;margin-bottom:25px">
            <div style="display:flex;justify-content:space-between;margin-bottom:10px"><span>Plano:</span><span style="font-weight:700;color:var(--primary)" id="accountPlanStatus">-</span></div>
            <div style="display:flex;justify-content:space-between;margin-bottom:10px"><span>V√°lido at√©:</span><span style="font-weight:700" id="accountValidUntil">-</span></div>
            <div style="display:flex;justify-content:space-between"><span>CNPJ/CPF:</span><span style="font-weight:700" id="accountDocument">-</span></div>
        </div>
        <div style="display:grid;gap:10px">
            <button class="btn-checkout" style="background:#ff7675" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair do Sistema</button>
        </div>
    </div>
</div>

<div id="toast" class="toast">
    <i class="fas fa-check-circle toast-icon"></i>
    <span class="toast-message">OK</span>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDV M√ÅGICO PRO ‚Äî VERS√ÉO CORRIGIDA COM SUPABASE AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const APP_NAME   = "PDV M√°gico Pro";
const APP_VER    = "3.0.0";
const TRIAL_DAYS = 7;
const PRICE      = 29.90;

// ‚îÄ‚îÄ SUPABASE CONFIG ‚îÄ‚îÄ
const SB_URL  = 'https://qdrassirutbfvhvepwdd.supabase.co';
const SB_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcmFzc2lydXRiZnZodmVwd2RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODA2ODUsImV4cCI6MjA4NzU1NjY4NX0.9zPKrANHVDLOLm-e7yANAu4vr8s9QjsX_tG72AygKEM';

let sb = null;
let useLocal = true; // come√ßa em local, tenta Supabase
let currentUser = null;

// ‚îÄ‚îÄ INIT SUPABASE ‚îÄ‚îÄ
function initSB() {
    try {
        if (window.supabase && window.supabase.createClient) {
            sb = window.supabase.createClient(SB_URL, SB_KEY);
            useLocal = false;
            console.log('‚úÖ Supabase Auth pronto');
        } else {
            throw new Error('lib n√£o carregada');
        }
    } catch(e) {
        console.warn('‚ö†Ô∏è Supabase indispon√≠vel ‚Äî usando localStorage:', e.message);
        useLocal = true;
    }
}

// ‚îÄ‚îÄ PRODUTOS PADR√ÉO ‚îÄ‚îÄ
const DEFAULT_PRODUCTS = [
    {id:1,name:'Hamb√∫rguer M√°gico',price:25.00,stock:20,emoji:'üçî',category:'alimento'},
    {id:2,name:'Po√ß√£o de Cafe√≠na',price:8.50,stock:50,emoji:'‚òï',category:'bebida'},
    {id:3,name:'Donut Estelar',price:12.00,stock:15,emoji:'üç©',category:'alimento'},
    {id:4,name:'Pizza Infinita',price:45.00,stock:8,emoji:'üçï',category:'alimento'},
    {id:5,name:'Sushi Zen',price:60.00,stock:10,emoji:'üç£',category:'alimento'},
    {id:6,name:'Sorvete Nuvem',price:15.00,stock:25,emoji:'üç¶',category:'alimento'},
    {id:7,name:'Suco Vitamina',price:12.00,stock:40,emoji:'ü•§',category:'bebida'},
    {id:8,name:'Camisa M√°gica',price:89.90,stock:12,emoji:'üëï',category:'vestuario'},
    {id:9,name:'Fones Celestial',price:120.00,stock:5,emoji:'üéß',category:'eletronico'},
    {id:10,name:'Chocolat√£o',price:9.00,stock:35,emoji:'üç´',category:'alimento'},
];

// ‚îÄ‚îÄ ESTADO ‚îÄ‚îÄ
let products = [];
let salesHistory = [];
let cart = [];
let currentSaleData = null;
let currentDiscount = 0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTENTICA√á√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showLogin()    { document.getElementById('loginCard').style.display='block'; document.getElementById('registerCard').style.display='none'; }
function showRegister() { document.getElementById('loginCard').style.display='none'; document.getElementById('registerCard').style.display='block'; }
function showErr(id, msg) { const el=document.getElementById(id); el.textContent=msg; el.classList.add('show'); }
function hideErr(id) { document.getElementById(id).classList.remove('show'); }

async function loginUser() {
    hideErr('loginError');
    const email = document.getElementById('loginEmail').value.trim();
    const pass  = document.getElementById('loginPassword').value;
    if (!email || !pass) { showErr('loginError','Preencha email e senha.'); return; }

    const btn = document.getElementById('loginBtn');
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
    showLoader();

    try {
        if (useLocal) {
            loginLocal(email, pass);
        } else {
            await loginSupabase(email, pass);
        }
    } catch(e) {
        hideLoader();
        btn.disabled=false; btn.innerHTML='<i class="fas fa-sign-in-alt"></i> Entrar no Sistema';
        showErr('loginError', e.message);
    }
}

async function loginSupabase(email, pass) {
    const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
    if (error) {
        // Tentar mensagem amig√°vel
        let msg = 'Email ou senha incorretos.';
        if (error.message.includes('Email not confirmed')) msg = 'Confirme seu email antes de fazer login. Verifique sua caixa de entrada.';
        throw new Error(msg);
    }
    // Buscar perfil
    const { data: profile } = await sb.from('profiles').select('*').eq('id', data.user.id).single();
    currentUser = {
        id: data.user.id,
        email: data.user.email,
        companyName: profile?.company_name || 'Empresa',
        document: profile?.document || '',
        phone: profile?.phone || '',
        plan: profile?.plan || 'professional',
        isTrial: profile?.is_trial ?? true,
        validUntil: profile?.valid_until || new Date(Date.now()+TRIAL_DAYS*86400000).toISOString(),
        source: 'supabase'
    };
    afterLogin();
}

function loginLocal(email, pass) {
    const users = JSON.parse(localStorage.getItem('pdv_users')||'[]');
    const u = users.find(x => x.email===email && x.password===pass);
    if (!u) throw new Error('Email ou senha incorretos.');
    if (new Date() > new Date(u.validUntil)) throw new Error('Assinatura expirada. Renove para continuar.');
    currentUser = {...u, source:'local'};
    afterLogin();
}

async function registerUser() {
    hideErr('registerError');
    const company = document.getElementById('regCompany').value.trim();
    const doc     = document.getElementById('regDocument').value.trim();
    const phone   = document.getElementById('regPhone').value.trim();
    const email   = document.getElementById('regEmail').value.trim();
    const pass    = document.getElementById('regPassword').value;
    const pass2   = document.getElementById('regConfirmPassword').value;
    const terms   = document.getElementById('regTerms').checked;

    if (!company||!doc||!phone||!email||!pass||!pass2) { showErr('registerError','Preencha todos os campos.'); return; }
    if (pass !== pass2) { showErr('registerError','As senhas n√£o coincidem.'); return; }
    if (pass.length < 6)  { showErr('registerError','Senha m√≠nima: 6 caracteres.'); return; }
    if (!terms) { showErr('registerError','Aceite os termos de uso.'); return; }

    const btn = document.getElementById('registerBtn');
    btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Criando conta...';
    showLoader();

    try {
        if (useLocal) {
            registerLocal({company,doc,phone,email,pass});
        } else {
            await registerSupabase({company,doc,phone,email,pass});
        }
    } catch(e) {
        hideLoader();
        btn.disabled=false; btn.innerHTML='<i class="fas fa-rocket"></i> Come√ßar Per√≠odo Gr√°tis';
        showErr('registerError', e.message);
    }
}

async function registerSupabase({company,doc,phone,email,pass}) {
    const trialEnd = new Date(Date.now()+TRIAL_DAYS*86400000).toISOString();

    // 1. Criar usu√°rio no Auth
    const { data, error } = await sb.auth.signUp({ email, password: pass });
    if (error) {
        let msg = error.message;
        if (msg.includes('already registered')) msg = 'Este email j√° est√° cadastrado.';
        throw new Error(msg);
    }

    const uid = data.user.id;

    // 2. Salvar perfil (tabela p√∫blica)
    await sb.from('profiles').upsert({
        id: uid,
        company_name: company,
        document: doc,
        phone: phone,
        plan: 'professional',
        is_trial: true,
        valid_until: trialEnd
    });

    // 3. Criar produtos padr√£o
    const prods = DEFAULT_PRODUCTS.map(p=>({...p, id:undefined, user_id:uid}));
    await sb.from('products').insert(prods);

    hideLoader();
    showToast('Conta criada! Verifique seu email para confirmar e depois fa√ßa login. üìß','info',8000);
    showLogin();
    document.getElementById('loginEmail').value = email;
    document.getElementById('registerBtn').disabled=false;
    document.getElementById('registerBtn').innerHTML='<i class="fas fa-rocket"></i> Come√ßar Per√≠odo Gr√°tis';
}

function registerLocal({company,doc,phone,email,pass}) {
    const users = JSON.parse(localStorage.getItem('pdv_users')||'[]');
    if (users.find(u=>u.email===email)) throw new Error('Email j√° cadastrado.');
    const trialEnd = new Date(Date.now()+TRIAL_DAYS*86400000).toISOString();
    const uid = 'LOCAL_'+Date.now();
    const newUser = {id:uid,email,password:pass,companyName:company,document:doc,phone,plan:'professional',isTrial:true,validUntil:trialEnd,createdAt:new Date().toISOString()};
    users.push(newUser);
    localStorage.setItem('pdv_users',JSON.stringify(users));
    // dados iniciais
    localStorage.setItem('pdv_data_'+uid, JSON.stringify({products:DEFAULT_PRODUCTS,salesHistory:[]}));
    hideLoader();
    showToast('Conta criada com sucesso! Fazendo login... üéâ','success');
    setTimeout(()=>{ document.getElementById('loginEmail').value=email; document.getElementById('loginPassword').value=pass; loginUser(); },1200);
}

function afterLogin() {
    loadUserData();
    document.getElementById('authContainer').style.display='none';
    document.getElementById('appContainer').style.display='grid';
    updateSubscriptionStatus();
    initApp();
    showToast(`Bem-vindo, ${currentUser.companyName}! üëã`,'success');
}

async function loadUserData() {
    if (useLocal || currentUser.source==='local') {
        const d = JSON.parse(localStorage.getItem('pdv_data_'+currentUser.id)||'null');
        products = d?.products || DEFAULT_PRODUCTS;
        salesHistory = d?.salesHistory || [];
    } else {
        // Supabase
        try {
            const {data:prods} = await sb.from('products').select('*').eq('user_id',currentUser.id);
            products = prods?.length ? prods : DEFAULT_PRODUCTS;
            const {data:sales} = await sb.from('sales').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}).limit(50);
            salesHistory = sales || [];
        } catch(e) {
            console.error('Erro ao carregar dados Supabase:',e);
            products = DEFAULT_PRODUCTS;
            salesHistory = [];
        }
    }
}

async function saveData() {
    if (!currentUser) return;
    if (useLocal || currentUser.source==='local') {
        localStorage.setItem('pdv_data_'+currentUser.id, JSON.stringify({products,salesHistory}));
    } else {
        // sync products
        for (const p of products) {
            if (p.id && !String(p.id).startsWith('LOCAL')) {
                await sb.from('products').upsert({...p, user_id:currentUser.id}).catch(()=>{});
            }
        }
    }
}

async function logout() {
    if (!confirm('Sair do sistema?')) return;
    await saveData();
    if (!useLocal && !currentUser?.source?.includes('local')) await sb.auth.signOut().catch(()=>{});
    currentUser=null; cart=[]; products=[]; salesHistory=[];
    document.getElementById('appContainer').style.display='none';
    document.getElementById('authContainer').style.display='flex';
    document.getElementById('loginCard').style.display='block';
    document.getElementById('registerCard').style.display='none';
    document.getElementById('loginPassword').value='';
    document.getElementById('accountModal').style.display='none';
    showToast('At√© logo! üëã','info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initApp() {
    setTimeout(()=>{
        renderAll();
        setupBarcodeScanner();
        setupKeyboard();
        checkLowStock();
        updateLiveStats();
        hideLoader();
        startSaleTimer();
    },600);
    setInterval(saveData,30000);
    setInterval(checkLowStock,10000);
}

function renderAll() { renderPOS(); renderStock(); updateDashboard(); generateSalesChart(); }

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function switchTab(tab) {
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    const idx = ['pdv','stock','dashboard'].indexOf(tab);
    if (idx>=0) document.querySelectorAll('.nav-btn')[idx].classList.add('active');
    if (tab==='dashboard'){updateDashboard();generateSalesChart();}
    if (tab==='pdv'){setTimeout(()=>{document.getElementById('barcodeInput').focus();},100);}
    if (tab==='stock'){filterStockTable();}
}

// ‚îÄ‚îÄ SUBSCRIPTION ‚îÄ‚îÄ
function updateSubscriptionStatus() {
    if (!currentUser) return;
    const el = document.getElementById('subscriptionStatus');
    const daysLeft = Math.ceil((new Date(currentUser.validUntil)-new Date())/(86400000));
    if (currentUser.isTrial) {
        el.innerHTML=`<i class="fas fa-star"></i><span>Trial: ${daysLeft}d</span>`;
        el.style.background = daysLeft<=3 ? 'var(--danger)':'var(--warning)';
        el.style.color = daysLeft<=3 ? 'white':'var(--text)';
    } else {
        el.innerHTML=`<i class="fas fa-crown"></i><span>Plano Ativo</span>`;
        el.style.background='var(--success)'; el.style.color='white';
    }
}

function openAccountModal() {
    if (!currentUser) return;
    document.getElementById('accountCompanyName').textContent = currentUser.companyName;
    document.getElementById('accountEmail').textContent = currentUser.email;
    document.getElementById('accountDocument').textContent = currentUser.document || '-';
    document.getElementById('accountValidUntil').textContent = new Date(currentUser.validUntil).toLocaleDateString('pt-BR');
    document.getElementById('accountPlanStatus').textContent = currentUser.isTrial?'TRIAL':'PROFISSIONAL';
    const mb = document.getElementById('modeBadge');
    mb.textContent = useLocal||currentUser.source==='local'?'üíæ Modo Local':'‚òÅÔ∏è Modo Nuvem';
    mb.className = 'mode-badge '+(useLocal||currentUser.source==='local'?'mode-local':'mode-cloud');
    document.getElementById('accountModal').style.display='flex';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDV / CART
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let saleStart = null;
function startSaleTimer() { saleStart = Date.now(); }

function renderPOS() {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML='';
    products.forEach(p=>{
        const sc = p.stock<3?'stock-low':p.stock<10?'stock-medium':'stock-high';
        const inCart = (cart.find(i=>i.id===p.id)||{qty:0}).qty;
        const card = document.createElement('div');
        card.className='product-card';
        card.setAttribute('data-product-id',p.id);
        card.onclick=()=>addToCart(p.id);
        card.innerHTML=`
            <span class="product-stock ${sc}">${p.stock}</span>
            <span class="product-emoji floating">${p.emoji}</span>
            <div class="product-name">${p.name}</div>
            ${p.category?`<div class="product-category">${getCatName(p.category)}</div>`:''}
            <div class="product-price">R$ ${p.price.toFixed(2)}</div>
            ${inCart>0?`<div style="margin-top:8px;background:var(--primary);color:white;padding:4px 10px;border-radius:10px;font-size:.8rem">${inCart} no carrinho</div>`:''}
        `;
        grid.appendChild(card);
    });
}

function getCatName(k) {
    return {alimento:'üçî Alimento',bebida:'ü•§ Bebida',limpeza:'üßº Limpeza',eletronico:'üì± Eletr√¥nico',vestuario:'üëï Vestu√°rio',outro:'üì¶ Outro'}[k]||k;
}

function addToCart(id) {
    const p = products.find(x=>x.id===id);
    if (!p) return;
    const ci = cart.find(i=>i.id===id);
    if (p.stock<=(ci?ci.qty:0)){ showToast(`Estoque insuficiente: ${p.name}`,'warning'); return; }
    if (ci) ci.qty++; else cart.push({...p,qty:1});
    updateCartUI(); updateNotifications();
    showToast(`${p.name} adicionado ‚úÖ`,'success');
}

function removeFromCart(id,all=false) {
    const idx=cart.findIndex(i=>i.id===id);
    if(idx<0)return;
    const it=cart[idx];
    if(all||it.qty<=1) cart.splice(idx,1); else it.qty--;
    updateCartUI(); updateNotifications();
}

function updateCartItemQty(id,qty) {
    if(qty<1){removeFromCart(id,true);return;}
    const ci=cart.find(i=>i.id===id);
    const p=products.find(x=>x.id===id);
    if(ci&&p&&qty<=p.stock){ci.qty=qty;updateCartUI();}
    else showToast('Estoque insuficiente','warning');
}

function clearCart() {
    if(!cart.length)return;
    if(confirm('Limpar carrinho?')){cart=[];currentDiscount=0;updateCartUI();updateNotifications();}
}

function updateCartUI() {
    const container=document.getElementById('cartItems');
    const totalEl=document.getElementById('cartTotal');
    const btn=document.getElementById('btnCheckout');
    const ccBtn=document.getElementById('clearCartBtn');
    if(!cart.length){
        container.innerHTML=`<div style="text-align:center;color:#b2bec3;margin-top:50px;padding:30px"><i class="fas fa-shopping-basket" style="font-size:3rem;margin-bottom:15px;opacity:.5"></i><p>Cesta vazia üçÉ</p></div>`;
        totalEl.textContent='R$ 0,00'; btn.disabled=true; ccBtn.disabled=true;
        document.getElementById('liveCartCount').textContent='0 itens';
        document.getElementById('liveCartTotal').textContent='R$ 0,00';
        return;
    }
    let sub=0,html='';
    cart.forEach(it=>{
        const tot=it.price*it.qty; sub+=tot;
        html+=`<div class="cart-item">
            <div class="cart-item-info">
                <div class="cart-item-name">${it.emoji} ${it.name}</div>
                <div style="color:#636e72;font-size:.85rem">R$ ${it.price.toFixed(2)} un</div>
                <div class="cart-item-qty">
                    <button class="qty-btn" onclick="updateCartItemQty(${it.id},${it.qty-1})">-</button>
                    <span style="font-weight:700;min-width:24px;text-align:center">${it.qty}</span>
                    <button class="qty-btn" onclick="updateCartItemQty(${it.id},${it.qty+1})">+</button>
                    <span style="margin-left:8px;color:var(--primary);font-weight:700">R$ ${tot.toFixed(2)}</span>
                </div>
            </div>
            <div class="remove-btn" onclick="removeFromCart(${it.id},true)"><i class="fas fa-trash"></i></div>
        </div>`;
    });
    const disc=sub*(currentDiscount/100);
    const total=sub-disc;
    container.innerHTML=html;
    totalEl.textContent=`R$ ${total.toFixed(2)}`;
    btn.disabled=false; ccBtn.disabled=false;
    const totalItems=cart.reduce((a,i)=>a+i.qty,0);
    document.getElementById('liveCartCount').textContent=`${totalItems} ${totalItems===1?'item':'itens'}`;
    document.getElementById('liveCartTotal').textContent=`R$ ${total.toFixed(2)}`;
}

function updateLiveStats() { updateCartUI(); }

// ‚îÄ‚îÄ DESCONTO ‚îÄ‚îÄ
function applyDiscount(pct=null) {
    if(!cart.length){showToast('Adicione produtos primeiro','warning');return;}
    if(pct===null){const v=prompt('Desconto (%):','10');if(!v)return;pct=parseFloat(v);if(isNaN(pct)||pct<0||pct>100){showToast('Valor inv√°lido','error');return;}}
    currentDiscount=pct; updateCartUI(); showToast(`Desconto ${pct}% aplicado!`,'success');
}
function applyDiscountToSale(p){applyDiscount(p);}

// ‚îÄ‚îÄ PAGAMENTO ‚îÄ‚îÄ
function openPaymentModal() {
    if(!cart.length){showToast('Carrinho vazio','warning');return;}
    const sub=cart.reduce((a,i)=>a+i.price*i.qty,0);
    const disc=sub*(currentDiscount/100);
    const total=sub-disc;
    document.getElementById('modalSubtotal').textContent=`R$ ${sub.toFixed(2)}`;
    document.getElementById('modalDiscount').textContent=`-R$ ${disc.toFixed(2)}`;
    document.getElementById('modalTotalValue').textContent=`R$ ${total.toFixed(2)}`;
    document.getElementById('modalTotalWithDiscount').textContent=`R$ ${total.toFixed(2)}`;
    document.getElementById('paymentModal').style.display='flex';
}
function closePaymentModal(){document.getElementById('paymentModal').style.display='none';}

async function processPayment(method) {
    showLoader();
    let sub=0;
    const cartCopy=JSON.parse(JSON.stringify(cart));
    cartCopy.forEach(it=>{sub+=it.price*it.qty;});
    const disc=sub*(currentDiscount/100);
    let total=sub-disc;
    let pm=method;
    if(method==='Pix'){total*=0.95;pm='Pix (5% OFF)';}

    const sid='V'+Date.now().toString().slice(-6);
    const sale={
        id:sid,
        date:new Date().toLocaleString('pt-BR'),
        timestamp:Date.now(),
        subtotal:sub, discount:disc, total,
        itemsCount:cartCopy.reduce((a,i)=>a+i.qty,0),
        items:cartCopy, method:pm,
        processingTime:saleStart?((Date.now()-saleStart)/1000).toFixed(1)+'s':'0s'
    };

    // Baixar estoque
    cartCopy.forEach(ci=>{
        const p=products.find(x=>x.id===ci.id);
        if(p) p.stock=Math.max(0,p.stock-ci.qty);
    });

    salesHistory.unshift(sale);
    currentSaleData=sale;
    cart=[]; currentDiscount=0;
    await saveData();

    // Salvar no Supabase se dispon√≠vel
    if(!useLocal && currentUser?.source!=='local'){
        try{
            await sb.from('sales').insert({
                id:sid, user_id:currentUser.id,
                subtotal:sub, discount:disc, total,
                items_count:sale.itemsCount,
                payment_method:pm,
                receipt_data:{items:cartCopy}
            });
        }catch(e){console.warn('Venda salva apenas localmente:',e);}
    }

    updateCartUI(); renderPOS(); renderStock();
    hideLoader(); closePaymentModal();
    showToast(`Venda #${sid} finalizada! üéâ`,'success');
    updateDashboard(); generateSalesChart();
    setTimeout(openReceiptModal,800);
}

// ‚îÄ‚îÄ RECIBO ‚îÄ‚îÄ
function openReceiptModal(){
    if(!currentSaleData)return;
    document.getElementById('receiptId').textContent=currentSaleData.id;
    document.getElementById('receiptDate').textContent=currentSaleData.date;
    document.getElementById('receiptMethod').textContent=currentSaleData.method;
    document.getElementById('receiptTotal').textContent=`R$ ${currentSaleData.total.toFixed(2)}`;
    document.getElementById('receiptModal').style.display='flex';
}
function closeReceiptModal(){document.getElementById('receiptModal').style.display='none';currentSaleData=null;setTimeout(()=>{document.getElementById('barcodeInput').focus();startSaleTimer();},300);}

function printReceiptFromModal(){
    if(!currentSaleData)return;
    const s=currentSaleData;
    const win=window.open('','Receipt','width=320,height=600');
    const items=s.items.map(i=>`<div>${i.qty}x ${i.name}<span style="float:right">R$ ${(i.price*i.qty).toFixed(2)}</span></div>`).join('');
    win.document.write(`<html><head><style>body{font-family:monospace;font-size:12px;padding:15px}hr{border:none;border-top:1px dashed #000}.r{text-align:right}</style></head><body>
        <div style="text-align:center"><b>${APP_NAME.toUpperCase()}</b><br>${s.date}<br>ID: ${s.id}</div>
        <hr>${items}<hr>
        <div class="r">Subtotal: R$ ${s.subtotal.toFixed(2)}</div>
        ${s.discount>0?`<div class="r">Desconto: -R$ ${s.discount.toFixed(2)}</div>`:''}
        <div class="r"><b>TOTAL: R$ ${s.total.toFixed(2)}</b></div>
        <hr><div>Pagamento: ${s.method}</div>
        <div style="text-align:center;margin-top:20px">Obrigado! üåü</div>
        <script>setTimeout(()=>{window.print();setTimeout(()=>window.close(),300)},200)<\/script>
    </body></html>`);
    win.document.close();
}

function sendViaWhatsapp(){
    if(!currentSaleData)return;
    const s=currentSaleData;
    let t=`*${APP_NAME}*%0AID: ${s.id}%0AData: ${s.date}%0A---%0A`;
    s.items.forEach(i=>{t+=`${i.qty}x ${i.name}: R$ ${(i.price*i.qty).toFixed(2)}%0A`;});
    t+=`---%0ATotal: *R$ ${s.total.toFixed(2)}*%0A${s.method}%0AObrigado! üåü`;
    window.open(`https://api.whatsapp.com/send?text=${t}`,'_blank');
}

function sendViaEmail(){
    if(!currentSaleData)return;
    const s=currentSaleData;
    let b=`${APP_NAME} - Comprovante\nID: ${s.id}\nData: ${s.date}\n\nITENS:\n`;
    s.items.forEach(i=>{b+=`${i.qty}x ${i.name} - R$ ${(i.price*i.qty).toFixed(2)}\n`;});
    b+=`\nTotal: R$ ${s.total.toFixed(2)}\nPagamento: ${s.method}\n\nObrigado!`;
    window.location.href=`mailto:?subject=${encodeURIComponent('Comprovante '+s.id)}&body=${encodeURIComponent(b)}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTOQUE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStock(){
    const tbody=document.getElementById('stockTableBody');
    tbody.innerHTML='';
    products.forEach(p=>{
        const sc=p.stock<5?'stock-low':p.stock<15?'stock-medium':'stock-high';
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${p.emoji} ${p.name}</td>
            <td>R$ ${p.price.toFixed(2)}</td>
            <td><span class="product-stock ${sc}" style="position:static;display:inline-block">${p.stock}</span>
                <input type="number" value="${p.stock}" onchange="updateStock(${p.id},this.value)" style="width:65px;padding:5px 8px;border-radius:8px;border:1px solid #dfe6e9;margin-left:8px"></td>
            <td>${getCatName(p.category)||'-'}</td>
            <td>
                <button onclick="editProduct(${p.id})" style="background:var(--secondary);color:white;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;margin-right:5px"><i class="fas fa-edit"></i></button>
                <button onclick="deleteProduct(${p.id})" style="background:var(--danger);color:white;border:none;padding:5px 10px;border-radius:6px;cursor:pointer"><i class="fas fa-trash"></i></button>
            </td>`;
        tbody.appendChild(tr);
    });
}

function filterStockTable(){
    const q=document.getElementById('stockSearch').value.toLowerCase();
    document.querySelectorAll('#stockTableBody tr').forEach(r=>{r.style.display=r.textContent.toLowerCase().includes(q)?'':'none';});
}

async function addProduct(){
    const name=document.getElementById('newProdName').value.trim();
    const price=parseFloat(document.getElementById('newProdPrice').value);
    const stock=parseInt(document.getElementById('newProdStock').value);
    const emoji=document.getElementById('newProdEmoji').value.trim()||'üì¶';
    const cat=document.getElementById('newProdCategory').value||'outro';
    if(!name||isNaN(price)||price<=0||isNaN(stock)||stock<0){showToast('Preencha os campos corretamente','error');return;}
    const newId=products.length?Math.max(...products.map(p=>typeof p.id==='number'?p.id:0))+1:1;
    const np={id:newId,name,price,stock,emoji:emoji.charAt(0)||'üì¶',category:cat};
    
    if(!useLocal&&currentUser?.source!=='local'){
        try{
            const {data,error}=await sb.from('products').insert({...np,id:undefined,user_id:currentUser.id}).select().single();
            if(!error&&data){np.id=data.id;}
        }catch(e){console.warn('Produto salvo localmente:',e);}
    }
    
    products.push(np);
    await saveData();
    document.getElementById('newProdName').value='';
    document.getElementById('newProdPrice').value='';
    document.getElementById('newProdStock').value='';
    document.getElementById('newProdEmoji').value='';
    document.getElementById('newProdCategory').value='';
    showToast(`"${name}" adicionado!`,'success');
    renderStock(); renderPOS(); checkLowStock();
}

function editProduct(id){
    const p=products.find(x=>x.id===id);
    if(!p)return;
    document.getElementById('newProdName').value=p.name;
    document.getElementById('newProdPrice').value=p.price;
    document.getElementById('newProdStock').value=p.stock;
    document.getElementById('newProdEmoji').value=p.emoji;
    document.getElementById('newProdCategory').value=p.category||'';
    const btn=document.querySelector('.btn-checkout[onclick="addProduct()"]');
    if(btn){btn.innerHTML='<i class="fas fa-save"></i> Salvar';btn.setAttribute('onclick',`saveEdit(${id})`);}
    window.scrollTo({top:0,behavior:'smooth'});
}

async function saveEdit(id){
    const p=products.find(x=>x.id===id);
    if(!p)return;
    p.name=document.getElementById('newProdName').value.trim();
    p.price=parseFloat(document.getElementById('newProdPrice').value)||p.price;
    p.stock=parseInt(document.getElementById('newProdStock').value)||p.stock;
    p.emoji=document.getElementById('newProdEmoji').value.charAt(0)||p.emoji;
    p.category=document.getElementById('newProdCategory').value||p.category;
    await saveData();
    const btn=document.querySelector('.btn-checkout[onclick^="saveEdit"]');
    if(btn){btn.innerHTML='<i class="fas fa-plus-circle"></i> Adicionar';btn.setAttribute('onclick','addProduct()');}
    showToast(`"${p.name}" atualizado!`,'success');
    renderStock(); renderPOS();
}

async function updateStock(id,qty){
    const p=products.find(x=>x.id===id);
    if(!p)return;
    p.stock=Math.max(0,parseInt(qty)||0);
    if(!useLocal&&currentUser?.source!=='local'){
        await sb.from('products').update({stock:p.stock}).eq('id',id).catch(()=>{});
    }
    await saveData();
    checkLowStock(); renderStock(); renderPOS();
}

async function deleteProduct(id){
    const p=products.find(x=>x.id===id);
    if(!p||!confirm(`Excluir "${p.name}"?`))return;
    if(!useLocal&&currentUser?.source!=='local'){
        await sb.from('products').delete().eq('id',id).catch(()=>{});
    }
    products=products.filter(x=>x.id!==id);
    cart=cart.filter(i=>i.id!==id);
    await saveData();
    showToast(`"${p.name}" exclu√≠do`,'info');
    renderStock(); renderPOS(); updateCartUI(); checkLowStock();
}

function checkLowStock(){
    const n=products.filter(p=>p.stock<5).length;
    const nb=document.getElementById('stockNotification');
    const lb=document.getElementById('lowStockBadge');
    if(n>0){nb.textContent=n;nb.style.display='flex';lb.style.display='flex';document.getElementById('lowStockCount').textContent=`${n} produto${n>1?'s':''}`;}
    else{nb.style.display='none';lb.style.display='none';}
    document.getElementById('dashLowStock').textContent=n;
}

function exportStockCSV(){
    let csv='Produto;Pre√ßo;Estoque;Categoria\n';
    products.forEach(p=>{csv+=`"${p.name}";${p.price.toFixed(2)};${p.stock};${p.category||''}\n`;});
    dlCSV(csv,`estoque_${now()}.csv`);
    showToast('Estoque exportado!','success');
}

function suggestEmoji(){
    const n=document.getElementById('newProdName').value.toLowerCase();
    const map={hamburguer:'üçî',pizza:'üçï',cafe:'‚òï',suco:'ü•§',cerveja:'üç∫',sorvete:'üç¶',chocolate:'üç´',frango:'üçó',carne:'ü•©',camisa:'üëï',calca:'üëñ',celular:'üì±',notebook:'üíª',relogio:'‚åö',sabao:'üßº',livro:'üìö'};
    for(const [k,v] of Object.entries(map)){if(n.includes(k)){document.getElementById('newProdEmoji').value=v;break;}}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDashboard(){
    const today=new Date().toDateString();
    const todaySales=salesHistory.filter(s=>new Date(s.timestamp).toDateString()===today);
    const todayTotal=todaySales.reduce((a,s)=>a+s.total,0);
    document.getElementById('dashTotalSales').textContent=`R$ ${todayTotal.toFixed(2)}`;
    document.getElementById('dashTotalTickets').textContent=todaySales.length;
    const avg=todaySales.length?todayTotal/todaySales.length:0;
    document.getElementById('dashAvgTicket').textContent=`M√©dia: R$ ${avg.toFixed(2)}`;
    // top product
    const freq={};
    salesHistory.forEach(s=>(s.items||[]).forEach(i=>{freq[i.name]=(freq[i.name]||0)+i.qty;}));
    const top=Object.entries(freq).sort((a,b)=>b[1]-a[1])[0];
    document.getElementById('dashTopProduct').textContent=top?top[0].substring(0,15):'-';
    document.getElementById('dashTopProductQty').textContent=top?`${top[1]} un`:'0 un';
    checkLowStock();
    renderSalesHistory();
}

function renderSalesHistory(){
    const tbody=document.getElementById('salesHistoryBody');
    const f=document.getElementById('salesFilter').value;
    const now2=new Date();
    let list=salesHistory;
    if(f==='today'){const d=now2.toDateString();list=list.filter(s=>new Date(s.timestamp).toDateString()===d);}
    else if(f==='week'){const w=new Date(now2-7*86400000);list=list.filter(s=>new Date(s.timestamp)>=w);}
    else if(f==='month'){const m=new Date(now2-30*86400000);list=list.filter(s=>new Date(s.timestamp)>=m);}
    list=list.slice(0,15);
    if(!list.length){tbody.innerHTML=`<tr><td colspan="5" style="text-align:center;color:#b2bec3;padding:40px">Nenhuma venda no per√≠odo</td></tr>`;return;}
    tbody.innerHTML=list.map(s=>`<tr>
        <td>${s.date}</td>
        <td>${s.method}</td>
        <td>${s.itemsCount} itens</td>
        <td style="font-weight:700;color:var(--primary)">R$ ${s.total.toFixed(2)}</td>
        <td><button onclick="viewSale('${s.id}')" style="background:var(--primary);color:white;border:none;padding:5px 10px;border-radius:6px;cursor:pointer"><i class="fas fa-eye"></i></button></td>
    </tr>`).join('');
}

function filterSalesHistory(){renderSalesHistory();}

function viewSale(id){
    const s=salesHistory.find(x=>x.id===id);
    if(!s)return;
    let d=`Venda: ${s.id}\nData: ${s.date}\nPagamento: ${s.method}\nSubtotal: R$ ${s.subtotal.toFixed(2)}\nDesconto: R$ ${s.discount.toFixed(2)}\nTotal: R$ ${s.total.toFixed(2)}\n\nITENS:\n`;
    (s.items||[]).forEach(i=>{d+=`${i.qty}x ${i.name} ‚Äî R$ ${(i.price*i.qty).toFixed(2)}\n`;});
    alert(d);
}

function generateSalesChart(){
    const el=document.getElementById('salesChart');
    const days=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
    const vals=[0,0,0,0,0,0,0];
    salesHistory.forEach(s=>{vals[new Date(s.timestamp).getDay()]+=s.total;});
    const mx=Math.max(...vals,1);
    el.innerHTML=days.map((d,i)=>`
        <div class="chart-bar-wrap">
            <div style="font-size:.75rem;color:var(--primary);font-weight:700;margin-bottom:4px">${vals[i]>0?'R$'+vals[i].toFixed(0):''}</div>
            <div class="chart-bar" style="height:${Math.round((vals[i]/mx)*160)+4}px"></div>
            <div class="chart-label">${d}</div>
        </div>
    `).join('');
}

function exportSalesCSV(){
    let csv='ID;Data;M√©todo;Itens;Subtotal;Desconto;Total\n';
    salesHistory.forEach(s=>{csv+=`"${s.id}";"${s.date}";"${s.method}";${s.itemsCount};${s.subtotal.toFixed(2)};${s.discount.toFixed(2)};${s.total.toFixed(2)}\n`;});
    dlCSV(csv,`vendas_${now()}.csv`);
    showToast('Vendas exportadas!','success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BARCODE / VOZ / QUICK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupBarcodeScanner(){
    const input=document.getElementById('barcodeInput');
    input.addEventListener('input',function(){
        const t=this.value.toLowerCase().trim();
        if(t.length>1) showSuggestions(t); else hideSuggestions();
    });
    input.addEventListener('keypress',function(e){
        if(e.key==='Enter'){
            const t=this.value.toLowerCase().trim();
            const f=products.find(p=>p.id==t||p.name.toLowerCase().includes(t));
            if(f){addToCart(f.id);this.value='';hideSuggestions();}
            else showToast('Produto n√£o encontrado','error');
        }
    });
}

function showSuggestions(term){
    const box=document.getElementById('suggestionsBox');
    const list=products.filter(p=>p.name.toLowerCase().includes(term)).slice(0,6);
    if(!list.length){box.style.display='none';return;}
    box.innerHTML=list.map(p=>`<div class="suggestion-item" onclick="selectSuggestion(${p.id})">
        <span style="font-size:1.8rem">${p.emoji}</span>
        <div><div style="font-weight:700">${p.name}</div><div style="font-size:.85rem;color:#636e72">R$ ${p.price.toFixed(2)} | Est: ${p.stock}</div></div>
    </div>`).join('');
    box.style.display='block';
}
function hideSuggestions(){document.getElementById('suggestionsBox').style.display='none';}
function selectSuggestion(id){addToCart(id);document.getElementById('barcodeInput').value='';hideSuggestions();}

function openVoiceSearch(){
    if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window)){showToast('Voz n√£o suportada neste navegador','warning');return;}
    const R=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
    R.lang='pt-BR'; R.start();
    showToast('Ouvindo... üé§','info');
    R.onresult=function(e){
        const t=e.results[0][0].transcript.toLowerCase();
        const f=products.find(p=>p.name.toLowerCase().includes(t));
        if(f){addToCart(f.id);showToast(`Adicionado por voz: ${f.name}`,'success');}
        else showToast('Produto n√£o encontrado por voz','warning');
    };
    R.onerror=function(){showToast('Erro no reconhecimento de voz','error');};
}

function openQuickProductModal(){document.getElementById('quickProductModal').style.display='flex';document.getElementById('quickProdName').focus();}
function closeQuickProductModal(){document.getElementById('quickProductModal').style.display='none';document.getElementById('quickProdName').value='';document.getElementById('quickProdPrice').value='';}

function addQuickProduct(){
    const name=document.getElementById('quickProdName').value.trim();
    const price=parseFloat(document.getElementById('quickProdPrice').value);
    if(!name||isNaN(price)||price<=0){showToast('Preencha nome e pre√ßo','error');return;}
    const newId=products.length?Math.max(...products.map(p=>typeof p.id==='number'?p.id:0))+1:1;
    const np={id:newId,name,price,stock:999,emoji:'‚ö°',category:'outro'};
    products.push(np);
    closeQuickProductModal();
    addToCart(newId);
    showToast(`"${name}" adicionado e no carrinho!`,'success');
}

function quickSale(){
    const popular=products.filter(p=>p.stock>0).slice(0,3);
    if(!popular.length){showToast('Sem produtos com estoque','warning');return;}
    cart=[];
    popular.forEach(p=>addToCart(p.id));
    setTimeout(openPaymentModal,400);
}

// ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ
function setupKeyboard(){
    document.addEventListener('keydown',function(e){
        if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
        if(e.key==='F1'){e.preventDefault();switchTab('pdv');}
        if(e.key==='F2'){e.preventDefault();switchTab('stock');}
        if(e.key==='F3'){e.preventDefault();switchTab('dashboard');}
        if(e.key==='F5'){e.preventDefault();if(cart.length)openPaymentModal();}
        if(e.key==='F8'){e.preventDefault();clearCart();}
        if(e.key==='Escape'){e.preventDefault();document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none');}
    });
}

// ‚îÄ‚îÄ DARK MODE ‚îÄ‚îÄ
function toggleDarkMode(){
    const isDark=document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode',isDark);
    document.querySelector('.dark-mode-toggle').innerHTML=isDark?'‚òÄÔ∏è':'üåô';
    if(isDark) applyDark(); else removeDark();
    showToast(`Modo ${isDark?'escuro':'claro'}`,'info');
}
function applyDark(){
    if(document.getElementById('dms'))return;
    const s=document.createElement('style');s.id='dms';
    s.textContent=`body{background:linear-gradient(135deg,#1a1a2e,#16213e)!important;color:#e0e0e0}
    .app-container{background:rgba(30,30,46,.9)!important}
    .content-area{background:linear-gradient(135deg,rgba(40,40,60,.9),rgba(30,30,50,.8))!important}
    .product-card,.cart-panel,.table-container,.card-metric,.chart-container,.modal-content{background:rgba(45,45,65,.97)!important;color:#e0e0e0}
    .scan-input,input,select{background:rgba(60,60,80,.9)!important;color:#e0e0e0!important;border-color:#6c5ce7!important}
    h2,h3{color:#a29bfe!important}
    table th{background:rgba(108,92,231,.2)!important;color:#a29bfe!important}
    tr:hover{background:rgba(108,92,231,.1)!important}
    .cart-item{background:rgba(60,60,80,.8)!important}
    .cart-item:hover{background:rgba(108,92,231,.2)!important}`;
    document.head.appendChild(s);
}
function removeDark(){document.getElementById('dms')?.remove();}

// ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ
function updateNotifications(){
    const cn=document.getElementById('cartNotification');
    const n=cart.reduce((a,i)=>a+i.qty,0);
    if(n>0){cn.textContent=n;cn.style.display='flex';}else{cn.style.display='none';}
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg,type='success',dur=3000){
    const t=document.getElementById('toast');
    t.className='toast '+type;
    t.querySelector('.toast-message').textContent=msg;
    const icons={success:'fa-check-circle',warning:'fa-exclamation-triangle',error:'fa-times-circle',info:'fa-info-circle'};
    t.querySelector('.toast-icon').className=`fas ${icons[type]||'fa-info-circle'} toast-icon`;
    t.classList.add('show');
    clearTimeout(t._to);
    t._to=setTimeout(()=>t.classList.remove('show'),dur);
}

function showLoader(){document.getElementById('loader').style.display='flex';}
function hideLoader(){document.getElementById('loader').style.display='none';}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function now(){return new Date().toISOString().slice(0,10);}
function dlCSV(csv,fn){
    const b=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const u=URL.createObjectURL(b);
    const a=document.createElement('a');a.href=u;a.download=fn;document.body.appendChild(a);a.click();document.body.removeChild(a);
}

function showTermsModal(){
    alert(`TERMOS DE USO ‚Äî ${APP_NAME}\n\n1. Per√≠odo de Teste: ${TRIAL_DAYS} dias gratuitos\n2. Assinatura: R$ ${PRICE.toFixed(2)}/m√™s ap√≥s trial\n3. Cancelamento: a qualquer momento\n4. Dados: armazenados ${useLocal?'localmente':'na nuvem (Supabase)'}\n\nEm caso de d√∫vidas, contate o suporte.`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function boot(){
    initSB();

    // Verificar dark mode salvo
    if(localStorage.getItem('darkMode')==='true'){
        document.body.classList.add('dark-mode');
        applyDark();
    }

    // Verificar sess√£o Supabase ativa
    if(!useLocal){
        sb.auth.getSession().then(({data:{session}})=>{
            if(session){
                sb.from('profiles').select('*').eq('id',session.user.id).single().then(({data:profile})=>{
                    currentUser={
                        id:session.user.id,
                        email:session.user.email,
                        companyName:profile?.company_name||'Empresa',
                        document:profile?.document||'',
                        phone:profile?.phone||'',
                        plan:profile?.plan||'professional',
                        isTrial:profile?.is_trial??true,
                        validUntil:profile?.valid_until||new Date(Date.now()+TRIAL_DAYS*86400000).toISOString(),
                        source:'supabase'
                    };
                    loadUserData().then(()=>{
                        document.getElementById('authContainer').style.display='none';
                        document.getElementById('appContainer').style.display='grid';
                        updateSubscriptionStatus();
                        initApp();
                        showToast(`Sess√£o restaurada, ${currentUser.companyName}! üëã`,'success');
                    });
                });
            }
        }).catch(()=>{});
    }

    // Mostrar badge de modo
    const modeInfo = useLocal?'üî∂ Modo Offline (localStorage)':'üü¢ Modo Nuvem (Supabase)';
    console.log(`${APP_NAME} v${APP_VER} ‚Äî ${modeInfo}`);

    // Enter nos inputs de login/registro
    document.getElementById('loginPassword').addEventListener('keypress',e=>{if(e.key==='Enter')loginUser();});
    document.getElementById('loginEmail').addEventListener('keypress',e=>{if(e.key==='Enter')loginUser();});
})();

// Expor globalmente
Object.assign(window,{
    loginUser,registerUser,showLogin,showRegister,showTermsModal,logout,openAccountModal,
    switchTab,addToCart,removeFromCart,updateCartItemQty,clearCart,
    openPaymentModal,closePaymentModal,processPayment,applyDiscount,applyDiscountToSale,
    openReceiptModal,closeReceiptModal,printReceiptFromModal,sendViaWhatsapp,sendViaEmail,
    addProduct,updateStock,deleteProduct,editProduct,saveEdit,filterStockTable,exportStockCSV,suggestEmoji,
    filterSalesHistory,exportSalesCSV,generateSalesChart,viewSale,
    openVoiceSearch,openQuickProductModal,closeQuickProductModal,addQuickProduct,quickSale,
    toggleDarkMode,selectSuggestion,hideSuggestions
});
</script>
</body>
</html>
